<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Farsi Fun ‚Äî Learn Persian Basics</title>
<style>
  :root{
    --bg:#0f172a;--card:#111827;--muted:#94a3b8;--text:#e5e7eb;--accent:#22c55e;--accent-2:#38bdf8;--warn:#f59e0b;--err:#ef4444;
    --grad1:#0b1229; --grad2:#121a36;
  }
  *{box-sizing:border-box}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans,Ubuntu,Cantarell,Helvetica Neue,Arial,"Apple Color Emoji","Segoe UI Emoji";
       margin:0;background:linear-gradient(135deg,var(--bg),#0b1028);color:var(--text)}
  header{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:16px clamp(16px,4vw,32px);
         position:sticky;top:0;background:rgba(15,23,42,.75);backdrop-filter:blur(10px);border-bottom:1px solid #1f2937;z-index:5}
  header h1{font-size:clamp(18px,2.5vw,28px);margin:0;letter-spacing:.5px;cursor:pointer}
  .stats{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .badge{background:#111827;border:1px solid #1f2937;padding:6px 10px;border-radius:999px;font-size:14px;color:var(--muted)}
  .icon-btn{display:inline-flex;align-items:center;justify-content:center;width:40px;height:40px;border-radius:10px;
            background:#111827;border:1px solid #1f2937;cursor:pointer}
  .icon-btn:hover{background:#0b1229;border-color:#263042}
  .btn,button,select{appearance:none;border:none;background:#111827;color:var(--text);border:1px solid #1f2937;padding:10px 14px;border-radius:12px;cursor:pointer}
  .btn:hover,button:hover,select:hover{background:#0b1229;border-color:#263042}
  .primary{background:linear-gradient(180deg,var(--accent),#16a34a);border-color:#14532d}
  .accent{background:linear-gradient(180deg,var(--accent-2),#0ea5e9);border-color:#075985}
  main{max-width:980px;margin:24px auto;padding:0 clamp(16px,4vw,32px) 120px}
  .card{background:linear-gradient(180deg,var(--grad1),var(--grad2));border:1px solid #1f2937;border-radius:16px;padding:clamp(16px,3vw,28px)}
  .row{display:grid;grid-template-columns:1fr;gap:16px}
  @media(min-width:860px){.row{grid-template-columns:1fr 1fr}}
  .media-wrap{display:grid;place-items:center}
  .pic,.mq-pic{width:min(420px,92%);height:min(280px,45vw);object-fit:contain;background:#0b1229;border:1px solid #1f2937;border-radius:16px;display:none}
  .emoji{font-size:clamp(64px,12vw,120px);text-align:center;line-height:1;filter:drop-shadow(0 10px 20px rgba(0,0,0,.35))}
  .word{display:flex;flex-direction:column;gap:6px;align-items:flex-start;justify-content:center}
  /* Learn-mode typography */
  .en{font-size:clamp(26px,3.4vw,34px);font-weight:700;color:#e2e8f0}
  .fa{font-size:clamp(18px,2.6vw,22px);color:#cbd5e1;direction:rtl;text-align:right}
  .trans{font-size:clamp(26px,3.4vw,34px);font-weight:600;color:#e2e8f0}
  .controls{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-top:10px}
  .input{background:#0b1229;border:1px solid #1f2937;padding:12px 14px;border-radius:12px;color:var(--text);width:100%;font-size:16px}
  .feedback{margin-top:8px;min-height:24px;font-size:15px}
  .ok{color:var(--accent)} .warn{color:var(--warn)} .err{color:var(--err)}
  .progress{margin-top:12px;height:10px;background:#0b1229;border-radius:999px;border:1px solid #1f2937;overflow:hidden}
  .bar{height:100%;width:0%;background:linear-gradient(90deg,#38bdf8,#22c55e);transition:width .4s ease}
  .mode{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px;align-items:center}
  .tiny{font-size:12px;color:#94a3b8}
  .tip{margin-top:12px;font-size:14px;color:#a5b4fc}
  .cele-msg{position:fixed;left:50%;bottom:72px;transform:translateX(-50%);background:rgba(17,24,39,.92);border:1px solid #1f2937;padding:14px 18px;border-radius:14px;font-weight:800;z-index:20}
  .fade-out{animation:fadeOut .9s ease forwards}@keyframes fadeOut{to{opacity:0}}
  /* Overlays / Modals */
  .overlay{position:fixed;inset:0;background:radial-gradient(1000px 600px at 50% -10%, rgba(56,189,248,.25), transparent 40%), rgba(15,23,42,.94);display:grid;place-items:center;z-index:10}
  .overlay-card,.modal-card{background:linear-gradient(180deg,#0b1229,#121a36);border:1px solid #1f2937;border-radius:18px;padding:24px;box-shadow:0 20px 60px rgba(0,0,0,.35);max-width:760px;margin:0 16px}
  .modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.45);z-index:12}
  .grid{display:grid;gap:10px}@media(min-width:760px){.grid{grid-template-columns:1fr 1fr}}
  .stat{background:#0b1229;border:1px solid #1f2937;border-radius:12px;padding:10px}
  .chip{display:inline-flex;gap:6px;background:#0b1229;border:1px solid #1f2937;border-radius:999px;padding:6px 10px;font-size:12px;color:#94a3b8;margin:2px 4px 0 0}
  /* Bazaar map */
  .map{display:grid;grid-template-columns:repeat(4, minmax(60px,1fr));gap:8px;margin-top:10px}
  .tile{aspect-ratio:1/1;background:#0b1229;border:1px dashed #334155;border-radius:10px;display:grid;place-items:center;font-size:28px;color:#334155}
  .tile.unlocked{border-style:solid;color:#e5e7eb}
  /* Mix & Match */
  .m2m{margin-top:16px;display:grid;grid-template-columns:1fr 1fr;gap:14px}
  .slot,.drag{background:#0b1229;border:1px solid #1f2937;border-radius:12px;padding:10px;min-height:52px;display:flex;align-items:center;justify-content:center}
  .drag{cursor:grab}
</style>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js" defer></script>

<!-- Firebase (v10 modular) -->
<script type="module">
/* ===================== FIREBASE BOOTSTRAP ===================== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, updateDoc, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

/* Replace this with YOUR config from Firebase console */
const firebaseConfig = {
  // TODO: paste your Firebase config here
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_PROJECT.appspot.com",
  appId: "YOUR_APP_ID"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);
enableIndexedDbPersistence(db).catch(()=>{});

/* Simple store that syncs a single user document */
const defaultDoc = {
  score:0, streak:0, srs:{}, covered:[], start_date:null, unlocked_count:0,
  achievements:{first10:false,perfectMini:false,streak7:false,mastered50:false},
  theme:'default', difficulty:'easy',
  mapUnlocked:0, mapDays:[], // record days with goal met
  settings:{reviewAll:false, sentenceMode:true},
};
let userRef=null, cache={...defaultDoc};

async function storeLoad(uid){
  userRef = doc(db,'users',uid);
  const snap = await getDoc(userRef);
  if(!snap.exists()){ await setDoc(userRef, defaultDoc); cache={...defaultDoc}; }
  else { cache = {...defaultDoc, ...snap.data()}; }
  reflectUIFromStore();
}
async function storeSave(partial){
  cache = {...cache, ...partial};
  if(userRef) await updateDoc(userRef, partial).catch(async ()=>{
    // If doc might not exist yet (race), set it
    await setDoc(userRef, cache, {merge:true});
  });
  reflectUIFromStore();
}

/* ===================== APP LOGIC (from earlier) ===================== */
const DAILY_WORDS = 5;
const SRS_INTERVALS_HOURS = [0,8,24,72,168,336];
const MINI_QUIZ_SIZE = 5;
const words = [
  {fa:"ÿ≥€åÿ®", en:"apple", translit:"sib", emoji:"üçé", audio:"audio/sib.mp3", image:"images/sib.png",
   sentence:{fa:"ŸÖŸÜ ÿ≥€åÿ® ŸÖ€å‚ÄåÿÆŸàÿ±ŸÖ.", translit:"man sib mikhoram.", en:"I eat an apple."}},
  {fa:"⁄©ÿ™ÿßÿ®", en:"book", translit:"ket√¢b", emoji:"üìñ", audio:"audio/ketab.mp3", image:"images/ketab.png",
   sentence:{fa:"ÿß€åŸÜ ⁄©ÿ™ÿßÿ® ÿÆŸàÿ® ÿßÿ≥ÿ™.", translit:"in ket√¢b khub ast.", en:"This book is good."}},
  {fa:"⁄Øÿ±ÿ®Ÿá", en:"cat", translit:"gorbe", emoji:"üê±", image:"images/gorbe.png",
   sentence:{fa:"ÿ¢ŸÜ ⁄Øÿ±ÿ®Ÿá ÿÆŸàÿßÿ® ÿßÿ≥ÿ™.", translit:"√¢n gorbe kh√¢b ast.", en:"That cat is sleeping."}},
  {fa:"ÿ≥⁄Ø", en:"dog", translit:"sag", emoji:"üê∂", image:"images/sag.png",
   sentence:{fa:"ÿ≥⁄Ø ŸÖŸÜ ÿ®ÿßÿ≤€å ŸÖ€å‚Äå⁄©ŸÜÿØ.", translit:"sag‚Äëe man b√¢zi mikonad.", en:"My dog is playing."}},
  {fa:"ÿ¢ÿ®", en:"water", translit:"√¢b", emoji:"üíß", audio:"audio/ab.mp3", image:"images/ab.png",
   sentence:{fa:"ÿ¢ÿ® ÿ≥ÿ±ÿØ ÿßÿ≥ÿ™.", translit:"√¢b sard ast.", en:"The water is cold."}},
  {fa:"ŸÜÿßŸÜ", en:"bread", translit:"n√¢n", emoji:"üçû", audio:"audio/nan.mp3", image:"images/nan.png",
   sentence:{fa:"ŸÖŸÜ ŸÜÿßŸÜ ÿØŸàÿ≥ÿ™ ÿØÿßÿ±ŸÖ.", translit:"man n√¢n dust d√¢ram.", en:"I like bread."}},
  {fa:"⁄Üÿß€å", en:"tea", translit:"ch√¢y", emoji:"üçµ", audio:"audio/chay.mp3", image:"images/chay.png",
   sentence:{fa:"⁄Üÿß€å ŸÖ€å‚ÄåŸÜŸàÿ¥ŸÖ.", translit:"ch√¢y minusham.", en:"I drink tea."}},
  {fa:"ŸÖÿßÿ¥€åŸÜ", en:"car", translit:"m√¢shin", emoji:"üöó", audio:"audio/mashin.mp3", image:"images/mashin.png",
   sentence:{fa:"ŸÖÿßÿ¥€åŸÜ ŸÇÿ±ŸÖÿ≤ ÿßÿ≥ÿ™.", translit:"m√¢shin gherme z ast.".replace(' ',' '), en:"The car is red."}},
  {fa:"ÿÆÿßŸÜŸá", en:"house", translit:"kh√¢ne", emoji:"üè†", audio:"audio/khane.mp3", image:"images/khane.png",
   sentence:{fa:"ÿÆÿßŸÜŸá ÿ®ÿ≤ÿ±⁄Ø ÿßÿ≥ÿ™.", translit:"kh√¢ne bozorg ast.", en:"The house is big."}},
  {fa:"ÿØÿ±", en:"door", translit:"dar", emoji:"üö™", image:"images/dar.png",
   sentence:{fa:"ÿØÿ± ÿ±ÿß ÿ®ÿ®ŸÜÿØ.", translit:"dar r√¢ beb band.", en:"Close the door."}},
];

const $=id=>document.getElementById(id);
const bySel=s=>document.querySelector(s);

let order=[], idx=0, mode='learn';
function normalizeTranslit(s){return (s||'').toLowerCase().normalize('NFKD').replace(/[\u0302\u0304]/g,'').replace(/\s+/g,'')}
function normalizeFa(s){return (s||'').replace(/\s+/g,'').replace(/Ÿä/g,'€å').replace(/ŸÉ/g,'⁄©').replace(/[\u200C\u200F\u202A-\u202E]/g,'')}
function todayISO(){const d=new Date();d.setHours(0,0,0,0);return d.toISOString().slice(0,10)}
function shuffle(a){ for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]} return a }
function ensureSRS(i){ if(!cache.srs[i]) cache.srs[i]={stage:0,due:0,seen:0,correct:0,wrong:0}; return cache.srs[i]; }
function isDue(i){ return ensureSRS(i).due <= Date.now(); }
function scheduleAfter(i,h){ ensureSRS(i).due = Date.now()+h*3600*1000; }
function getCoveredSet(){ return new Set(cache.covered||[]); }
function addCovered(i){ const s=getCoveredSet(); s.add(i); storeSave({covered:[...s]}); }
function unlockedCount(){ return cache.unlocked_count||Math.min(words.length, DAILY_WORDS); }
function unlockedIndices(){ return [...Array(unlockedCount()).keys()]; }
function masteredIndices(){ return [...getCoveredSet()].filter(i=>i<unlockedCount()); }
function dueIndices(){ return unlockedIndices().filter(i=>isDue(i)); }
function quizPool(){ const due=dueIndices(); if(due.length) return due; const m=masteredIndices(); return m.length?m:unlockedIndices(); }
function learnPool(){ const u=unlockedIndices(), due=u.filter(i=>isDue(i)), rest=u.filter(i=>!isDue(i)); return [...due,...rest]; }

function ensureOrder(){ const pool = (mode==='quiz')? quizPool(): learnPool(); order=pool.slice(); shuffle(order); idx=0; }

function showItem(){
  const pool = (mode==='quiz')? quizPool(): learnPool();
  if(order.length===0 || order.some(i=>!pool.includes(i))) ensureOrder();
  const gi = order[idx % order.length]; const item = words[gi];

  // image/emoji
  const pic=$('pic'), emo=$('emoji');
  if(item.image){ pic.style.display='block'; emo.style.display='none'; pic.src=item.image; pic.alt=item.en; }
  else { pic.style.display='none'; emo.style.display='block'; emo.textContent=item.emoji||'‚ùì'; }

  // text
  if(mode==='quiz'){ $('en').textContent=item.en; $('fa').textContent='‚Ä¢‚Ä¢‚Ä¢'; $('trans').textContent='‚Äî'; }
  else { $('en').textContent=item.en; $('fa').textContent=item.fa; $('trans').textContent=item.translit; }

  // sentence context (toggle in settings)
  const sbox=$('sentBox'), sfa=$('s_fa'), str=$('s_tr'), sen=$('s_en');
  if(cache.settings?.sentenceMode && item.sentence && mode==='learn'){
    sbox.style.display='block'; sfa.textContent=item.sentence.fa; str.textContent=item.sentence.translit; sen.textContent=item.sentence.en;
  } else { sbox.style.display='none'; }

  // progress & badges
  $('scoreBadge').textContent = `Score: ${cache.score||0}`;
  $('streakBadge').textContent = `Streak: ${cache.streak||0} üî•`;
  $('unlockedBadge').textContent = `${unlockedCount()}/${words.length} unlocked`;
  const pct = Math.round((getCoveredSet().size/Math.max(1,unlockedCount()))*100);
  $('progressBar').style.width = pct+'%';

  // controls: hide listen in quiz
  $('listenBtn').style.display = (mode==='quiz')?'none':'inline-flex';
  $('revealBtn').style.display = (mode==='quiz')?'inline-flex':'none';

  // focus typing input
  $('typeInput').value=''; $('typeInput').focus();
}
function next(){ idx=(idx+1)%Math.max(1,order.length); showItem(); }

/* ======= Celebrations ======= */
function happyDing(){
  try{const AC=window.AudioContext||window.webkitAudioContext;if(!AC) return;const ctx=new AC();const tones=[659,784,988];const t0=ctx.currentTime;
    tones.forEach((f,i)=>{const o=ctx.createOscillator(),g=ctx.createGain();o.type='sine';o.frequency.value=f;o.connect(g);g.connect(ctx.destination);
      const st=t0+i*0.05;g.gain.setValueAtTime(0,st);g.gain.linearRampToValueAtTime(0.35,st+0.03);g.gain.exponentialRampToValueAtTime(0.0001,st+0.22);
      o.start(st);o.stop(st+0.25);});}catch{}}
function confettiPop(){ if(window.confetti) confetti({origin:{y:1,x:0.5},gravity:1.2,ticks:180,scalar:0.9,particleCount:70,spread:75,startVelocity:55}); }
function fireworks(){ if(!window.confetti) return;
  const base={origin:{y:1,x:0.5},gravity:1.0,ticks:260,scalar:1.0};
  confetti({...base,particleCount:180,spread:120,startVelocity:65});
  confetti({...base,particleCount:140,spread:140,startVelocity:60,origin:{y:1,x:0.2}});
  confetti({...base,particleCount:140,spread:140,startVelocity:60,origin:{y:1,x:0.8}});
}
function celebrateSimple(){ happyDing(); confettiPop(); const c=$('celebration'); c.textContent="let's goooooo üéâ"; c.style.display='block'; setTimeout(()=>c.classList.add('fade-out'),800); setTimeout(()=>{c.classList.remove('fade-out'); c.style.display='none';},1600); }
function celebrateStreak7(){
  fireworks();
  cache.achievements.streak7 = true;
  storeSave({achievements:cache.achievements});
  const c=$('celebration'); c.textContent="7‚Äëday streak! üèÖ"; c.style.display='block';
  setTimeout(()=>c.classList.add('fade-out'),1200);
  setTimeout(()=>{c.classList.remove('fade-out'); c.style.display='none';},2200);
}

/* ======= Audio (your voice or TTS fallback) ======= */
const audioCache=new Map();
function getAudio(item){ const url=item.audio||`audio/${(item.translit||'').toLowerCase()}.mp3`; if(!audioCache.has(url)){const a=new Audio();a.preload='auto';a.src=url;audioCache.set(url,a);} return audioCache.get(url);}
async function playYourAudio(){ const gi=order[idx], item=words[gi]; try{ const a=getAudio(item); a.currentTime=0; await a.play(); }catch{ /* optional: TTS fallback omitted for brevity */ } }

/* ======= Answer handling (SRS + score + streak + map goal) ======= */
function handleAnswer(correct, gi, source='typing', transcript=''){
  const r=ensureSRS(gi); r.seen++;
  if(correct){
    r.correct++; r.stage=Math.min(r.stage+1, SRS_INTERVALS_HOURS.length-1);
    scheduleAfter(gi,SRS_INTERVALS_HOURS[r.stage]||24);
    const newScore=(cache.score||0)+10, newStreak=(cache.streak||0)+1;
    addCovered(gi);
    storeSave({score:newScore, streak:newStreak, srs:cache.srs});
    celebrateSimple();
    // Massive fireworks at 7-day streak:
    if(newStreak===7) celebrateStreak7();
    checkDailyGoalAndMap();
  }else{
    r.wrong++; r.stage=Math.max(0,r.stage-1); scheduleAfter(gi,2);
    storeSave({streak:0, srs:cache.srs});
    $('typeFeedback').textContent = (source==='speech'?'Try again!':'Not quite.'); $('typeFeedback').className='feedback warn';
  }
  setTimeout(next, 450);
}

/* Daily unlocks + map: mark goal (DAILY_WORDS correct in a day) to unlock one bazaar tile */
function checkDailyGoalAndMap(){
  const today=todayISO();
  let days = cache.mapDays||[];
  let todayRec = days.find(d=>d.date===today);
  if(!todayRec){ todayRec={date:today, correct:0, goalMet:false}; days=[...days,todayRec]; }
  todayRec.correct++;
  if(!todayRec.goalMet && todayRec.correct>=DAILY_WORDS){
    todayRec.goalMet=true;
    const newTiles = Math.min((cache.mapUnlocked||0)+1, 12);
    storeSave({mapDays:days, mapUnlocked:newTiles});
    // cute cat burst per tile
    confetti({origin:{y:1,x:Math.random()},particleCount:60,spread:70,startVelocity:45,scalar:1.1});
  }else{
    storeSave({mapDays:days});
  }
}

/* ======= UI wiring ======= */
function reflectUIFromStore(){
  // theme & difficulty
  bySel('#themeSelect').value = cache.theme||'default';
  bySel('#difficulty').value  = cache.difficulty||'easy';
  // badges
  bySel('#scoreBadge').textContent = `Score: ${cache.score||0}`;
  bySel('#streakBadge').textContent = `Streak: ${cache.streak||0} üî•`;
  bySel('#unlockedBadge').textContent = `${unlockedCount()}/${words.length} unlocked`;
  // map tiles
  renderMap();
}

function renderMap(){
  const wrap = $('mapGrid'); if(!wrap) return;
  wrap.innerHTML='';
  const tiles = 12;
  for(let i=0;i<tiles;i++){
    const t=document.createElement('div');
    t.className='tile'+(i<(cache.mapUnlocked||0)?' unlocked':'');
    t.textContent = i<(cache.mapUnlocked||0)?'üêà':'?';
    wrap.appendChild(t);
  }
}

/* ======= DOM refs & events ======= */
const listenBtn=$('listenBtn'), sayBtn=$('sayBtn'), hintBtn=$('hintBtn'), revealBtn=$('revealBtn'), nextBtn=$('nextBtn');
const typeInput=$('typeInput'), checkBtn=$('checkBtn'), skipBtn=$('skipBtn');
listenBtn.addEventListener('click', playYourAudio);
checkBtn.addEventListener('click', ()=>{
  const gi=order[idx], item=words[gi];
  const guess=normalizeTranslit(typeInput.value);
  if(!guess){ $('typeFeedback').textContent='Type your guess first!'; $('typeFeedback').className='feedback warn'; return; }
  $('typeFeedback').textContent=''; typeInput.value=''; typeInput.focus();
  handleAnswer(guess===normalizeTranslit(item.translit), gi, 'typing');
});
skipBtn.addEventListener('click', ()=>{ typeInput.value=''; storeSave({streak:0}); next(); });
nextBtn.addEventListener('click', ()=>{ typeInput.value=''; next(); });
$('learnBtn').addEventListener('click', ()=>{ mode='learn'; ensureOrder(); showItem(); });
$('quizBtn').addEventListener('click',  ()=>{ mode='quiz'; ensureOrder(); showItem(); });
$('hintBtn').addEventListener('click', ()=>{
  if(mode!=='learn') return;
  const gi=order[idx], item=words[gi];
  bySel('#trans').textContent=item.translit; bySel('#en').textContent=item.en;
});
$('revealBtn').addEventListener('click', ()=>{
  const gi=order[idx], item=words[gi];
  bySel('#fa').textContent=item.fa; bySel('#trans').textContent=item.translit;
  const s=$('sadFace'); s.style.display='block'; setTimeout(()=>s.classList.add('fade-out'),700); setTimeout(()=>{s.classList.remove('fade-out'); s.style.display='none';},1500);
});
$('themeSelect').addEventListener('change', e=> storeSave({theme:e.target.value}));
$('difficulty').addEventListener('change', e=> storeSave({difficulty:e.target.value}));

/* ======= Mini-quiz (image + transliteration) in Settings ======= */
$('startMiniQuiz').addEventListener('click', ()=>{ bySel('#settingsModal').style.display='none'; startMini(); });
let miniQ={queue:[],current:null,correct:0,total:0};
function startMini(){
  const pool=[...new Set([...quizPool(), ...masteredIndices(), ...unlockedIndices()])];
  shuffle(pool); miniQ={queue:pool.slice(0,MINI_QUIZ_SIZE),current:null,correct:0,total:0};
  const panel=$('miniQuizPanel'); panel.style.display='block';
  // hide main controls
  document.querySelectorAll('.controls, label[for="typeInput"], #typeInput, #typeFeedback, #speechFeedback, .progress, #factBox, #tip, #sentenceBox').forEach(el=> el.style.display='none');
  nextMiniQ();
}
function nextMiniQ(){
  if(!miniQ.queue.length){
    $('mqFeedback').innerHTML=`Mini Quiz complete! Score: <b>${miniQ.correct}</b> / ${miniQ.total}`;
    $('mqBar').style.width='100%';
    setTimeout(()=>{ $('miniQuizPanel').style.display='none'; document.querySelectorAll('.controls, label[for="typeInput"], #typeInput, #typeFeedback, #speechFeedback, .progress, #factBox, #tip, #sentenceBox').forEach(el=> el.style.display=''); showItem(); }, 1500);
    return;
  }
  miniQ.current = miniQ.queue.shift();
  const item=words[miniQ.current];
  $('mqPic').style.display='block'; $('mqPic').src=item.image||''; $('mqPic').alt=item.en||'';
  $('mqInput').value=''; $('mqFeedback').textContent='';
  $('mqBar').style.width = `${(miniQ.total/MINI_QUIZ_SIZE)*100}%`;
  $('mqInput').focus();
}
$('mqCheck').addEventListener('click', ()=>{
  const item=words[miniQ.current]; miniQ.total++;
  const ok = normalizeTranslit($('mqInput').value)===normalizeTranslit(item.translit);
  if(ok){ miniQ.correct++; $('mqFeedback').textContent='Nice!'; $('mqFeedback').className='feedback ok'; celebrateSimple(); }
  else { $('mqFeedback').textContent=`Answer: ${item.translit}`; $('mqFeedback').className='feedback warn'; storeSave({streak:0}); }
  setTimeout(nextMiniQ, 350);
});

/* ======= Badges modal ======= */
$('openAchievements').addEventListener('click', ()=>{ renderBadges(); $('achModal').style.display='grid'; });
$('closeAch').addEventListener('click', ()=> $('achModal').style.display='none');
function renderBadges(){
  const a=cache.achievements||defaultDoc.achievements;
  $('achList').innerHTML = `
    <div class="chip">${a.first10?'üèÖ':'‚¨ú'} First 10 mastered</div>
    <div class="chip">${a.perfectMini?'üèÖ':'‚¨ú'} Perfect Mini Quiz</div>
    <div class="chip">${a.streak7?'üèÖ':'‚¨ú'} 7‚Äëday streak</div>
    <div class="chip">${a.mastered50?'üèÖ':'‚¨ú'} 50 mastered</div>
  `;
}

/* ======= Bazaar Map modal ======= */
$('openMap').addEventListener('click', ()=>{ renderMap(); $('mapModal').style.display='grid'; });
$('closeMap').addEventListener('click', ()=> $('mapModal').style.display='none');

/* ======= Midnight countdown ======= */
$('midnightBtn').addEventListener('click', ()=>{
  const n=new Date(), t=new Date(n); t.setHours(24,0,0,0);
  const ms=t-n; const s=Math.floor(ms/1000), h=Math.floor(s/3600), m=Math.floor((s%3600)/60), sec=s%60;
  alert(`New words unlock at local midnight.\nTime remaining: ${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}`);
});

/* ======= Auth UI ======= */
const authOverlay = $('authOverlay');
$('loginBtn').addEventListener('click', async ()=>{
  const email=$('email').value.trim(), pass=$('pass').value;
  if(!email||!pass) return alert('Enter email & password.');
  try{ await signInWithEmailAndPassword(auth,email,pass); }catch(e){ alert(e.message); }
});
$('signupBtn').addEventListener('click', async ()=>{
  const email=$('email').value.trim(), pass=$('pass').value;
  if(!email||!pass) return alert('Enter email & password.');
  try{ await createUserWithEmailAndPassword(auth,email,pass); }catch(e){ alert(e.message); }
});
$('logoutBtn').addEventListener('click', async ()=>{ await signOut(auth); });

onAuthStateChanged(auth, async (user)=>{
  if(!user){ authOverlay.style.display='grid'; return; }
  authOverlay.style.display='none';
  await storeLoad(user.uid);
  ensureOrder(); showItem();
});

/* ======= Sentence toggle, Review mode ======= */
$('sentenceToggle').addEventListener('click', ()=>{
  const v = !(cache.settings?.sentenceMode); storeSave({settings:{...cache.settings, sentenceMode:v}});
  $('sentenceToggle').textContent = `Sentence Mode: ${v?'ON':'OFF'}`;
});
$('openSettings').addEventListener('click', ()=>{ 
  $('settingsModal').style.display='grid'; 
  $('sentenceToggle').textContent=`Sentence Mode: ${(cache.settings?.sentenceMode)!==false?'ON':'OFF'}`;
  $('reviewToggle').textContent=`Review All Mastered: ${cache.settings?.reviewAll?'ON':'OFF'}`;
});
$('closeSettings').addEventListener('click', ()=> $('settingsModal').style.display='none');
$('settingsModal').addEventListener('click', e=>{ if(e.target.id==='settingsModal') e.currentTarget.style.display='none'; });
$('reviewToggle').addEventListener('click', ()=>{
  const v=!(cache.settings?.reviewAll); storeSave({settings:{...cache.settings, reviewAll:v}});
  $('reviewToggle').textContent=`Review All Mastered: ${v?'ON':'OFF'}`;
});

</script>
</head>
<body>
<header>
  <h1>‚ú® Farsi Fun ‚Äî Learn Persian Basics</h1>
  <div class="stats">
    <div class="badge" id="scoreBadge">Score: 0</div>
    <div class="badge" id="streakBadge">Streak: 0 üî•</div>
    <div class="badge" id="unlockedBadge">0/0 unlocked</div>
    <select id="themeSelect" class="select" title="Theme">
      <option value="default">Theme: Ocean</option>
    </select>
    <button id="openMap" class="icon-btn" title="Bazaar Map">üó∫Ô∏è</button>
    <button id="openAchievements" class="icon-btn" title="Badges">üèÜ</button>
    <button id="openSettings" class="icon-btn" title="Settings">‚öôÔ∏è</button>
    <button id="logoutBtn" class="icon-btn" title="Log out">üö™</button>
  </div>
</header>

<!-- Auth overlay -->
<div id="authOverlay" class="overlay" style="display:grid">
  <div class="overlay-card">
    <h2>Sign in</h2>
    <p class="tiny">Use Email/Password. You can make one for you and one for Nicole ‚Äî progress is separate.</p>
    <div style="display:flex; gap:10px; flex-wrap:wrap">
      <input id="email" class="input" style="min-width:260px" placeholder="email@example.com"/>
      <input id="pass" type="password" class="input" style="min-width:220px" placeholder="password"/>
      <button id="loginBtn" class="primary">Log in</button>
      <button id="signupBtn" class="accent">Sign up</button>
    </div>
  </div>
</div>

<!-- Start screen -->
<div id="startOverlay" class="overlay" style="display:none">
  <div class="overlay-card">
    <h2>How do you want to learn today?</h2>
    <p>Pick a mode to get started. You can switch later.</p>
    <div class="btns" style="display:flex; gap:12px; flex-wrap:wrap">
      <button id="learnBtn" class="primary">üìö Learn Mode</button>
      <button id="quizBtn" class="accent">üéØ Quiz Mode</button>
    </div>
    <p class="tiny" style="margin-top:10px">Tip: Use <b>Chrome</b>. <b>Listen</b> plays your MP3s. New words unlock at <button id="midnightBtn" class="btn" style="padding:2px 6px">midnight</button>.</p>
  </div>
</div>

<main>
  <div class="mode">
    <button id="learnBtn" class="btn">Learn Mode</button>
    <button id="quizBtn" class="btn">Quiz Mode</button>
    <label class="tiny" style="display:inline-flex;align-items:center;gap:6px;">
      Difficulty:
      <select id="difficulty" class="select">
        <option value="easy">Easy</option>
        <option value="medium">Medium</option>
        <option value="hard">Hard</option>
      </select>
    </label>
    <span class="tiny">New words unlock at <button id="midnightBtn" class="btn" style="padding:2px 6px">midnight</button> ‚è∞</span>
  </div>

  <div class="card">
    <div class="row">
      <div class="media-wrap">
        <img id="pic" class="pic" alt="" />
        <div class="emoji" id="emoji">üçé</div>
      </div>
      <div class="word" id="wordWrap">
        <div class="en" id="en">apple</div>
        <div class="fa" id="fa" dir="rtl">ÿ≥€åÿ®</div>
        <div class="trans" id="trans">sib</div>

        <div class="controls">
          <button id="listenBtn" class="accent">üîä Listen</button>
          <button id="sayBtn" class="btn" disabled title="(optional speech recog)">üéôÔ∏è Say it</button>
          <button id="hintBtn" class="btn">üí° Hint</button>
          <button id="revealBtn" class="btn">üëÄ Reveal</button>
          <button id="nextBtn" class="primary">‚û°Ô∏è Next</button>
        </div>

        <div class="feedback" id="speechFeedback"></div>

        <label class="tiny" for="typeInput">Type the pronunciation (English letters):</label>
        <input class="input" id="typeInput" placeholder="e.g., sib"/>
        <div class="controls">
          <button id="checkBtn" class="primary">‚úÖ Check</button>
          <button id="skipBtn" class="btn">‚è≠Ô∏è Skip</button>
        </div>
        <div class="feedback" id="typeFeedback"></div>

        <div class="progress"><div class="bar" id="progressBar"></div></div>

        <!-- Sentence Context Mode -->
        <div id="sentenceBox" class="card" style="margin-top:10px;padding:12px">
          <div id="sentBox" style="display:none">
            <div class="fa" id="s_fa" dir="rtl" style="font-size:20px"></div>
            <div class="trans" id="s_tr" style="font-size:18px"></div>
            <div class="en" id="s_en" style="font-size:18px"></div>
          </div>
          <button id="sentenceToggle" class="btn" style="margin-top:6px">Sentence Mode: ON</button>
        </div>

        <!-- Mini Quiz (image + translit only), launched from Settings -->
        <div id="miniQuizPanel" class="card" style="display:none; margin-top:14px">
          <div class="qprogress"><div id="mqBar" class="bar" style="height:8px;width:0%"></div></div>
          <img id="mqPic" class="mq-pic" alt="" />
          <input id="mqInput" class="input" placeholder="Type the transliteration‚Ä¶"/>
          <div class="controls"><button id="mqCheck" class="primary">Check</button></div>
          <div id="mqFeedback" class="feedback"></div>
        </div>
      </div>
    </div>
  </div>
</main>

<footer style="padding:16px;text-align:center;color:#94a3b8">
  Put images in <b>/images</b> (e.g., <code>images/sib.png</code>). Put audio in <b>/audio</b> (e.g., <code>audio/sib.mp3</code>).
</footer>

<div id="celebration" class="cele-msg" style="display:none">let's goooooo üéâ</div>
<div id="sadFace" class="cele-msg" style="display:none">üò¢</div>

<!-- Achievements Modal -->
<div id="achModal" class="modal">
  <div class="modal-card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
      <h3 style="margin:0">üèÜ Badges</h3>
      <button id="closeAch" class="btn">Close</button>
    </div>
    <div id="achList" class="grid"></div>
  </div>
</div>

<!-- Bazaar Map Modal -->
<div id="mapModal" class="modal">
  <div class="modal-card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
      <h3 style="margin:0">üó∫Ô∏è Persian Bazaar Progress</h3>
      <button id="closeMap" class="btn">Close</button>
    </div>
    <p class="tiny">Meet your daily goal (learn/check <b>at least 5 words</b>) to unlock a new bazaar tile. Lots of cats live here üêà.</p>
    <div id="mapGrid" class="map"></div>
  </div>
</div>

<!-- Settings Modal -->
<div id="settingsModal" class="modal">
  <div class="modal-card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
      <h3 style="margin:0">‚öôÔ∏è Settings</h3>
      <button id="closeSettings" class="btn">Close</button>
    </div>
    <div class="grid">
      <div class="stat">
        <b>Mini Quiz</b><p class="tiny">Practice 5 items (image ‚Üí type the transliteration).</p>
        <button id="startMiniQuiz" class="btn">‚ö° Start Mini Quiz</button>
      </div>
      <div class="stat">
        <b>Review Mode</b><p class="tiny">Quiz only on words she has mastered (ignores SRS order).</p>
        <button id="reviewToggle" class="btn">üîÅ Review All Mastered: OFF</button>
      </div>
      <div class="stat">
        <b>Sentence Context</b><p class="tiny">Show simple example sentences after you learn a word.</p>
        <button id="sentenceToggle2" class="btn" style="display:none"></button>
      </div>
    </div>
  </div>
</div>
</body>
</html>
