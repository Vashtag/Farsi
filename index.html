<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Farsi Fun â€” Learn Persian Basics</title>
<style>
:root{
  --bg:#0f172a;--card:#111827;--muted:#94a3b8;--text:#e5e7eb;--accent:#22c55e;--accent-2:#38bdf8;--warn:#f59e0b;--err:#ef4444;
  --grad1:#0b1229; --grad2:#121a36;
}
*{box-sizing:border-box}
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans,Ubuntu,Cantarell,Helvetica Neue,Arial,"Apple Color Emoji","Segoe UI Emoji";
  margin:0;background:linear-gradient(135deg,var(--bg),#0b1028);color:var(--text)}
header{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:16px clamp(16px,4vw,32px);
  position:sticky;top:0;background:rgba(15,23,42,.75);backdrop-filter:blur(10px);border-bottom:1px solid #1f2937;z-index:5}
header h1{font-size:clamp(18px,2.5vw,28px);margin:0;letter-spacing:.5px;cursor:pointer}
.stats{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.badge{background:#111827;border:1px solid #1f2937;padding:6px 10px;border-radius:999px;font-size:14px;color:var(--muted)}
.icon-btn{display:inline-flex;align-items:center;justify-content:center;width:40px;height:40px;border-radius:10px;
  background:#111827;border:1px solid #1f2937;cursor:pointer}
.icon-btn:hover{background:#0b1229;border-color:#263042}
.btn,button,select{appearance:none;border:none;background:#111827;color:#e5e7eb;border:1px solid #1f2937;padding:10px 14px;border-radius:12px;cursor:pointer}
.btn:hover,button:hover,select:hover{background:#0b1229;border-color:#263042}
.primary{background:linear-gradient(180deg,var(--accent),#16a34a);border-color:#14532d}
.accent{background:linear-gradient(180deg,var(--accent-2),#0ea5e9);border-color:#075985}
main{max-width:980px;margin:24px auto;padding:0 clamp(16px,4vw,32px) 120px}
.card{background:linear-gradient(180deg,var(--grad1),var(--grad2));border:1px solid #1f2937;border-radius:16px;padding:clamp(16px,3vw,28px)}
.row{display:grid;grid-template-columns:1fr;gap:16px}
@media(min-width:860px){.row{grid-template-columns:1fr 1fr}}
.media-wrap{display:grid;place-items:center}
.pic,.mq-pic{width:min(420px,92%);height:min(280px,45vw);object-fit:contain;background:#0b1229;border:1px solid #1f2937;border-radius:16px;display:none}
.emoji{font-size:clamp(64px,12vw,120px);text-align:center;line-height:1;filter:drop-shadow(0 10px 20px rgba(0,0,0,.35))}
.word{display:flex;flex-direction:column;gap:6px;align-items:flex-start;justify-content:center}
.en{font-size:clamp(26px,3.4vw,34px);font-weight:700;color:#e2e8f0}
.fa{font-size:clamp(18px,2.6vw,22px);color:#cbd5e1;direction:rtl;text-align:right}
.trans{font-size:clamp(26px,3.4vw,34px);font-weight:600;color:#e2e8f0}
.controls{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-top:10px}
.input{background:#0b1229;border:1px solid #1f2937;padding:12px 14px;border-radius:12px;color:#e5e7eb;width:100%;font-size:16px}
.feedback{margin-top:8px;min-height:24px;font-size:15px}
.ok{color:var(--accent)}
.warn{color:var(--warn)}
.err{color:var(--err)}
.progress{margin-top:12px;height:10px;background:#0b1229;border-radius:999px;border:1px solid #1f2937;overflow:hidden}
.bar{height:100%;width:0%;background:linear-gradient(90deg,#38bdf8,#22c55e);transition:width .3s ease}

/* ===== mode row: left & right areas so Dictionary sits right ===== */
.mode{
  display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:space-between;margin-bottom:10px
}
.mode-left{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.mode-right{margin-left:auto}

.tiny{font-size:12px;color:#94a3b8}
.cele-msg{position:fixed;left:50%;bottom:72px;transform:translateX(-50%);background:rgba(17,24,39,.92);border:1px solid #1f2937;padding:14px 18px;border-radius:14px;font-weight:800;z-index:20}
.fade-out{animation:fadeOut .9s ease forwards}
@keyframes fadeOut { to { opacity:0 } }
.overlay{position:fixed;inset:0;background:radial-gradient(1000px 600px at 50% -10%, rgba(56,189,248,.25), transparent 40%), rgba(15,23,42,.94);display:grid;place-items:center;z-index:10}
.overlay-card,.modal-card{background:linear-gradient(180deg,#0b1229,#121a36);border:1px solid #1f2937;border-radius:18px;padding:24px;box-shadow:0 20px 60px rgba(0,0,0,.35);max-width:760px;margin:0 16px}
.modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.45);z-index:12}
#miniQuizModal,#sentencesModal,#audioQuizModal{backdrop-filter:blur(12px) saturate(120%);-webkit-backdrop-filter:blur(12px) saturate(120%)}
.grid{display:grid;gap:10px}
@media(min-width:760px){.grid{grid-template-columns:1fr 1fr}}
.stat{background:#0b1229;border:1px solid #1f2937;border-radius:12px;padding:10px}
.chip{display:inline-flex;gap:6px;background:#0b1229;border:1px solid #1f2937;border-radius:999px;padding:6px 10px;font-size:12px;color:#94a3b8;margin:2px 4px 0 0}

/* Bazaar */
.map-wrap{position:relative;margin-top:10px}
.map{display:grid;grid-template-columns:repeat(4, minmax(60px,1fr));gap:8px;position:relative;z-index:1}
.tile{aspect-ratio:1/1;background:#0b1229;border:1px dashed #334155;border-radius:10px;display:grid;place-items:center;font-size:28px;color:#334155}

/* Furniture */
.furniture{
  position:absolute; top:8px; left:8px;
  width:92px; height:auto; z-index:1; pointer-events:none;
  filter: drop-shadow(0 8px 18px rgba(0,0,0,.35));
}

/* roaming cats overlay */
.cat-layer{position:absolute;inset:0;pointer-events:none;z-index:2;overflow:hidden}
.cat{position:absolute;font-size:32px;filter:drop-shadow(0 6px 10px rgba(0,0,0,.35));will-change:transform,left,top}
.cat.flip{transform:scaleX(-1)}
@media(min-width:760px){ .cat{font-size:40px} }
.cat .cat-emoji{display:inline-block}
.cat-name{
  position:absolute; left:50%; top:-18px; transform:translateX(-50%);
  font-size:12px; padding:2px 6px; border-radius:8px;
  background:rgba(17,24,39,.88); border:1px solid #1f2937; color:#e5e7eb;
  white-space:nowrap; pointer-events:none; display:none;
  filter: drop-shadow(0 4px 8px rgba(0,0,0,.35));
}

/* Catnip roll + bounce */
.cat.catnip .cat-emoji{animation:catnipRoll .7s linear infinite}
@keyframes catnipRoll{
  0%{transform:translateY(0) rotate(0deg)}
  50%{transform:translateY(-8px) rotate(180deg)}
  100%{transform:translateY(0) rotate(360deg)}
}

/* Arena when cats are unlocked (grid hidden) */
.map-wrap.arena{
  background:#0b1229;border:1px solid #1f2937;border-radius:12px;
  height:clamp(260px, 45vh, 380px);
}

/* Rewards / shop row */
.shop-row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.muted{color:#94a3b8}

/* Hearts when feeding */
.heart{position:absolute;font-size:20px;pointer-events:none;opacity:0;animation:floatHeart 1.6s ease-out forwards}
@keyframes floatHeart{
  0%{transform:translateY(0) scale(.8);opacity:.9}
  60%{opacity:1}
  100%{transform:translateY(-60px) scale(1.25);opacity:0}
}

/* Leaves burst when using catnip */
.leaf{position:absolute;font-size:20px;pointer-events:none;opacity:0;animation:floatLeaf 2.2s ease-out forwards}
@keyframes floatLeaf{
  0%{transform:translateY(0) rotate(0deg);opacity:.9}
  100%{transform:translateY(-90px) rotate(180deg);opacity:0}
}

/* Heavy blur for profile/start overlays */
#profileOverlay,#startOverlay{
  background: radial-gradient(1000px 600px at 50% -10%, rgba(56,189,248,.25), transparent 40%), rgba(15,23,42,.60);
  backdrop-filter: blur(28px) saturate(120%);
  -webkit-backdrop-filter: blur(28px) saturate(120%);
}

/* ----- Mobile-only header/input behavior ----- */
@media (max-width: 700px){
  header{ position: static; top:auto; background:rgba(15,23,42,.9); backdrop-filter:none; }
  main{ padding:0 16px 120px; }
}

/* ========= Badge visuals ========= */
.badges-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.badge-tile{
  position:relative; padding:10px 12px; border-radius:12px; font-size:14px;
  background:#0b1229; border:1px solid #1f2937; color:#9aa7b7; display:flex; align-items:center; gap:8px;
  filter:grayscale(1) brightness(.7); opacity:.65; transition:filter .25s ease, opacity .25s ease, box-shadow .25s ease;
}
.badge-tile .ico{width:22px; height:22px; display:grid; place-items:center}
.badge-tile .label{flex:1}
.badge-tile.earned{
  filter:none; opacity:1; color:#e5e7eb; box-shadow:0 0 0 0 rgba(56,189,248,.0);
  animation:badgeGlow 2.2s ease-in-out 1 forwards;
}
@keyframes badgeGlow{
  0% { box-shadow:0 0 0px 0 rgba(56,189,248,.0); }
  35% { box-shadow:0 0 18px 6px rgba(56,189,248,.35); }
  100% { box-shadow:0 0 8px 2px rgba(34,197,94,.25); }
}
.badge-tile.sparkle::after{
  content:"âœ¨"; position:absolute; right:8px; top:-6px; font-size:18px; animation:sparklePop .9s ease-out 1 forwards;
}
@keyframes sparklePop{
  0%{ transform:translateY(6px) scale(.6); opacity:0; }
  40%{ transform:translateY(0) scale(1.2); opacity:1; }
  100%{ transform:translateY(0) scale(1); opacity:0; }
}

/* ====== Night Sky Twinkles (22:00â€“02:00) ====== */
.night-sky{ position:fixed; inset:0; pointer-events:none; z-index:-1; }
.night-star{
  position:absolute;
  width:2px; height:2px; border-radius:50%;
  background: radial-gradient(circle, rgba(255,255,255,.95), rgba(255,255,255,0) 60%);
  opacity:0;
  animation: starTwinkle var(--dur,2.2s) ease-in-out var(--delay,0s) infinite alternate;
  filter: drop-shadow(0 0 6px rgba(255,255,255,.28));
  will-change: opacity, transform;
}
.night-star.spark{
  animation: starTwinkle var(--dur,2.2s) ease-in-out var(--delay,0s) infinite alternate,
             starSpark var(--sparkDur,.9s) ease-out 1;
}
@keyframes starTwinkle{ 0%{opacity:.07;transform:scale(.9)} 50%{opacity:.95;transform:scale(1.1)} 100%{opacity:.15;transform:scale(.92)} }
@keyframes starSpark{ 0%{opacity:.25;transform:scale(1)} 40%{opacity:1;transform:scale(1.35)} 100%{opacity:.25;transform:scale(1)} }
@media (prefers-reduced-motion: reduce){
  .night-star{ animation: none; opacity:.22 }
  .night-star.spark{ animation: none; }
}

/* ======== Audio Quiz styles ======== */
.aq-grid{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
.aq-option{ position:relative; aspect-ratio:1/1; border:1px solid #1f2937; border-radius:12px; background:#0b1229; display:grid; place-items:center; overflow:hidden; }
.aq-option img{ width:100%; height:100%; object-fit:contain; display:block; }
.aq-option .aq-emoji{ font-size:48px; line-height:1; }
.aq-option.correct{ border-color: var(--accent); box-shadow:0 0 0 2px rgba(34,197,94,.25) inset }
.aq-option.wrong{ border-color: var(--err); box-shadow:0 0 0 2px rgba(239,68,68,.22) inset }

/* ======== Postcards ======== */
.pc-grid{
  display:grid; gap:10px;
  grid-template-columns:repeat(auto-fill, minmax(140px,1fr));
}
.pc-tile{
  position:relative; border:1px solid #1f2937; border-radius:12px;
  background:#0b1229; overflow:hidden; cursor:pointer;
  display:flex; flex-direction:column; align-items:center; justify-content:center; padding:10px;
  transition:transform .08s ease, box-shadow .2s ease;
}
.pc-tile:hover{ transform:translateY(-2px); box-shadow:0 8px 24px rgba(0,0,0,.22) }
.pc-thumb{
  width:100%; aspect-ratio:4/3; object-fit:cover; display:block;
  border-radius:8px; border:1px solid #1f2937; background:#0b1229;
}
.pc-emoji{ font-size:48px; line-height:1; display:none }
.pc-cap{ font-size:13px; color:#cbd5e1; margin-top:8px; text-align:center }

/* ======== Dictionary ======== */
.dict-table{width:100%; border-collapse:collapse;}
.dict-table th,.dict-table td{border-bottom:1px solid #1f2937; padding:8px 10px; text-align:left;}
.dict-table th{color:#9aa7b7;font-weight:600;font-size:13px}
.dict-empty{color:#94a3b8;font-size:14px;padding:6px 0}
.dict-controls{display:flex;align-items:center;justify-content:space-between;margin-top:10px}
.dict-play{background:transparent;border:none;color:#e5e7eb;cursor:pointer;padding:0;font:inherit;text-decoration:underline dotted #334155}
.dict-play:hover{opacity:.9}

/* === Dictionary: fixed-size experience === */
#dictModal .modal-card{ min-height:460px }               /* keep modal height steady while paging */
#dictPanel{ display:flex; flex-direction:column }
#dictScroll{ flex:1 1 auto; max-height:340px; overflow:auto; margin-bottom:10px }

/* ===== Furniture placements (specific) ===== */
#furnCatTree{ top:8px; left:8px; width:92px }
#furnCatToy{  top:18px; left:118px; width:72px }
#furnCatBowl{ top:112px; left:22px; width:68px }
</style>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js" defer></script>
</head>
<body>
<header>
  <h1>âœ¨ Farsi Fun â€” Learn Persian Basics</h1>
  <div class="stats">
    <div class="badge" id="profileBadge">Profile: â€”</div>
    <div class="badge" id="scoreBadge">Score: 0</div>
    <div class="badge" id="streakBadge">Streak: 0 ğŸ”¥</div>
    <div class="badge" id="unlockedBadge">0/0 unlocked</div>
    <button id="openMap" class="icon-btn" title="Bazaar Map">ğŸ—ºï¸</button>
    <button id="openPostcards" class="icon-btn" title="Postcards">ğŸ›ï¸</button>
    <!-- Dictionary button removed from header; now in the mode row -->
    <button id="openAchievements" class="icon-btn" title="Badges">ğŸ†</button>
    <button id="openSettings" class="icon-btn" title="Settings">âš™ï¸</button>
  </div>
</header>

<!-- Profile chooser -->
<div id="profileOverlay" class="overlay" style="display:grid">
  <div class="overlay-card" style="position:relative; text-align:center">
    <h2 style="margin-top:0">Who are you?</h2>
    <p class="tiny" style="margin-bottom:20px">Choose your profile to continue</p>
    <button id="quickNicole" class="primary" style="font-size:20px; padding:14px 28px;">Nicole</button>
    <button id="quickSia" style="position:absolute; bottom:10px; right:10px; font-size:12px; padding:4px 8px; opacity:0.75; display:none;" class="btn" title="Developer">Siyavash</button>
  </div>
</div>

<!-- Start screen -->
<div id="startOverlay" class="overlay" style="display:none">
  <div class="overlay-card">
    <h2>How do you want to learn today?</h2>
    <p>Pick a mode to get started. You can switch later.</p>
    <div style="display:flex; gap:12px; flex-wrap:wrap">
      <button id="startLearn" class="primary" type="button">ğŸ“š Learn Mode</button>
      <button id="startQuiz" class="accent" type="button">ğŸ¯ Quiz Mode</button>
    </div>
    <p class="tiny" style="margin-top:10px">Tip: Use <b>Chrome</b>. <b>Listen</b> plays your MP3s. New words unlock at <button id="midnightBtn0" class="btn" style="padding:2px 6px">midnight</button>.</p>
  </div>
</div>

<main>
  <div class="mode">
    <div class="mode-left">
      <button id="learnBtn" class="btn">Learn Mode</button>
      <button id="quizBtn" class="btn">Quiz Mode</button>
      <button id="audioQuizBtn" class="btn">Audio Quiz</button>
      <button id="musicToggle" class="btn">ğŸµ Play Music</button>
    </div>
    <div class="mode-right">
      <button id="openDictionary" class="btn" title="Dictionary">ğŸ“š Dictionary</button>
    </div>
  </div>

  <div class="card">
    <div class="row">
      <div class="media-wrap">
        <img id="pic" class="pic" alt="" />
        <div class="emoji" id="emoji"></div>
      </div>
      <div class="word" id="wordWrap">
        <div class="en" id="en">apple</div>
        <div class="fa" id="fa" dir="rtl">Ø³ÛŒØ¨</div>
        <div class="trans" id="trans">sib</div>

        <!-- Main practice UI -->
        <div id="learnUI">
          <div class="controls">
            <button id="listenBtn" class="accent">ğŸ”Š Listen</button>
            <button id="sayBtn" class="btn" disabled title="(optional speech recog)">ğŸ™ï¸ Say it</button>
            <button id="hintBtn" class="btn">ğŸ’¡ Hint</button>
            <button id="revealBtn" class="btn">ğŸ‘€ Reveal</button>
            <button id="nextBtn" class="primary">â¡ï¸ Next</button>
          </div>
          <div class="feedback" id="speechFeedback"></div>
          <label class="tiny" for="typeInput">Type the pronunciation (English letters):</label>
          <input class="input" id="typeInput" placeholder="e.g., sib" autocapitalize="off" autocorrect="off" spellcheck="false" inputmode="latin"/>
          <div class="controls">
            <button id="checkBtn" class="primary">âœ… Check</button>
            <button id="skipBtn" class="btn">â­ï¸ Skip</button>
          </div>
          <div class="feedback" id="typeFeedback"></div>
          <div class="progress"><div class="bar" id="progressBar"></div></div>
        </div>
      </div>
    </div>
  </div>
</main>

<footer style="padding:16px;text-align:center;color:#94a3b8">
  Have fun!
  <span class="tiny"> â€¢ New words unlock at
    <button id="midnightBtn" class="btn" style="padding:2px 6px">midnight</button> â°
  </span>
</footer>
<div id="celebration" class="cele-msg" style="display:none">let's goooooo ğŸ‰</div>
<div id="sadFace" class="cele-msg" style="display:none">ğŸ˜¢</div>

<!-- Achievements Modal -->
<div id="achModal" class="modal">
  <div class="modal-card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
      <h3 style="margin:0">ğŸ† Badges</h3>
      <button id="closeAch" class="btn">Close</button>
    </div>
    <div id="achList" class="grid"></div>
  </div>
</div>

<!-- Bazaar Map Modal -->
<div id="mapModal" class="modal">
  <div class="modal-card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
      <div class="shop-row"><button id="toggleNamesBtn" class="btn" title="Show/hide cat names">ğŸ¾ Show Names</button></div>
      <div style="display:flex;align-items:center;gap:10px">
        <h3 style="margin:0">ğŸ—ºï¸ Persian Bazaar Progress</h3>
        <div class="shop-row">
          <button id="openShop" class="btn accent" title="Redeem cat rewards">ğŸ’  Redeem</button>
          <button id="closeMap" class="btn">Close</button>
        </div>
      </div>
    </div>
    <p class="tiny">Lots of cats live here ğŸˆ. Cats are unlocked at 5, 20, 100, 250, 500. </p>

    <div class="map-wrap" id="mapWrap">
      <div id="mapGrid" class="map"></div>
      <div id="catLayer" class="cat-layer"></div>
    </div>

    <div id="shopPanel" class="stat" style="display:none; margin-top:10px">
      <div class="shop-row" style="justify-content:space-between">
        <div class="muted">Score: <b id="shopScore">0</b> â€¢ Fish: <b id="shopFish">0</b> â€¢ Catnip: <b id="shopCatnip">0</b></div>
        <div class="shop-row">
          <button id="buyFishBtn" class="btn">ğŸŸ Buy Fish (100)</button>
          <button id="feedFishBtn" class="btn">ğŸ½ï¸ Feed Cats</button>
          <button id="buyCatnipBtn" class="btn">ğŸŒ¿ Buy Catnip (250)</button>
          <button id="useCatnipBtn" class="btn">ğŸŒ¿ Use Catnip</button>
          <button id="toggleNameArea" class="btn">ğŸ“ Name a Cat (500)</button>
          <button id="buyFurnitureBtn" class="btn">ğŸª‘ Buy Furniture (1000)</button>
        </div>
      </div>

      <div id="nameArea" style="display:none; margin-top:8px">
        <div class="shop-row">
          <select id="catSelect" class="btn"></select>
          <input id="catNameInput" class="input" placeholder="Enter a cute nameâ€¦" style="max-width:260px"/>
          <button id="confirmNameBtn" class="primary">Save Name</button>
          <span id="nameCostNote" class="tiny muted">Costs 500 points.</span>
        </div>
      </div>

      <div id="shopMsg" class="feedback"></div>
    </div>
  </div>
</div>

<!-- Postcards Modal -->
<div id="postcardsModal" class="modal">
  <div class="modal-card" style="max-width:940px">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <h3 id="pcTitle" style="margin:0">ğŸ›ï¸ Landmark Postcards</h3>
      <button id="closePostcards" class="btn">Close</button>
    </div>

    <div id="pcView" class="stat" style="display:grid;grid-template-columns:1fr;gap:10px;margin-bottom:12px">
      <div style="display:grid;place-items:center">
        <img id="pcViewImg" alt="" style="display:none;width:min(780px,100%);height:auto;border-radius:12px;border:1px solid #1f2937;background:#0b1229" loading="lazy"/>
        <div id="pcViewEmoji" class="emoji" style="display:none">ğŸ›ï¸</div>
      </div>
      <div>
        <div id="pcViewFa" class="fa" dir="rtl" lang="fa" style="font-size:22px"></div>
        <div id="pcViewTrans" class="trans" style="font-size:18px;margin-top:6px"></div>
        <div id="pcViewEn" class="en" style="font-size:18px;margin-top:4px"></div>
      </div>
      <div class="tiny" id="pcUnlockNote"></div>
    </div>

    <div id="pcGrid" class="pc-grid"></div>
  </div>
</div>

<!-- Dictionary Modal -->
<div id="dictModal" class="modal">
  <div class="modal-card" style="max-width:720px">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
      <h3 style="margin:0">ğŸ“š Dictionary</h3>
      <button id="closeDict" class="btn">Close</button>
    </div>
    <div id="dictPanel" class="stat">
      <table class="dict-table" id="dictTable"></table>
      <div id="dictEmpty" class="dict-empty" style="display:none">No learned words yet. Practice to add some!</div>
      <div class="dict-controls">
        <button id="dictPrev" class="btn">â¬… Prev</button>
        <span id="dictPageLabel" class="tiny">Page 1 / 1</span>
        <button id="dictNext" class="btn">Next â¡</button>
      </div>
    </div>
  </div>
</div>

<!-- Settings Modal -->
<div id="settingsModal" class="modal">
  <div class="modal-card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
      <h3 style="margin:0">âš™ï¸ Settings</h3>
      <button id="closeSettings" class="btn">Close</button>
    </div>
    <div class="grid">
      <div class="stat">
        <b>Themes (rewards)</b>
        <p class="tiny">Unlock a new theme for every <b>50</b> words learned.</p>
        <select id="themeSelect" style="width:100%"></select>
        <div id="themeNote" class="tiny" style="margin-top:6px"></div>
      </div>
      <div class="stat">
        <b>Mini Quiz</b><p class="tiny">Practice 5 items (image â†’ type the transliteration).</p>
        <button id="startMiniQuiz" class="btn">âš¡ Start Mini Quiz</button>
      </div>
      <div class="stat">
        <b>Review Mode</b><p class="tiny">Quiz only on words she has mastered (ignores SRS order).</p>
        <button id="reviewToggle" class="btn">ğŸ” Review All Mastered: OFF</button>
      </div>
      <div class="stat">
        <b>Sentence Practice</b>
        <p class="tiny">Read example sentences & translations.</p>
        <button id="openSentences" class="btn">ğŸ“– Open Sentence Practice</button>
      </div>
      <div class="stat">
        <b>Danger zone</b>
        <p class="tiny">Clear this profileâ€™s score, streak, SRS, unlocks, and achievements.</p>
        <button id="resetBtn" class="btn" style="background:linear-gradient(180deg,#ef4444,#dc2626);border-color:#7f1d1d">â™»ï¸ Reset Progress</button>
        <button id="resetNamesBtn" class="btn" style="margin-top:8px;background:linear-gradient(180deg,#f59e0b,#d97706);border-color:#b45309" title="Clear all saved cat names for this profile only">ğŸ¾ Reset Cat Names</button>
      </div>
    </div>
  </div>
</div>

<!-- Sentence Practice Modal -->
<div id="sentencesModal" class="modal">
  <div class="modal-card" style="max-width:820px">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
      <h3 style="margin:0">ğŸ“– Sentence Practice</h3>
      <button id="closeSentences" class="btn">Close</button>
    </div>
    <div id="sentencePanel" class="stat">
      <div class="fa" id="sentFa" dir="rtl" style="font-size:22px"></div>
      <div class="trans" id="sentTrans" style="font-size:18px; margin-top:8px"></div>
      <div class="en" id="sentEn" style="font-size:18px; margin-top:4px"></div>
    </div>
    <div class="controls" style="justify-content:space-between">
      <div class="tiny" id="sentProgress"></div>
      <div>
        <button id="sentPrev" class="btn">â¬…ï¸ Prev</button>
        <button id="sentNext" class="primary">Next â¡ï¸</button>
      </div>
    </div>
  </div>
</div>

<!-- Mini Quiz Modal -->
<div id="miniQuizModal" class="modal">
  <div class="modal-card" style="max-width:740px">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
      <h3 style="margin:0">âš¡ Mini Quiz</h3>
      <button id="mqQuit" class="btn" title="Exit Mini Quiz">âœ– Quit</button>
    </div>
    <div class="qprogress" style="height:8px;background:#0a142e;border:1f2937;border:1px solid #1f2937;border-radius:999px;overflow:hidden;margin-bottom:12px">
      <div id="mqBar" class="bar" style="height:8px;width:0%"></div>
    </div>
    <img id="mqPic" class="mq-pic" alt="" style="display:block;margin:auto" loading="lazy"/>
    <div id="mqEmoji" class="emoji" style="display:none; text-align:center; margin-top:8px"></div>
    <input id="mqInput" class="input" placeholder="Type the transliterationâ€¦" style="margin-top:12px"/>
    <div class="controls" style="justify-content:flex-end"><button id="mqCheck" class="primary">Check</button></div>
    <div id="mqFeedback" class="feedback"></div>
  </div>
</div>

<!-- Audio Quiz Modal -->
<div id="audioQuizModal" class="modal">
  <div class="modal-card" style="max-width:760px">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
      <h3 style="margin:0">ğŸ”Š Audio Quiz</h3>
      <button id="aqQuit" class="btn" title="Exit Audio Quiz">âœ– Quit</button>
    </div>
    <div class="qprogress" style="height:8px;background:#0a142e;border:1px solid #1f2937;border-radius:999px;overflow:hidden;margin-bottom:12px">
      <div id="aqBar" class="bar" style="height:8px;width:0%"></div>
    </div>
    <div class="controls" style="justify-content:space-between;margin-bottom:10px">
      <div class="tiny">Hear the word â†’ pick the picture</div>
      <div><button id="aqPlay" class="accent">â–¶ï¸ Play</button></div>
    </div>
    <div id="aqOptions" class="aq-grid" role="listbox" aria-label="Audio quiz options"></div>
    <div id="aqFeedback" class="feedback"></div>
  </div>
</div>

<script>
/* ===================== PROFILED STORAGE ===================== */
let ACTIVE_PROFILE = null;
const GLOBAL_PREFIX = 'ff';
function PKEY(k){ return `${GLOBAL_PREFIX}:${ACTIVE_PROFILE||'__anon'}:${k}`; }
const store = {
  get:(k,def=null)=>{ try{ const v=localStorage.getItem(PKEY(k)); return v===null?def:JSON.parse(v); }catch{ return def; } },
  set:(k,v)=>{ try{ localStorage.setItem(PKEY(k), JSON.stringify(v)); }catch{} },
  del:(k)=>{ try{ localStorage.removeItem(PKEY(k)); }catch{} }
};

/* ===================== CONSTANTS ===================== */
const DAILY_WORDS = 5;
const SRS_INTERVALS_HOURS = [0,8,24,72,168,336];
const MINI_QUIZ_SIZE = 5;
const AUDIO_QUIZ_SIZE = 8;
const FISH_COST = 100;
const NAME_COST = 500;
const CATNIP_COST = 250;
const CATNIP_DURATION_MS = 180000;
const CATNIP_SPEED_FACTOR = 3.0;
const CATNIP_TURN_FACTOR = 0.45;
const FURNITURE_COST = 1000;
const CAT_TREE_IMG = 'images/cat_tree.png';
const CAT_TOY_IMG  = 'images/cat_toy.png';
const CAT_BOWL_IMG = 'images/cat_bowl.png';
const FURNITURE_ORDER = ['catTree','catToy','catBowl'];
const CAT_UNLOCK_THRESHOLDS = [5, 20, 100, 250, 500];
const POSTCARD_UNLOCK_EVERY = 15;

/* Example sentences */
const SENTENCES = [
  { fa:"Ù…Ù† Ø¢Ø¨ Ù…ÛŒâ€ŒÙ†ÙˆØ´Ù….", translit:"man Ã¢b minusham.", en:"I drink water." },
  { fa:"Ø§Ùˆ ÛŒÚ© Ú¯Ø±Ø¨Ù‡ Ø¯Ø§Ø±Ø¯.", translit:"u yek gorbe dÃ¢rad.", en:"He/She has a cat." },
  { fa:"Ø§ÛŒÙ† Ø®Ø§Ù†Ù‡ Ø¨Ø²Ø±Ú¯ Ø§Ø³Øª.", translit:"in khÃ¢ne bozorg ast.", en:"This house is big." },
  { fa:"Ù…Ù† Ú©ØªØ§Ø¨ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù†Ù….", translit:"man ketÃ¢b mikhÃ¢nam.", en:"I am reading a book." },
  { fa:"Ø§Ù…Ø±ÙˆØ² Ù‡ÙˆØ§ Ø®ÙˆØ¨ Ø§Ø³Øª.", translit:"emruz havÃ¢ khub ast.", en:"The weather is good today." },
  { fa:"Ø³Ú¯ Ø¯Ø± Ù¾Ø§Ø±Ú© Ø§Ø³Øª.", translit:"sag dar pÃ¢rk ast.", en:"The dog is in the park." }
];

/* ===================== WORDS ===================== */
const words = [
  {fa:"Ø³ÛŒØ¨", en:"apple", translit:"sib", emoji:"ğŸ", audio:"audio/sib.mp3", image:"images/sib.png"},
  {fa:"Ú©ØªØ§Ø¨", en:"book", translit:"ketÃ¢b", emoji:"ğŸ“–", audio:"audio/ketab.mp3", image:"images/ketab.png"},
  {fa:"Ú¯Ø±Ø¨Ù‡", en:"cat", translit:"gorbe", emoji:"ğŸ±", audio:"audio/gorbe.mp3", image:"images/gorbe.png"},
  {fa:"Ø³Ú¯", en:"dog", translit:"sag", emoji:"ğŸ¶", audio:"audio/sag.mp3", image:"images/sag.png"},
  {fa:"Ø¢Ø¨", en:"water", translit:"Ã¢b", emoji:"ğŸ’§", audio:"audio/ab.mp3", image:"images/ab.png"},
  {fa:"Ù†Ø§Ù†", en:"bread", translit:"nÃ¢n", emoji:"ğŸ", audio:"audio/nan.mp3", image:"images/nan.png"},
  {fa:"Ú†Ø§ÛŒ", en:"tea", translit:"chÃ¢y", emoji:"ğŸµ", audio:"audio/chay.mp3", image:"images/chay.png"},
  {fa:"Ù…Ø§Ø´ÛŒÙ†", en:"car", translit:"mÃ¢shin", emoji:"ğŸš—", audio:"audio/mashin.mp3", image:"images/mashin.png"},
  {fa:"Ø®Ø§Ù†Ù‡", en:"house", translit:"khÃ¢ne", emoji:"ğŸ ", audio:"audio/khane.mp3", image:"images/khane.png"},
  {fa:"Ø¯Ø±", en:"door", translit:"dar", emoji:"ğŸšª", audio:"audio/dar.mp3", image:"images/dar.png"},
  {fa:"Ø³Ù„Ø§Ù…", en:"hello", translit:"salÃ¢m", emoji:"ğŸ‘‹", audio:"audio/salam.mp3", image:"images/salam.png"},
  {fa:"Ø®Ø¯Ø§Ø­Ø§ÙØ¸", en:"goodbye", translit:"khodÃ¢hÃ¢fez", emoji:"ğŸ‘‹", audio:"audio/khodahafez.mp3", image:"images/khodahafez.png"},
  {fa:"Ø¨Ù„Ù‡", en:"yes", translit:"bale", emoji:"âœ…", audio:"audio/bale.mp3", image:"images/bale.png"},
  {fa:"Ù†Ù‡", en:"no", translit:"na", emoji:"âŒ", audio:"audio/na.mp3", image:"images/na.png"},
  {fa:"Ù„Ø·ÙØ§Ù‹", en:"please", translit:"lotfan", emoji:"ğŸ™", audio:"audio/lotfan.mp3", image:"images/lotfan.png"},
  {fa:"Ù…Ø±Ø³ÛŒ", en:"thank you", translit:"merci", emoji:"ğŸ™", audio:"audio/merci.mp3", image:"images/merci.png"},
  {fa:"ØµØ¨Ø­ Ø¨Ø®ÛŒØ±", en:"good morning", translit:"sobh bekheir", emoji:"ğŸŒ…", audio:"audio/sobh_bekheir.mp3", image:"images/sobh_bekheir.png"},
  {fa:"Ø´Ø¨ Ø¨Ø®ÛŒØ±", en:"good night", translit:"shab bekheir", emoji:"ğŸŒ™", audio:"audio/shab_bekheir.mp3", image:"images/shab_bekheir.png"},
  {fa:"ÙØ±Ø¯Ø§", en:"tomorrow", translit:"fardÃ¢", emoji:"ğŸ“…", audio:"audio/farda.mp3", image:"images/farda.png"},
  {fa:"Ø¯ÛŒØ±ÙˆØ²", en:"yesterday", translit:"diruz", emoji:"ğŸ“…", audio:"audio/diruz.mp3", image:"images/diruz.png"},
  {fa:"Ø§Ù…Ø±ÙˆØ²", en:"today", translit:"emruz", emoji:"ğŸ“…", audio:"audio/emruz.mp3", image:"images/emruz.png"},
  {fa:"Ú©Ø±Ù‡", en:"butter", translit:"kare", emoji:"ğŸ§ˆ", audio:"audio/kare.mp3", image:"images/kare.png"},
  {fa:"Ù¾Ù†ÛŒØ±", en:"cheese", translit:"panir", emoji:"ğŸ§€", audio:"audio/panir.mp3", image:"images/panir.png"},
  {fa:"ØªØ®Ù… Ù…Ø±Øº", en:"egg", translit:"tokhm morgh", emoji:"ğŸ¥š", audio:"audio/tokhm_morgh.mp3", image:"images/tokhm_morgh.png"},
  {fa:"Ú¯ÙˆØ´Øª", en:"meat", translit:"gusht", emoji:"ğŸ¥©", audio:"audio/gusht.mp3", image:"images/gusht.png"},
  {fa:"Ù…Ø±Øº", en:"chicken", translit:"morgh", emoji:"ğŸ—", audio:"audio/morgh.mp3", image:"images/morgh.png"},
  {fa:"Ú¯Ø§Ùˆ", en:"cow", translit:"gÃ¢v", emoji:"ğŸ„", audio:"audio/gav.mp3", image:"images/gav.png"},
  {fa:"Ù…Ø§Ù‡ÛŒ", en:"fish", translit:"mÃ¢hi", emoji:"ğŸŸ", audio:"audio/mahi.mp3", image:"images/mahi.png"},
  {fa:"Ø¨Ø±Ù†Ø¬", en:"rice", translit:"berenj", emoji:"ğŸš", audio:"audio/berenj.mp3", image:"images/berenj.png"},
  {fa:"Ø´Ú©Ø±", en:"sugar", translit:"shekar", emoji:"ğŸ¬", audio:"audio/shekar.mp3", image:"images/shekar.png"},
  {fa:"Ù†Ù…Ú©", en:"salt", translit:"namak", emoji:"ğŸ§‚", audio:"audio/namak.mp3", image:"images/namak.png"},
  {fa:"ÙÙ„ÙÙ„", en:"pepper", translit:"felfel", emoji:"ğŸŒ¶ï¸", audio:"audio/felfel.mp3", image:"images/felfel.png"},
  {fa:"Ù„ÛŒÙ…Ùˆ", en:"lemon", translit:"limu", emoji:"ğŸ‹", audio:"audio/limu.mp3", image:"images/limu.png"},
  {fa:"Ù¾Ø±ØªÙ‚Ø§Ù„", en:"orange", translit:"porteghÃ¢l", emoji:"ğŸŠ", audio:"audio/porteghal.mp3", image:"images/porteghal.png"},
  {fa:"Ù…ÙˆØ²", en:"banana", translit:"moz", emoji:"ğŸŒ", audio:"audio/moz.mp3", image:"images/moz.png"},
  {fa:"Ù‡Ù†Ø¯ÙˆØ§Ù†Ù‡", en:"watermelon", translit:"hendune", emoji:"ğŸ‰", audio:"audio/hendune.mp3", image:"images/hendune.png"},
  {fa:"Ø§Ù†Ú¯ÙˆØ±", en:"grape", translit:"angur", emoji:"ğŸ‡", audio:"audio/angur.mp3", image:"images/angur.png"},
  {fa:"Ú©ÛŒÙˆÛŒ", en:"kiwi", translit:"kivi", emoji:"ğŸ¥", audio:"audio/kivi.mp3", image:"images/kivi.png"},
  {fa:"ØªÙˆØª ÙØ±Ù†Ú¯ÛŒ", en:"strawberry", translit:"tut farangi", emoji:"ğŸ“", audio:"audio/tut_farangi.mp3", image:"images/tut_farangi.png"},
  {fa:"Ø®ÛŒØ§Ø±", en:"cucumber", translit:"khiÃ¢r", emoji:"ğŸ¥’", audio:"audio/khiar.mp3", image:"images/khiar.png"},
  {fa:"Ú¯ÙˆØ¬Ù‡", en:"tomato", translit:"goje", emoji:"ğŸ…", audio:"audio/goje.mp3", image:"images/goje.png"},
  {fa:"Ø³ÛŒØ¨ Ø²Ù…ÛŒÙ†ÛŒ", en:"potato", translit:"sib zamini", emoji:"ğŸ¥”", audio:"audio/sib_zamini.mp3", image:"images/sib_zamini.png"},
  {fa:"Ù‡ÙˆÛŒØ¬", en:"carrot", translit:"havij", emoji:"ğŸ¥•", audio:"audio/havij.mp3", image:"images/havij.png"},
  {fa:"Ù‚Ø§Ø±Ú†", en:"mushroom", translit:"ghÃ¢rch", emoji:"ğŸ„", audio:"audio/gharch.mp3", image:"images/gharch.png"},
  {fa:"Ø¨Ø§Ø¯Ù…Ø¬Ø§Ù†", en:"eggplant", translit:"bÃ¢demjÃ¢n", emoji:"ğŸ†", audio:"audio/bademjan.mp3", image:"images/bademjan.png"},
  {fa:"Ù„ÙˆØ¨ÛŒØ§", en:"bean", translit:"lubiÃ¢", emoji:"ğŸ«˜", audio:"audio/lubia.mp3", image:"images/lubia.png"},
  {fa:"Ø¹Ø¯Ø³", en:"lentil", translit:"adas", emoji:"ğŸ«˜", audio:"audio/adas.mp3", image:"images/adas.png"},
  {fa:"ØºØ°Ø§", en:"food", translit:"ghazÃ¢", emoji:"ğŸ½ï¸", audio:"audio/ghaza.mp3", image:"images/ghaza.png"},
  {fa:"Ø¢Ø¨Ù…ÛŒÙˆÙ‡", en:"juice", translit:"Ã¢b mive", emoji:"ğŸ§ƒ", audio:"audio/ab_mive.mp3", image:"images/ab_mive.png"},
  {fa:"Ø´ÛŒØ±", en:"milk", translit:"shir", emoji:"ğŸ¥›", audio:"audio/shir.mp3", image:"images/shir.png"},
  {fa:"Ù‚Ù‡ÙˆÙ‡", en:"coffee", translit:"ghahve", emoji:"â˜•", audio:"audio/ghahve.mp3", image:"images/ghahve.png"},
  {fa:"Ø¢Ø¨Ø¬Ùˆ", en:"beer", translit:"Ã¢bjo", emoji:"ğŸº", audio:"audio/abjo.mp3", image:"images/abjo.png"},
  {fa:"Ø´Ø±Ø§Ø¨", en:"wine", translit:"sharÃ¢b", emoji:"ğŸ·", audio:"audio/sharab.mp3", image:"images/sharab.png"},
  {fa:"Ø±ÙˆØ´Ù†", en:"light", translit:"roshan", emoji:"ğŸ’¡", audio:"audio/roshan.mp3", image:"images/roshan.png"},
  {fa:"ØªØ§Ø±ÛŒÚ©", en:"dark", translit:"tÃ¢rik", emoji:"ğŸŒ‘", audio:"audio/tarik.mp3", image:"images/tarik.png"},
  {fa:"Ø³ÙÛŒØ¯", en:"white", translit:"sefid", emoji:"âšª", audio:"audio/sefid.mp3", image:"images/sefid.png"},
  {fa:"Ø³ÛŒØ§Ù‡", en:"black", translit:"siyÃ¢h", emoji:"âš«", audio:"audio/siyah.mp3", image:"images/siyah.png"},
  {fa:"Ù‚Ø±Ù…Ø²", en:"red", translit:"ghermez", emoji:"ğŸ”´", audio:"audio/ghermez.mp3", image:"images/ghermez.png"},
  {fa:"Ø¢Ø¨ÛŒ", en:"blue", translit:"Ã¢bi", emoji:"ğŸ”µ", audio:"audio/abi.mp3", image:"images/abi.png"},
  {fa:"Ø³Ø¨Ø²", en:"green", translit:"sabz", emoji:"ğŸŸ¢", audio:"audio/sabz.mp3", image:"images/sabz.png"},
  {fa:"Ø²Ø±Ø¯", en:"yellow", translit:"zard", emoji:"ğŸŸ¡", audio:"audio/zard.mp3", image:"images/zard.png"},
  {fa:"Ø¨Ù†ÙØ´", en:"purple", translit:"banafsh", emoji:"ğŸŸ£", audio:"audio/banafsh.mp3", image:"images/banafsh.png"},
  {fa:"Ù†Ø§Ø±Ù†Ø¬ÛŒ", en:"orange (color)", translit:"nÃ¢renji", emoji:"ğŸŸ ", audio:"audio/narenji.mp3", image:"images/narenji.png"},
  {fa:"ØµÙˆØ±ØªÛŒ", en:"pink", translit:"surati", emoji:"ğŸŒ¸", audio:"audio/surati.mp3", image:"images/surati.png"},
  {fa:"Ø¨Ø³ØªÙ†ÛŒ", en:"ice cream", translit:"bastani", emoji:"ğŸ¨", audio:"audio/bastani.mp3", image:"images/bastani.png"},
  {fa:"Ø´Ú©Ù„Ø§Øª", en:"chocolate", translit:"shokolÃ¢t", emoji:"ğŸ«", audio:"audio/shokolat.mp3", image:"images/shokolat.png"},
  {fa:"Ú©ÛŒÚ©", en:"cake", translit:"keyk", emoji:"ğŸ‚", audio:"audio/keyk.mp3", image:"images/keyk.png"},
  {fa:"Ù¾ÙˆÙ„", en:"money", translit:"pul", emoji:"ğŸ’µ", audio:"audio/pul.mp3", image:"images/pul.png"},
  {fa:"Ú©Ø§Ø±Øª Ø¨Ø§Ù†Ú©ÛŒ", en:"bank card", translit:"kÃ¢rt bÃ¢nki", emoji:"ğŸ’³", audio:"audio/kart_banki.mp3", image:"images/kart_banki.png"},
  {fa:"Ù‡Ø¯ÛŒÙ‡", en:"gift", translit:"hedye", emoji:"ğŸ", audio:"audio/hedye.mp3", image:"images/hedye.png"},
  {fa:"Ø¹Ø±ÙˆØ³ÛŒ", en:"wedding", translit:"arusi", emoji:"ğŸ’’", audio:"audio/arusi.mp3", image:"images/arusi.png"},
  {fa:"ØªÙˆÙ„Ø¯", en:"birthday", translit:"tavallod", emoji:"ğŸ‰", audio:"audio/tavallod.mp3", image:"images/tavallod.png"},
  {fa:"Ø¹Ø´Ù‚", en:"love", translit:"eshgh", emoji:"â¤ï¸", audio:"audio/eshgh.mp3", image:"images/eshgh.png"},
  {fa:"Ø´Ù†Ø§", en:"swim", translit:"shenÃ¢", emoji:"ğŸŠ", audio:"audio/shena.mp3", image:"images/shena.png"},
  {fa:"Ø¨Ø§Ø²ÛŒ", en:"play", translit:"bÃ¢zi", emoji:"ğŸ®", audio:"audio/bazi.mp3", image:"images/bazi.png"},
  {fa:"ØªÙ…Ø§Ø´Ø§", en:"watch", translit:"tamÃ¢shÃ¢", emoji:"ğŸ“º", audio:"audio/tamasha.mp3", image:"images/tamasha.png"},
  {fa:"Ø¯ÙˆØ³Øª Ø¯Ø§Ø±Ù…", en:"I like", translit:"dust dÃ¢ram", emoji:"ğŸ‘", audio:"audio/dust_daram.mp3", image:"images/dust_daram.png"},
  {fa:"Ù…ÛŒâ€ŒØ±Ù…", en:"I go", translit:"miram", emoji:"ğŸƒ", audio:"audio/miram.mp3", image:"images/miram.png"},
  {fa:"Ù…ÛŒØ§Ù…", en:"I come", translit:"miÃ¢m", emoji:"ğŸš¶", audio:"audio/miam.mp3", image:"images/miam.png"},
  {fa:"Ø¯ÛŒØ¯Ù†", en:"see", translit:"didan", emoji:"ğŸ‘€", audio:"audio/didan.mp3", image:"images/didan.png"},
  {fa:"Ø´Ù†ÛŒØ¯Ù†", en:"hear", translit:"shenidan", emoji:"ğŸ‘‚", audio:"audio/shenidan.mp3", image:"images/shenidan.png"},
  {fa:"Ú¯ÙØªÙ†", en:"say", translit:"goftan", emoji:"ğŸ—£ï¸", audio:"audio/goftan.mp3", image:"images/goftan.png"},
  {fa:"Ø®ÙˆØ±Ø¯Ù†", en:"eat", translit:"khordan", emoji:"ğŸ½ï¸", audio:"audio/khordan.mp3", image:"images/khordan.png"},
  {fa:"Ø®ÙˆØ§Ø¨", en:"sleep", translit:"khÃ¢b", emoji:"ğŸ˜´", audio:"audio/khab.mp3", image:"images/khab.png"},
  {fa:"Ø¨ÛŒØ¯Ø§Ø±", en:"awake", translit:"bidÃ¢r", emoji:"â°", audio:"audio/bidar.mp3", image:"images/bidar.png"},
  {fa:"Ø¯Ø±Ø³", en:"teach", translit:"dars", emoji:"ğŸ‘©â€ğŸ«", audio:"audio/dars.mp3", image:"images/dars.png"},
  {fa:"Ú©Ø§Ø±", en:"work", translit:"kÃ¢r", emoji:"ğŸ’¼", audio:"audio/kar.mp3", image:"images/kar.png"},
  {fa:"Ø®ÙˆØ§Ù†Ø¯Ù†", en:"read", translit:"khÃ¢ndan", emoji:"ğŸ“–", audio:"audio/khandan.mp3", image:"images/khandan.png"},
  {fa:"Ù†ÙˆØ´ØªÙ†", en:"write", translit:"neveshtan", emoji:"âœï¸", audio:"audio/neveshtan.mp3", image:"images/neveshtan.png"},
  {fa:"Ù¾Ø±Ø³Ø´", en:"ask/question", translit:"porsesh", emoji:"â“", audio:"audio/porsesh.mp3", image:"images/porsesh.png"},
  {fa:"Ù¾Ø§Ø³Ø®", en:"answer", translit:"pÃ¢sokh", emoji:"ğŸ’¬", audio:"audio/pasokh.mp3", image:"images/pasokh.png"},
  {fa:"Ø®Ø±ÛŒØ¯", en:"shop", translit:"kharid", emoji:"ğŸ›ï¸", audio:"audio/kharid.mp3", image:"images/kharid.png"},
  {fa:"Ø±Ø§Ù†Ù†Ø¯Ú¯ÛŒ", en:"drive", translit:"rÃ¢nandegi", emoji:"ğŸš—", audio:"audio/ranandegi.mp3", image:"images/ranandegi.png"},
  {fa:"Ø±Ø§Ù‡ Ø±ÙØªÙ†", en:"walk", translit:"rÃ¢h raftan", emoji:"ğŸš¶", audio:"audio/rah_raftan.mp3", image:"images/rah_raftan.png"},
  {fa:"Ù„Ø¨Ø®Ù†Ø¯", en:"smile", translit:"labkhand", emoji:"ğŸ˜Š", audio:"audio/labkhand.mp3", image:"images/labkhand.png"},
  {fa:"Ú¯Ø±ÛŒÙ‡", en:"cry", translit:"gerye", emoji:"ğŸ˜¢", audio:"audio/gerye.mp3", image:"images/gerye.png"},
  {fa:"Ø®Ù†Ø¯Ù‡", en:"laugh", translit:"khande", emoji:"ğŸ˜‚", audio:"audio/khande.mp3", image:"images/khande.png"},
  {fa:"Ú¯Ø±Ø³Ù†Ù‡", en:"hungry", translit:"gorsne", emoji:"ğŸ½ï¸", audio:"audio/gorsne.mp3", image:"images/gorsne.png"},
  {fa:"ØªØ´Ù†Ù‡", en:"thirsty", translit:"tashne", emoji:"ğŸ¥¤", audio:"audio/tashne.mp3", image:"images/tashne.png"},
  {fa:"Ø®Ø³ØªÙ‡", en:"tired", translit:"khastÃ©", emoji:"ğŸ˜´", audio:"audio/khaste.mp3", image:"images/khaste.png"},
  {fa:"Ø®ÙˆØ´Ø­Ø§Ù„", en:"happy", translit:"khoshhÃ¢l", emoji:"ğŸ˜„", audio:"audio/khoshhal.mp3", image:"images/khoshhal.png"},
  {fa:"Ù†Ø§Ø±Ø§Ø­Øª", en:"sad", translit:"nÃ¢rÃ¢hat", emoji:"ğŸ˜”", audio:"audio/narahat.mp3", image:"images/narahat.png"},
  {fa:"Ø¹ØµØ¨Ø§Ù†ÛŒ", en:"angry", translit:"asabÃ¢ni", emoji:"ğŸ˜ ", audio:"audio/asabani.mp3", image:"images/asabani.png"},
  {fa:"Ø¢Ø±Ø§Ù…", en:"calm", translit:"Ã¢rÃ¢m", emoji:"ğŸ˜Œ", audio:"audio/aram.mp3", image:"images/aram.png"},
  {fa:"Ø¨Ø²Ø±Ú¯", en:"big", translit:"bozorg", emoji:"ğŸ”µ", audio:"audio/bozorg.mp3", image:"images/bozorg.png"},
  {fa:"Ú©ÙˆÚ†Ú©", en:"small", translit:"kuchak", emoji:"âšª", audio:"audio/kuchak.mp3", image:"images/kuchak.png"},
  {fa:"Ø¨Ù„Ù†Ø¯", en:"tall", translit:"boland", emoji:"ğŸ“", audio:"audio/boland.mp3", image:"images/boland.png"},
  {fa:"Ú©ÙˆØªØ§Ù‡", en:"short", translit:"kutÃ¢h", emoji:"ğŸ“", audio:"audio/kutah.mp3", image:"images/kutah.png"},
  {fa:"Ú¯Ø±Ù…", en:"hot", translit:"garm", emoji:"ğŸ”¥", audio:"audio/garm.mp3", image:"images/garm.png"},
  {fa:"Ø³Ø±Ø¯", en:"cold", translit:"sard", emoji:"â„ï¸", audio:"audio/sard.mp3", image:"images/sard.png"},
  {fa:"Ú¯Ø±Ø§Ù†", en:"expensive", translit:"gerÃ¢n", emoji:"ğŸ’°", audio:"audio/geran.mp3", image:"images/geran.png"},
  {fa:"Ø§Ø±Ø²Ø§Ù†", en:"cheap", translit:"arzÃ¢n", emoji:"ğŸª™", audio:"audio/arzan.mp3", image:"images/arzan.png"},
  {fa:"Ø²ÛŒØ¨Ø§", en:"beautiful", translit:"zibÃ¢", emoji:"ğŸŒ¸", audio:"audio/ziba.mp3", image:"images/ziba.png"},
  {fa:"Ø²Ø´Øª", en:"ugly", translit:"zesht", emoji:"ğŸ™ˆ", audio:"audio/zesht.mp3", image:"images/zesht.png"},
  {fa:"Ù†Ø²Ø¯ÛŒÚ©", en:"near", translit:"nazdik", emoji:"ğŸ“", audio:"audio/nazdik.mp3", image:"images/nazdik.png"},
  {fa:"Ø¯ÙˆØ±", en:"far", translit:"dur", emoji:"ğŸ—ºï¸", audio:"audio/dur.mp3", image:"images/dur.png"},
  {fa:"Ú†Ù¾", en:"left", translit:"chap", emoji:"â¬…ï¸", audio:"audio/chap.mp3", image:"images/chap.png"},
  {fa:"Ø±Ø§Ø³Øª", en:"right", translit:"rÃ¢st", emoji:"â¡ï¸", audio:"audio/rast.mp3", image:"images/rast.png"},
  {fa:"Ø¨Ø§Ù„Ø§", en:"up", translit:"bÃ¢lÃ¢", emoji:"â¬†ï¸", audio:"audio/bala.mp3", image:"images/bala.png"},
  {fa:"Ù¾Ø§ÛŒÛŒÙ†", en:"down", translit:"pÃ¢yin", emoji:"â¬‡ï¸", audio:"audio/payin.mp3", image:"images/payin.png"},
  {fa:"Ú©Ø¬Ø§", en:"where", translit:"kojÃ¢", emoji:"ğŸ“", audio:"audio/koja.mp3", image:"images/koja.png"},
  {fa:"Ú©ÛŒ", en:"when", translit:"key", emoji:"â°", audio:"audio/key.mp3", image:"images/key.png"},
  {fa:"Ú†Ø·ÙˆØ±", en:"how", translit:"chetur", emoji:"ğŸ¤”", audio:"audio/chetur.mp3", image:"images/chetur.png"},
  {fa:"Ú†Ø±Ø§", en:"why", translit:"cherÃ¢", emoji:"â“", audio:"audio/chera.mp3", image:"images/chera.png"},
  {fa:"Ú†Ù‡ Ú©Ø³ÛŒ", en:"who", translit:"che kasi", emoji:"ğŸ§", audio:"audio/chekasi.mp3", image:"images/chekasi.png"},
  {fa:"Ú†Ù‡ Ú†ÛŒØ²ÛŒ", en:"what", translit:"che chizi", emoji:"ğŸ“¦", audio:"audio/chechizi.mp3", image:"images/chechizi.png"},
  {fa:"Ú†Ù†Ø¯", en:"how many", translit:"chand", emoji:"ğŸ”¢", audio:"audio/chand.mp3", image:"images/chand.png"},
  {fa:"Ú†Ù‚Ø¯Ø±", en:"how much", translit:"cheghadr", emoji:"ğŸ’°", audio:"audio/cheghadr.mp3", image:"images/cheghadr.png"},
  {fa:"Ø²ÛŒØ§Ø¯", en:"a lot", translit:"ziyÃ¢d", emoji:"ğŸ”†", audio:"audio/ziad.mp3", image:"images/ziad.png"},
  {fa:"Ú©Ù…", en:"a little", translit:"kam", emoji:"ğŸ”…", audio:"audio/kam.mp3", image:"images/kam.png"},
  {fa:"Ù‡Ù…ÛŒØ´Ù‡", en:"always", translit:"hamishe", emoji:"â™¾ï¸", audio:"audio/hamishe.mp3", image:"images/hamishe.png"},
  {fa:"Ú¯Ø§Ù‡ÛŒ", en:"sometimes", translit:"gÃ¢hi", emoji:"ğŸ”„", audio:"audio/gahi.mp3", image:"images/gahi.png"},
  {fa:"Ù‡ÛŒÚ†ÙˆÙ‚Øª", en:"never", translit:"hichvaqt", emoji:"ğŸš«", audio:"audio/hichvaqt.mp3", image:"images/hichvaqt.png"},
  {fa:"Ø§Ù…Ø³Ø§Ù„", en:"this year", translit:"emsÃ¢l", emoji:"ğŸ“…", audio:"audio/emsal.mp3", image:"images/emsal.png"},
  {fa:"Ø³Ø§Ø¹Øª Ú†Ù†Ø¯ Ø§Ø³ØªØŸ", en:"what time is it?", translit:"sÃ¢â€™at chand ast?", emoji:"â°", audio:"audio/saatchandast.mp3", image:"images/saatchandast.png"},
  {fa:"Ø­Ø§Ù„Øª Ú†Ø·ÙˆØ± Ø§Ø³ØªØŸ", en:"how are you?", translit:"hÃ¢let chetur ast?", emoji:"ğŸ™‚", audio:"audio/haletcheturast.mp3", image:"images/haletcheturast.png"},
  {fa:"Ø®ÙˆØ¨Ù…", en:"Iâ€™m good", translit:"khubam", emoji:"ğŸ˜Š", audio:"audio/khubam.mp3", image:"images/khubam.png"},
  {fa:"Ø¨Ø¯ Ù†ÛŒØ³ØªÙ…", en:"Iâ€™m okay", translit:"bad nistam", emoji:"ğŸ˜Œ", audio:"audio/badnistam.mp3", image:"images/badnistam.png"},
  {fa:"Ø®Ø³ØªÙ‡â€ŒØ§Ù…", en:"Iâ€™m tired", translit:"khasteam", emoji:"ğŸ˜´", audio:"audio/khasteam.mp3", image:"images/khasteam.png"},
  {fa:"Ú¯Ø±Ø³Ù†Ù‡â€ŒØ§Ù…", en:"Iâ€™m hungry", translit:"gorsneam", emoji:"ğŸ½ï¸", audio:"audio/gorsneam.mp3", image:"images/gorsneam.png"},
  {fa:"ØªØ´Ù†Ù‡â€ŒØ§Ù…", en:"Iâ€™m thirsty", translit:"tashneam", emoji:"ğŸ¥¤", audio:"audio/tashneam.mp3", image:"images/tashneam.png"},
  {fa:"Ø¨Ù„Ù‡ØŒ Ø­ØªÙ…Ø§Ù‹", en:"yes, of course", translit:"bale hatman", emoji:"âœ…", audio:"audio/bale_hatman.mp3", image:"images/bale_hatman.png"},
  {fa:"Ù†Ù‡ØŒ Ù…ØªØ´Ú©Ø±Ù…", en:"no, thank you", translit:"na moteshakeram", emoji:"ğŸ™…", audio:"audio/na_moteshakeram.mp3", image:"images/na_moteshakeram.png"},
];

/* ===================== THEMES ===================== */
const THEMES = [
 {key:'default', name:'Ocean (default)', unlockAt:0, vars:{'--grad1':'#0b1229','--grad2':'#121a36','--accent-2':'#38bdf8','--accent':'#22c55e','--bg':'#0f172a'}},
 {key:'sunset', name:'Sunset', unlockAt:50, vars:{'--grad1':'#2a0f1b','--grad2':'#3a1f2a','--accent-2':'#fb923c','--accent':'#f59e0b','--bg':'#1a0c12'}},
 {key:'mint', name:'Mint', unlockAt:100,vars:{'--grad1':'#0d1f1a','--grad2':'#123227','--accent-2':'#34d399','--accent':'#10b981','--bg':'#0b1814'}},
 {key:'amethyst',name:'Amethyst', unlockAt:150,vars:{'--grad1':'#1b1330','--grad2':'#2a1f4d','--accent-2':'#a78bfa','--accent':'#8b5cf6','--bg':'#130f24'}},
 {key:'night', name:'Night Bazaar', unlockAt:200,vars:{'--grad1':'#0a0a0f','--grad2':'#15151f','--accent-2':'#60a5fa','--accent':'#22d3ee','--bg':'#0a0b12'}}
];
function applyTheme(key){
  const t = THEMES.find(x=>x.key===key) || THEMES[0];
  for(const [k,v] of Object.entries(t.vars)) document.documentElement.style.setProperty(k, v);
  state.theme = t.key; persist();
}
function learnedCount(){ return (state.covered||[]).length; }
function isThemeUnlocked(theme){ return learnedCount() >= theme.unlockAt; }
function nextUnlockNote(){
  const learned = learnedCount();
  const next = THEMES.find(t=>t.unlockAt>learned);
  return next ? `Next theme unlocks at <b>${next.unlockAt}</b> learned. (You: ${learned})` : `All themes unlocked! ğŸ‰ (You: ${learned})`;
}
function populateThemeDropdown(){
  const sel = $('themeSelect'); if(!sel) return;
  sel.innerHTML='';
  THEMES.forEach(t=>{
    const opt=document.createElement('option');
    opt.value=t.key;
    const locked = !isThemeUnlocked(t);
    opt.textContent = locked ? `${t.name} â€” locked (needs ${t.unlockAt})` : t.name;
    opt.disabled = locked;
    if((state.theme||'default')===t.key) opt.selected=true;
    sel.appendChild(opt);
  });
  const note = $('themeNote'); if(note) note.innerHTML = nextUnlockNote();
}

/* ===================== POSTCARDS DATA ===================== */
const POSTCARDS = [
  { id:'persepolis', title:'Persepolis (Takht-e Jamshid)', en:'Persepolis: the ceremonial capital of the Achaemenids is a symbol of the splendor of ancient Iranian art and history.', image:'images/postcards/persepolis.jpg', emoji:'ğŸ›ï¸' },
  { id:'azadi_tower', title:'Tehran â€” Azadi Tower', en:'Azadi Tower: an icon of Tehranâ€”blends traditional Persian forms with modern lines.', image:'images/postcards/azadi_tower.jpg', emoji:'ğŸ—¼' },
  { id:'naqsh_e_jahan', title:'Isfahan â€” Naqsh-e Jahan Square', en:'Naqsh-e Jahan: Squareâ€”turquoise domes and a living bazaarâ€”the beating heart of Isfahan.', image:'images/postcards/naqsh_e_jahan.jpg', emoji:'ğŸ•Œ' },
  { id:'yazd', title:'Yazd â€” Historic City & Windcatchers', en:'The historic city of Yazdâ€”windcatchers, adobe lanes, and desert skiesâ€”is a UNESCO World Heritage site.', image:'images/postcards/yazd.jpg', emoji:'ğŸœï¸' },
  { id:'shiraz', title:'Shiraz â€” City of Poetry & Gardens', en:'Shiraz: the city of poetry and gardensâ€”home to Hafez and Saadi, scented with spring orange blossoms.', image:'images/postcards/shiraz.jpg', emoji:'ğŸŒ¸' },
  { id:'golestan_palace', title:'Tehran â€” Golestan Palace', en:'Golestan Palace: a Qajar-era complex with mirror halls and exquisite tilework in the heart of Tehran.', image:'images/postcards/golestan_palace.jpg', emoji:'ğŸ›ï¸' },
  { id:'babol', title:'Babol â€” City of Orange Blossoms', en:'Babol: city of orange blossoms and riversâ€”the gateway to the lush Hyrcanian forests.', image:'images/postcards/babol.jpg', emoji:'ğŸŠ' },
  { id:'mount_damavand', title:'Mount Damavand', en:'Mount Damavand: the highest peak in Iran, a dormant volcano and a powerful symbol in Persian mythology.', image:'images/postcards/mount-damavand.jpg', emoji:'â›°ï¸' },
  { id:'lut_desert', title:'Lut Desert (Dasht-e Lut)', en:'The Lut Desert: otherworldly sand dunes, salt plains, and the hottest recorded surface temperatures on Earth.', image:'images/postcards/lut_desert.jpg', emoji:'ğŸœï¸' },
  { id:'kerman', title:'Kerman â€” Ganjali Khan Complex', en:'Kerman: home to the Ganjali Khan complex, bustling bazaars, and the gateway to Iranâ€™s great deserts.', image:'images/postcards/kerman.jpg', emoji:'ğŸ•Œ' },
  { id:'sana_hostel', title:'Sana Historical Hostel', en:'Sana Historical Hostel: a restored Persian house with courtyards and arches, offering timeless Yazd hospitality.', image:'images/postcards/sana_hostel.jpg', emoji:'ğŸ¡' },
  { id:'kavir_national_park', title:'Kavir National Park', en:'Kavir National Park: the â€œLittle Africaâ€ of Iran, desert landscapes with wildlife from cheetahs to gazelles.', image:'images/postcards/kavir_national_park.jpg', emoji:'ğŸ†' },
  { id:'khaju_bridge', title:'Isfahan â€” Khaju Bridge', en:'Khaju Bridge: a masterpiece of Safavid engineering, where arches echo with music and poetry over the Zayanderud.', image:'images/postcards/khaju_bridge.jpg', emoji:'ğŸŒ‰' },
  { id:'chahkooh_canyon', title:'Chahkooh Canyon â€” Qeshm Island', en:'Chahkooh Canyon: sculpted sandstone gorges and narrow passages carved by time on Qeshm Island.', image:'images/postcards/chahkooh_canyon.jpg', emoji:'ğŸª¨' },
  { id:'hormuz_island', title:'Hormuz Island â€” Red Beach', en:'Hormuz Island: vivid red beaches and rainbow mountainsâ€”an island of surreal colours in the Persian Gulf.', image:'images/postcards/hormuz_island.jpg', emoji:'ğŸ–ï¸' }
];

/* ===================== UTILITIES ===================== */
const $=id=>document.getElementById(id);
const bySel=s=>document.querySelector(s);
function now(){return Date.now()}
function todayISO(){const d=new Date();d.setHours(0,0,0,0);return d.toISOString().slice(0,10)}
function normalizeTranslit(s){return (s||'').toLowerCase().normalize('NFKD').replace(/[\u0302\u0304]/g,'').replace(/[^a-z0-9]+/g,'').trim()}
function normalizeFa(s){return (s||'').replace(/\s+/g,'').replace(/ÙŠ/g,'ÛŒ').replace(/Ùƒ/g,'Ú©').replace(/[\u200C\u200F\u202A-\u202E]/g,'')}
function shuffle(a){ for(let i=a.length-1;i>0;i++){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j]]} return a }
const isMobile = () => window.matchMedia('(max-width:700px)').matches || /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
function maybeFocusInput(){ if(!isMobile()) $('typeInput').focus(); }
function setImageWithFallback(imgEl, emojiEl, item){
  if(!imgEl) return;
  const useEmoji = ()=>{
    if(imgEl){ imgEl.style.display='none'; imgEl.removeAttribute('src'); }
    if(emojiEl){ emojiEl.style.display='block'; emojiEl.textContent = item.emoji || 'â“'; }
  };
  if(item.image){
    if(emojiEl) emojiEl.style.display='none';
    imgEl.onerror = useEmoji;
    imgEl.onload = ()=>{ imgEl.style.display='block'; if(emojiEl) emojiEl.style.display='none'; };
    imgEl.alt = item.en || '';
    imgEl.src = item.image;
    imgEl.style.display='block';
  }else{
    useEmoji();
  }
}

/* ===================== STATE (per profile) ===================== */
const defaultState = ()=>({
  score:0, streak:0, srs:{}, covered:[], start_date:null, unlocked_count:0,
  achievements:{first10:false,perfectMini:false,streak7:false,mastered50:false}, achFx:{},
  mapUnlocked:0, mapDays:[],
  settings:{reviewAll:false, musicOn:false, musicVol:0.28},
  theme:'default',
  inventory:{fish:0, catnip:0, nameTokens:0},
  furniture:{catTree:false, catToy:false, catBowl:false},
  catNames:{}, nameCursor:-1, showCatNames:false
});
let state = defaultState();

let mode='learn', order=[], idx=0;
let sessionTotal = 0;
let sessionAnswered = new Set();
function resetSessionProgress(){ sessionTotal = unlockedCount(); sessionAnswered = new Set(); updateSessionBar(); }
function updateSessionBar(){ const pct = Math.round((sessionAnswered.size/Math.max(1,sessionTotal))*100); $('progressBar').style.width = pct + '%'; }

/* SRS helpers */
function ensureSRS(i){ if(!state.srs[i]) state.srs[i]={stage:0,due:0,seen:0,correct:0,wrong:0}; return state.srs[i]; }
function isDue(i){ return ensureSRS(i).due <= now(); }
function scheduleAfter(i,h){ ensureSRS(i).due = now()+h*3600*1000; }
function getCoveredSet(){ return new Set(state.covered||[]); }
function addCovered(i){ const s=getCoveredSet(); s.add(i); state.covered=[...s]; persist(); }

/* Cats unlocked from milestones */
function computeCatsUnlocked(){ const learned = learnedCount(); return CAT_UNLOCK_THRESHOLDS.filter(t => learned >= t).length; }

function initDailyUnlock(){
  if(!state.start_date){ state.start_date=todayISO(); }
  const startDate = new Date(state.start_date+'T00:00:00');
  const dNow = new Date(); dNow.setHours(0,0,0,0);
  const diffDays = Math.floor((dNow - startDate)/86400000);
  const shouldUnlock = Math.min(words.length, (diffDays+1)*DAILY_WORDS);
  state.unlocked_count = Math.max(state.unlocked_count||0, shouldUnlock);
  persist();
}
function unlockedCount(){ return state.unlocked_count||Math.min(words.length, DAILY_WORDS); }
function unlockedIndices(){ return [...Array(unlockedCount()).keys()]; }
function masteredIndices(){ return [...getCoveredSet()].filter(i=>i<unlockedCount()); }
function dueIndices(){ return unlockedIndices().filter(i=>isDue(i)); }
function quizPool(){ const due=dueIndices(); if(due.length) return due; const m=masteredIndices(); return m.length?m:unlockedIndices(); }
function learnPool(){ const u=unlockedIndices(), due=u.filter(i=>isDue(i)), rest=u.filter(i=>!isDue(i)); return [...due,...rest]; }

/* ===================== PERSIST ===================== */
function persist(){
  state.mapUnlocked = computeCatsUnlocked();
  store.set('state', state);
  reflectBadges();
  updateBadges();
  renderMap();
  renderFurniture();
  populateThemeDropdown();
  updateShopUI();
  updateNamesToggleUI();
  updateNamesVisibility();
  if($('postcardsModal')?.style.display==='grid'){ renderPostcardsGrid(); const u=postcardsUnlockedCount(); renderPostcardView(u?u-1:-1); }
  if($('dictModal')?.style.display==='grid'){ ensureDictScrollWrapper(); renderDictionary(); }
}
function loadState(){
  state = store.get('state', defaultState());
  if(!state.inventory) state.inventory = {fish:0, catnip:0, nameTokens:0};
  if(state.inventory.fish===undefined) state.inventory.fish=0;
  if(state.inventory.catnip===undefined) state.inventory.catnip=0;
  if(state.inventory.nameTokens===undefined) state.inventory.nameTokens=0;
  if(!state.furniture) state.furniture = {catTree:false, catToy:false, catBowl:false};
  if(state.furniture.catTree===undefined) state.furniture.catTree=false;
  if(state.furniture.catToy===undefined)  state.furniture.catToy=false;
  if(state.furniture.catBowl===undefined) state.furniture.catBowl=false;
  if(!state.catNames) state.catNames = {};
  if(typeof state.nameCursor!=='number') state.nameCursor = -1;
  if(typeof state.showCatNames!=='boolean') state.showCatNames = false;
  if(!state.achievements) state.achievements = defaultState().achievements;
  if(!state.settings) state.settings = {reviewAll:false, musicOn:false, musicVol:0.28};
  if(typeof state.settings.musicOn!=='boolean') state.settings.musicOn=false;
  if(typeof state.settings.musicVol!=='number') state.settings.musicVol=0.28;
  state.achFx = state.achFx || {};
  initDailyUnlock();
  applyTheme(state.theme||'default');
  state.mapUnlocked = computeCatsUnlocked();
}

/* ======== NICOLE SYNC ======== */
const SYNC_ENDPOINT = "https://ff-sync.9rmcqs6hjc.workers.dev";
const SYNC_DOC_ID = "nicole";
const SYNC_WRITE_TOKEN = "Gravity123!!";
function mergeStates(local, remote){
  if(!remote || !remote.updated_at) return local;
  const lts = local?.updated_at || 0;
  const rts = remote?.updated_at || 0;
  const base = (lts >= rts) ? {...local} : {...remote};
  const ls = local?.start_date, rs = remote?.start_date;
  const earliestStart = (ls && rs) ? (ls < rs ? ls : rs) : (ls || rs || todayISO());
  base.start_date = earliestStart;
  const dNow = new Date(); dNow.setHours(0,0,0,0);
  const sDate = new Date(earliestStart + 'T00:00:00');
  const diffDays = Math.floor((dNow - sDate)/86400000);
  const shouldUnlock = Math.min(words.length, (diffDays + 1) * DAILY_WORDS);
  const localUnlocked  = local?.unlocked_count  || 0;
  const remoteUnlocked = remote?.unlocked_count || 0;
  base.unlocked_count = Math.max(localUnlocked, remoteUnlocked, shouldUnlock);
  const cov = new Set([...(local.covered||[]), ...(remote.covered||[])]); base.covered = [...cov];
  base.score  = Math.max(local.score||0, remote.score||0);
  base.streak = (lts >= rts ? local.streak : remote.streak) || 0;
  base.inventory = {
    fish:      Math.max(local.inventory?.fish||0,      remote.inventory?.fish||0),
    catnip:    Math.max(local.inventory?.catnip||0,    remote.inventory?.catnip||0),
    nameTokens:Math.max(local.inventory?.nameTokens||0,remote.inventory?.nameTokens||0)
  };
  base.furniture = {
    catTree: !!(local.furniture?.catTree || remote.furniture?.catTree),
    catToy:  !!(local.furniture?.catToy  || remote.furniture?.catToy),
    catBowl: !!(local.furniture?.catBowl || remote.furniture?.catBowl)
  };
  base.catNames   = (lts >= rts ? {...(local.catNames||{})} : {...(remote.catNames||{})});
  base.nameCursor = (lts >= rts ? (local.nameCursor??-1)    : (remote.nameCursor??-1));
  base.achievements = {...(local.achievements||{}), ...(remote.achievements||{})};
  base.achFx        = {...(local.achFx||{}),        ...(remote.achFx||{})};
  base.showCatNames = (lts >= rts ? !!local.showCatNames : !!remote.showCatNames);
  return base;
}
async function syncPullNicole(){
  if(!SYNC_ENDPOINT || ACTIVE_PROFILE!=="Nicole") return;
  try{
    const res = await fetch(`${SYNC_ENDPOINT}/p/${SYNC_DOC_ID}`);
    const remote = await res.json().catch(()=>null);
    if(remote && Object.keys(remote).length){
      state = mergeStates(state, remote);
      _persist();
    }
  }catch{}
}
async function syncPushNicole(){
  if(!SYNC_ENDPOINT || ACTIVE_PROFILE!=="Nicole") return;
  try{
    const payload = JSON.stringify({...state, updated_at: Date.now(), profile: ACTIVE_PROFILE});
    await fetch(`${SYNC_ENDPOINT}/p/${SYNC_DOC_ID}`, {
      method:"PUT", headers:{ "Content-Type":"application/json", ...(SYNC_WRITE_TOKEN?{"X-Token":SYNC_WRITE_TOKEN}:{}) }, body:payload
    });
  }catch{}
}
let _persist = persist, _syncTimer=null;
function syncPushDebouncedNicole(){ clearTimeout(_syncTimer); _syncTimer=setTimeout(syncPushNicole,600); }
persist = function(){ _persist(); if(ACTIVE_PROFILE==="Nicole") syncPushDebouncedNicole(); };
function initSharedNicoleSync(){
  if (ACTIVE_PROFILE !== "Nicole" || !SYNC_ENDPOINT) return;
  syncPullNicole().then(()=>syncPushNicole());
  document.addEventListener("visibilitychange", ()=>{ if(document.visibilityState==="visible" && ACTIVE_PROFILE==="Nicole") syncPullNicole(); });
  window.addEventListener("online", ()=>{ if(ACTIVE_PROFILE==="Nicole") syncPushNicole(); });
}

/* ===================== UI UPDATE ===================== */
function updateBadges(){
  $('profileBadge').textContent = `Profile: ${ACTIVE_PROFILE||'â€”'}`;
  $('scoreBadge').textContent   = `Score: ${state.score}`;
  $('streakBadge').textContent  = `Streak: ${state.streak} ğŸ”¥`;
  $('unlockedBadge').textContent= `${unlockedCount()}/${words.length} unlocked`;
  updateSessionBar();
}
function reflectBadges(){
  const A = state.achievements || {};
  const defs = [
    {key:'first10', label:'First 10 mastered', ico:'ğŸ¥‡'},
    {key:'perfectMini', label:'Perfect Mini Quiz', ico:'ğŸ¯'},
    {key:'streak7', label:'7-day streak', ico:'ğŸ…'},
    {key:'mastered50', label:'50 mastered', ico:'ğŸ’ª'}
  ];
  const box = $('achList');
  box.classList.add('badges-grid');
  box.innerHTML = '';
  defs.forEach(d=>{
    const el = document.createElement('div');
    el.className = 'badge-tile' + (A[d.key] ? ' earned' : '');
    el.dataset.key = d.key;
    el.innerHTML = `<div class="ico">${A[d.key]?d.ico:'â¬œ'}</div><div class="label">${d.label}</div>`;
    box.appendChild(el);
  });
}

/* ===================== ROAMING CATS ===================== */
const CAT_EMOJIS = ['ğŸˆ','ğŸˆâ€â¬›','ğŸ±'];
let cats = []; let catAnim = { running:false, lastTs:0, bounds:null }; let flashNamesUntil = 0;
function getCatName(i){ return state.catNames && state.catNames[i] ? state.catNames[i] : `Cat ${i+1}`; }
function getNextCatIndex(){
  const n = state.mapUnlocked||0; if(n<=0) return 0;
  const cur = (typeof state.nameCursor==='number' ? state.nameCursor : -1);
  return (cur + 1) % n;
}
function spawnCats(count){
  const layer = $('catLayer'); if(!layer) return;
  layer.innerHTML = ''; cats = [];
  const rect = layer.getBoundingClientRect();
  catAnim.bounds = { w: rect.width, h: rect.height, pad: 6 };
  for(let i=0;i<count;i++){
    const el = document.createElement('div'); el.className = 'cat';
    const inner = document.createElement('span'); inner.className = 'cat-emoji'; inner.textContent = CAT_EMOJIS[i % CAT_EMOJIS.length]; el.appendChild(inner);
    const label = document.createElement('div'); label.className = 'cat-name'; label.textContent = getCatName(i); el.appendChild(label);
    el.title = getCatName(i); $('catLayer').appendChild(el);
    const speed = 30 + Math.random()*50; const angle = Math.random()*Math.PI*2;
    const vx = Math.cos(angle)*speed, vy = Math.sin(angle)*speed;
    const x = Math.random()*(catAnim.bounds.w-40), y = Math.random()*(catAnim.bounds.h-40);
    const c = { el, label, x, y, vx, vy, speed, idx:i, nextTurn: performance.now()+800+Math.random()*1600, turnMult:1 };
    cats.push(c); el.style.left = x + 'px'; el.style.top = y + 'px'; if(vx<0) el.classList.add('flip');
    if(catnipActive){ applyCatnipToCat(c); }
  }
  updateNamesVisibility();
}
function stepCats(ts){
  if(!catAnim.running) return;
  const dt = Math.min(0.04, (ts - catAnim.lastTs)/1000); catAnim.lastTs = ts; const B = catAnim.bounds;
  for(const c of cats){
    if(ts > c.nextTurn){
      const dTheta = (Math.random()-0.5) * (Math.PI/3);
      const angle = Math.atan2(c.vy, c.vx) + dTheta;
      const sp = Math.max(20, Math.min(90, c.speed + (Math.random()-0.5)*20));
      c.speed = sp; c.vx = Math.cos(angle)*c.speed; c.vy = Math.sin(angle)*c.speed;
      const base = 800 + Math.random()*1600; c.nextTurn = ts + base * (c.turnMult || 1);
    }
    c.x += c.vx * dt; c.y += c.vy * dt;
    const r = 6;
    if(c.x < r){ c.x=r; c.vx = Math.abs(c.vx); }
    if(c.y < r){ c.y=r; c.vy = Math.abs(c.vy); }
    if(c.x > B.w-40-r){ c.x=B.w-40-r; c.vx = -Math.abs(c.vx); }
    if(c.y > B.h-40-r){ c.y=B.h-40-r; c.vy = -Math.abs(c.vy); }
    if(c.vx < 0) c.el.classList.add('flip'); else c.el.classList.remove('flip');
    c.el.style.left = c.x + 'px'; c.el.style.top = c.y + 'px';
  }
  updateNamesVisibility(); requestAnimationFrame(stepCats);
}
function startCats(){ const count = Math.max(0, state.mapUnlocked || 0); if(count<=0){ stopCats(); return; } spawnCats(count); catAnim.running = true; catAnim.lastTs = performance.now(); requestAnimationFrame(stepCats); window.addEventListener('resize', onResizeCats); }
function stopCats(){ catAnim.running = false; const layer = $('catLayer'); if(layer) layer.innerHTML=''; cats = []; window.removeEventListener('resize', onResizeCats); }
function onResizeCats(){
  if(!catAnim.running) return; const layer = $('catLayer'); const rect = layer.getBoundingClientRect();
  catAnim.bounds = { w: rect.width, h: rect.height, pad: 6 };
  for(const c of cats){ c.x = Math.max(6, Math.min(c.x, catAnim.bounds.w-40-6)); c.y = Math.max(6, Math.min(c.y, catAnim.bounds.h-40-6)); }
}
function boostCatsFor(ms, factor=1.6){
  for(const c of cats){ const angle = Math.atan2(c.vy, c.vx); c.speed *= factor; c.vx = Math.cos(angle)*c.speed; c.vy = Math.sin(angle)*c.speed; }
  setTimeout(()=>{ for(const c of cats){ const angle = Math.atan2(c.vy, c.vx); c.speed /= factor; c.vx = Math.cos(angle)*c.speed; c.vy = Math.sin(angle)*c.speed; } }, ms);
}
function burstHearts(count=24){
  const layer = $('catLayer'); if(!layer) return;
  const B = catAnim.bounds || layer.getBoundingClientRect(); const groups = cats.length ? cats : [{x:B.w/2, y:B.h-30}];
  for(const c of groups){ const n = Math.ceil(count / groups.length);
    for(let i=0;i<n;i++){ const span = document.createElement('span'); span.className = 'heart'; span.textContent = 'â¤ï¸';
      const jx = (Math.random()*40-20), jy = (Math.random()*20-10);
      span.style.left = (c.x + 20 + jx) + 'px'; span.style.top = (c.y + jy) + 'px'; layer.appendChild(span); setTimeout(()=>span.remove(), 1700);
    }
  }
}
function burstLeaves(count=36){
  const layer = $('catLayer'); if(!layer) return;
  const B = catAnim.bounds || layer.getBoundingClientRect(); const groups = cats.length ? cats : [{x:B.w/2, y:B.h-30}];
  for(const c of groups){ const n = Math.ceil(count / groups.length);
    for(let i=0;i<n;i++){ const span = document.createElement('span'); span.className = 'leaf'; span.textContent = 'ğŸŒ¿';
      const jx = (Math.random()*60-30), jy = (Math.random()*30-15);
      span.style.left = (c.x + 20 + jx) + 'px'; span.style.top = (c.y + jy) + 'px'; layer.appendChild(span); setTimeout(()=>span.remove(), 2300);
    }
  }
}

/* ===================== SENTENCE PRACTICE / MINI QUIZ / AUDIO QUIZ ===================== */
let sentenceIdx = 0;
function renderSentence(){
  if(!SENTENCES.length){ $('sentFa').textContent='â€”'; $('sentTrans').textContent=''; $('sentEn').textContent='No sentences available yet.'; $('sentProgress').textContent=''; return; }
  if(sentenceIdx < 0) sentenceIdx = SENTENCES.length - 1;
  if(sentenceIdx >= SENTENCES.length) sentenceIdx = 0;
  const s = SENTENCES[sentenceIdx];
  $('sentFa').textContent = s.fa; $('sentTrans').textContent = s.translit; $('sentEn').textContent = s.en;
  $('sentProgress').textContent = `${sentenceIdx+1} / ${SENTENCES.length}`;
}
function openSentences(){ sentenceIdx=0; renderSentence(); $('sentencesModal').style.display='grid'; }

let miniQ={queue:[],current:null,correct:0,total:0}, MINI_ACTIVE=false;
function endMiniQuiz(){ MINI_ACTIVE=false; $('miniQuizModal').style.display='none'; $('mqInput').value=''; $('mqFeedback').textContent=''; $('mqBar').style.width='0%'; }
$('startMiniQuiz').addEventListener('click', ()=>{
  $('settingsModal').style.display='none';
  const pool=[...new Set([...quizPool(), ...masteredIndices(), ...unlockedIndices()])]; shuffle(pool);
  miniQ={queue:pool.slice(0,MINI_QUIZ_SIZE),current:null,correct:0,total:0};
  MINI_ACTIVE=true; $('miniQuizModal').style.display='grid'; nextMiniQuestion();
});
function nextMiniQuestion(){
  if(!MINI_ACTIVE) return;
  if(!miniQ.queue.length){
    $('mqFeedback').innerHTML=`Mini Quiz complete! Score: <b>${miniQ.correct}</b> / ${miniQ.total}`;
    $('mqBar').style.width='100%';
    if(miniQ.correct === MINI_QUIZ_SIZE){ awardAchievement('perfectMini'); }
    setTimeout(()=>{ endMiniQuiz(); showItem(); }, 1200);
    return;
  }
  miniQ.current = miniQ.queue.shift();
  const item=words[miniQ.current];
  setImageWithFallback($('mqPic'), $('mqEmoji'), item);
  $('mqInput').value=''; $('mqFeedback').textContent=''; $('mqBar').style.width = `${(miniQ.total/MINI_QUIZ_SIZE)*100}%`; $('mqInput').focus();
}
$('mqCheck').addEventListener('click', ()=>{
  if(!MINI_ACTIVE) return;
  const item=words[miniQ.current];
  miniQ.total++;
  const ok = normalizeTranslit($('mqInput').value)===normalizeTranslit(item.translit);
  if(ok){ miniQ.correct++; $('mqFeedback').textContent='Nice!'; $('mqFeedback').className='feedback ok'; celebrateSimple(); }
  else{ $('mqFeedback').textContent='Answer: ' + item.translit; $('mqFeedback').className='feedback warn'; state.streak=0; persist(); }
  setTimeout(nextMiniQuestion, 350);
});
$('mqInput').addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); $('mqCheck').click(); } });
$('mqQuit').addEventListener('click', ()=> endMiniQuiz());

let AQ = {queue:[], current:-1, answer:-1, total:0, correct:0, locked:false};
function endAudioQuiz(){ $('audioQuizModal').style.display='none'; AQ={queue:[], current:-1, answer:-1, total:0, correct:0, locked:false}; $('aqFeedback').textContent=''; $('aqBar').style.width='0%'; $('aqOptions').innerHTML=''; }
function openAudioQuiz(){
  const pool = unlockedIndices(); if(pool.length < 4){ alert('Unlock at least 4 items to play Audio Quiz.'); return; }
  const qCount = Math.min(AUDIO_QUIZ_SIZE, pool.length); const shuffled = shuffle(pool.slice());
  AQ.queue = shuffled.slice(0, qCount); AQ.total = 0; AQ.correct = 0; AQ.locked = false;
  $('audioQuizModal').style.display='grid'; nextAQQuestion();
}
function randomDistractors(correctIdx, pool, n=3){ const others = pool.filter(i=>i!==correctIdx); shuffle(others); return others.slice(0, Math.min(n, others.length)); }
function nextAQQuestion(){
  if(!AQ.queue.length){ $('aqFeedback').innerHTML = `Audio Quiz complete! Score: <b>${AQ.correct}</b> / ${AUDIO_QUIZ_SIZE}`; $('aqBar').style.width = '100%'; setTimeout(()=> endAudioQuiz(), 1200); return; }
  AQ.locked = false; AQ.current = AQ.queue.shift();
  const correctItem = words[AQ.current]; const pool = unlockedIndices(); const distractors = randomDistractors(AQ.current, pool, 3); const choices = shuffle([AQ.current, ...distractors]);
  AQ.answer = choices.indexOf(AQ.current);
  const box = $('aqOptions'); box.innerHTML='';
  choices.forEach(idx=>{
    const item = words[idx];
    const btn = document.createElement('button'); btn.className = 'aq-option'; btn.type = 'button'; btn.dataset.idx = String(idx); btn.setAttribute('aria-label', item.en||'');
    const img = document.createElement('img'); const emoji = document.createElement('div'); emoji.className = 'aq-emoji'; emoji.style.display='none'; emoji.textContent = item.emoji || 'â“';
    btn.appendChild(img); btn.appendChild(emoji); setImageWithFallback(img, emoji, item);
    btn.addEventListener('click', onAQOptionClick); box.appendChild(btn);
  });
  $('aqFeedback').textContent=''; $('aqBar').style.width = `${(AQ.total / Math.max(1, AUDIO_QUIZ_SIZE)) * 100}%`;
  try{ const a=getAudio(correctItem); a.currentTime=0; a.play(); }catch{}
}
function onAQOptionClick(e){
  if (AQ.locked) return; AQ.locked = true;
  const pickedIdx = parseInt(e.currentTarget.dataset.idx, 10); const isCorrect = (pickedIdx === AQ.current);
  AQ.total++;
  if (isCorrect){
    const pts = 10; // Audio quiz keeps the original 10 points
    e.currentTarget.classList.add('correct'); $('aqFeedback').textContent = `Nice! +${pts} points`; $('aqFeedback').className = 'feedback ok'; celebrateSimple();
    AQ.correct++; state.score += pts; persist();
  }else{
    e.currentTarget.classList.add('wrong'); $('aqFeedback').textContent = `Answer: ${words[AQ.current].en}`; $('aqFeedback').className = 'feedback warn';
    Array.from($('aqOptions').children).forEach(btn=>{ const idx = parseInt(btn.dataset.idx,10); if(idx === AQ.current) btn.classList.add('correct'); });
    state.streak = 0; persist();
  }
  $('aqBar').style.width = `${(AQ.total / Math.max(1, AUDIO_QUIZ_SIZE)) * 100}%`; setTimeout(nextAQQuestion, 600);
}
$('aqPlay').addEventListener('click', ()=>{ if(AQ.current<0) return; const item = words[AQ.current]; try{ const a=getAudio(item); a.currentTime=0; a.play(); }catch{} });

/* ===================== CELEBRATIONS & BADGE HELPERS ===================== */
function happyDing(){ try{
  const AC=window.AudioContext||window.webkitAudioContext;if(!AC) return;const ctx=new AC();const tones=[659,784,988];const t0=ctx.currentTime;
  tones.forEach((f,i)=>{const o=ctx.createOscillator(),g=ctx.createGain();o.type='sine';o.frequency.value=f;o.connect(g);g.connect(ctx.destination);
  const st=t0+i*0.05;g.gain.setValueAtTime(0,st);g.gain.linearRampToValueAtTime(0.35,st+0.03);g.gain.exponentialRampToValueAtTime(0.0001,st+0.22);
  o.start(st);o.stop(st+0.25);});
}catch{} }
function confettiPop(){ if(window.confetti) confetti({origin:{y:1,x:0.5},gravity:1.2,ticks:180,scalar:0.9,particleCount:70,spread:75,startVelocity:55}); }
function fireworks(){
  if(!window.confetti) return;
  const base={origin:{y:1,x:0.5},gravity:1.0,ticks:260,scalar:1.0};
  confetti({...base,particleCount:180,spread:120,startVelocity:65});
  confetti({...base,particleCount:140,spread:140,startVelocity:60,origin:{y:1,x:0.2}});
  confetti({...base,particleCount:140,spread:140,startVelocity:60,origin:{y:1,x:0.8}});
}
function celebrateSimple(){
  happyDing(); confettiPop();
  const c=$('celebration'); c.textContent="let's goooooo ğŸ‰"; c.style.display='block';
  setTimeout(()=>c.classList.add('fade-out'),800);
  setTimeout(()=>{c.classList.remove('fade-out'); c.style.display='none';},1600);
}
function ensureAchFx(){ if(!state.achFx) state.achFx = {}; return state.achFx; }
function sparkleBadgeOnce(key){
  const fx = ensureAchFx(); if(fx[key]) return; fx[key] = true;
  const el = bySel(`.badge-tile[data-key="${key}"]`); if(el){ el.classList.add('sparkle'); if(window.confetti) confetti({particleCount:60, spread:65, startVelocity:45, scalar:0.9}); setTimeout(()=>el && el.classList.remove('sparkle'), 1200); }
}
function awardAchievement(key){ if(!state.achievements[key]){ state.achievements[key] = true; persist(); sparkleBadgeOnce(key); } else { persist(); } }
function celebrateStreak7(){ fireworks(); awardAchievement('streak7'); const c=$('celebration'); c.textContent="7-day streak! ğŸ…"; c.style.display='block'; setTimeout(()=>c.classList.add('fade-out'),1200); setTimeout(()=>{c.classList.remove('fade-out'); c.style.display='none';},2200); }

/* ===================== AUDIO (word audio cache) ===================== */
const audioCache=new Map();
function getAudio(item){
  const url=item.audio||`audio/${(item.translit||'').toLowerCase()}.mp3`;
  if(!audioCache.has(url)){const a=new Audio();a.preload='auto';a.src=url;audioCache.set(url,a);}
  return audioCache.get(url);
}
async function playYourAudio(){ const gi=order[idx], item=words[gi]; try{ const a=getAudio(item); a.currentTime=0; await a.play(); }catch{} }

/* ===================== SPEECH RECOG ===================== */
let SR=null;
function levenshtein(a,b){const m=a.length,n=b.length,dp=Array.from({length:m+1},()=>Array(n+1).fill(0));for(let i=0;i<=m;i++)dp[i][0]=i;for(let j=0;j<=n;j++)dp[0][j]=j;for(let i=1;i<=m;i++){for(let j=1;j<=n;j++){const c=a[i-1]===b[j-1]?0:1;dp[i][j]=Math.min(dp[i-1][j]+1,dp[i][j-1]+1,dp[i-1][j-1]+c)}}return dp[m][n]}
function closeEnough(a,b){if(!a||!b)return false;if(a===b)return true;return levenshtein(a,b)<=1}
function hasPersian(s){return /[\u0600-\u06FF]/.test(s||'')}
function normalizeSRTranslit(s){return (s||'').toLowerCase().replace(/[^a-z0-9]+/g,'')}
function initSpeech(){
  const SRClass = window.SpeechRecognition || window.webkitSpeechRecognition;
  const btn = $('sayBtn');
  if(!SRClass){ btn.disabled=true; btn.title='Speech not supported (try Chrome).'; return; }
  SR = new SRClass(); SR.lang = 'fa-IR'; SR.interimResults = false; SR.maxAlternatives = 4;
  btn.disabled=false; btn.title='Say the word in Persian (e.g., Â«Ø®Ø§Ù†Ù‡Â»). Speaking the transliteration also works.';
  SR.onstart = ()=>{ $('speechFeedback').textContent='ğŸ™ï¸ Listeningâ€¦'; $('speechFeedback').className='feedback tiny'; };
  SR.onerror = ()=>{ $('speechFeedback').textContent='Mic error. Try again.'; $('speechFeedback').className='feedback err'; };
  SR.onend = ()=>{ if($('speechFeedback').textContent.includes('Listening')){ $('speechFeedback').textContent='Didnâ€™t catch thatâ€”try again.'; $('speechFeedback').className='feedback warn'; } };
  SR.onresult = (event)=>{
    const gi=order[idx], item=words[gi];
    const targetFa = normalizeFa(item.fa); const targetTr = normalizeTranslit(item.translit);
    const heard = []; for(let i=0;i<event.results[0].length;i++){ heard.push(event.results[0][i].transcript); }
    let ok=false, picked='';
    for(const h of heard){ if(hasPersian(h) && closeEnough(normalizeFa(h), targetFa)){ ok=true; picked=h.trim(); break; } }
    if(!ok){ for(const h of heard){ if(closeEnough(normalizeSRTranslit(h), targetTr)){ ok=true; picked=h.trim(); break; } } }
    $('speechFeedback').innerHTML = ok ? `Heard: "<b>${picked}</b>" âœ“`
      : `Heard: "<b>${(heard[0]||'(nothing)').trim()}</b>" âœ— â€” target is "<b>${item.fa}</b>" (${item.translit})`;
    $('speechFeedback').className = 'feedback ' + (ok?'ok':'warn');
    handleAnswer(ok, gi, 'speech', picked);
  };
  $('sayBtn').addEventListener('click', ()=>{ if(!SR) return; try{ SR.stop(); SR.start(); }catch(_){} });
}

/* ===================== ANSWERING / MAP ===================== */
const POINTS_PER_CORRECT_LQ = 2; // 2 points for Learn & Quiz modes

function handleAnswer(correct, gi, source='typing'){
  const r=ensureSRS(gi); r.seen++;
  if(correct){
    r.correct++; r.stage=Math.min(r.stage+1, SRS_INTERVALS_HOURS.length-1); scheduleAfter(gi,SRS_INTERVALS_HOURS[r.stage]||24);
    state.score+=POINTS_PER_CORRECT_LQ; state.streak+=1; addCovered(gi);
    sessionAnswered.add(gi); updateSessionBar();
    if(source!=='speech'){ $('typeFeedback').textContent=`Great! +${POINTS_PER_CORRECT_LQ} points`; $('typeFeedback').className='feedback ok'; }
    celebrateSimple();
    if(state.streak===7) celebrateStreak7();
    checkDailyGoalAndMap(); populateThemeDropdown(); updateAchievementProgress();
  }else{
    r.wrong++; r.stage=Math.max(0,r.stage-1); scheduleAfter(gi,2);
    state.streak=0; if(source!=='speech'){ $('typeFeedback').textContent='Not quite.'; $('typeFeedback').className='feedback warn'; }
  }
  persist(); setTimeout(next, 450);
}
function updateAchievementProgress(){ if(masteredIndices().length >= 10) awardAchievement('first10'); if(masteredIndices().length >= 50) awardAchievement('mastered50'); }
function checkDailyGoalAndMap(){
  const today=todayISO(); let days = state.mapDays||[]; let todayRec = days.find(d=>d.date===today);
  if(!todayRec){ todayRec={date:today, correct:0, goalMet:false}; days=[...days,todayRec]; }
  todayRec.correct++; if(!todayRec.goalMet && todayRec.correct>=DAILY_WORDS){
    todayRec.goalMet=true; if(window.confetti){ confetti({origin:{y:1,x:Math.random()},particleCount:60,spread:70,startVelocity:45,scalar:1.1}); }
  }
  state.mapDays = days; persist();
}

/* ===================== MAP & FURNITURE RENDER ===================== */
function renderMap(){
  const wrap = $('mapGrid'), layer=$('catLayer'), container=$('mapWrap'); if(!wrap || !layer || !container) return;
  const catsUnlocked = state.mapUnlocked||0;
  if(catsUnlocked<=0){
    container.classList.remove('arena'); wrap.style.display='grid'; layer.style.display='none'; wrap.innerHTML='';
    const tiles=12; for(let i=0;i<tiles;i++){ const t=document.createElement('div'); t.className='tile'; t.textContent='?'; wrap.appendChild(t); }
  }else{ wrap.style.display='none'; wrap.innerHTML=''; container.classList.add('arena'); layer.style.display='block'; }
  renderFurniture();
}

function nextFurnitureKey(){
  for (const k of FURNITURE_ORDER){ if(!state.furniture?.[k]) return k; }
  return null;
}
function furnitureLabel(k){
  return k==='catTree' ? 'Cat Tree' : k==='catToy' ? 'Cat Toy' : 'Cat Bowl';
}
function renderFurniture(){
  const container = $('mapWrap'); if(!container) return;
  const f = state.furniture || {};

  // Cat Tree
  let tree = $('furnCatTree');
  if(f.catTree){
    if(!tree){ tree = document.createElement('img'); tree.id = 'furnCatTree'; tree.className = 'furniture'; tree.src = CAT_TREE_IMG; tree.alt = 'Cat Tree'; container.appendChild(tree); }
  }else if(tree){ tree.remove(); }

  // Cat Toy
  let toy = $('furnCatToy');
  if(f.catToy){
    if(!toy){ toy = document.createElement('img'); toy.id = 'furnCatToy'; toy.className = 'furniture'; toy.src = CAT_TOY_IMG; toy.alt = 'Cat Toy'; container.appendChild(toy); }
  }else if(toy){ toy.remove(); }

  // Cat Bowl
  let bowl = $('furnCatBowl');
  if(f.catBowl){
    if(!bowl){ bowl = document.createElement('img'); bowl.id = 'furnCatBowl'; bowl.className = 'furniture'; bowl.src = CAT_BOWL_IMG; bowl.alt = 'Cat Bowl'; container.appendChild(bowl); }
  }else if(bowl){ bowl.remove(); }
}

/* ===================== CATNIP PARTY ===================== */
let catnipActive=false, catnipTimer=null, catnipTicker=null, catnipEndsAt=0;
function fmtCatnip(ms){ const s=Math.max(0, Math.ceil(ms/1000)); const m=Math.floor(s/60), sec=s%60; return m+':'+String(sec).padStart(2,'0'); }
function applyCatnipToCat(c){
  if(c.__catnip) return; c.__catnip = true; c.origSpeed = c.origSpeed || c.speed;
  const ang = Math.atan2(c.vy, c.vx); c.speed = c.speed * CATNIP_SPEED_FACTOR; c.vx = Math.cos(ang)*c.speed; c.vy = Math.sin(ang)*c.speed; c.turnMult = (c.turnMult||1) * CATNIP_TURN_FACTOR; c.el.classList.add('catnip');
}
function removeCatnipFromCat(c){
  if(!c.__catnip) return; const ang = Math.atan2(c.vy, c.vx); c.speed = c.origSpeed || (c.speed / CATNIP_SPEED_FACTOR);
  c.vx = Math.cos(ang)*c.speed; c.vy = Math.sin(ang)*c.speed; c.turnMult = 1; c.el.classList.remove('catnip'); c.__catnip = false;
}
function updateCatnipCountdownUI(){
  const btn = $('useCatnipBtn'); if(!btn) return;
  if(catnipActive){
    const remaining = Math.max(0, catnipEndsAt - Date.now());
    btn.textContent = `ğŸŒ¿ Catnip Party (${fmtCatnip(remaining)})`;
    btn.disabled = true; if(remaining <= 0){ stopCatnipParty(); }
  }else{
    btn.textContent = 'ğŸŒ¿ Use Catnip';
    btn.disabled = (state.inventory?.catnip||0) <= 0 || (state.mapUnlocked||0) === 0;
  }
}
function startCatnipParty(ms = CATNIP_DURATION_MS){
  if(catnipActive) return; catnipActive = true; catnipEndsAt = Date.now() + ms;
  for(const c of cats){ applyCatnipToCat(c); }
  burstLeaves(42);
  if(window.confetti){
    confetti({origin:{x:0.25,y:1},particleCount:80,spread:80,startVelocity:55});
    confetti({origin:{x:0.75,y:1},particleCount:80,spread:80,startVelocity:55});
  }
  clearTimeout(catnipTimer); clearInterval(catnipTicker);
  catnipTimer = setTimeout(stopCatnipParty, ms); catnipTicker = setInterval(updateCatnipCountdownUI, 1000);
  updateCatnipCountdownUI(); updateShopUI(); flashCatNames(4000);
}
function stopCatnipParty(){ clearTimeout(catnipTimer); clearInterval(catnipTicker); catnipActive=false; catnipTimer=null; catnipTicker=null; for(const c of cats){ removeCatnipFromCat(c); } updateCatnipCountdownUI(); updateShopUI(); }

/* ===================== EVENTS & UI ===================== */
$('listenBtn').addEventListener('click', playYourAudio);
$('typeInput').addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); $('checkBtn').click(); } });
$('checkBtn').addEventListener('click', ()=>{
  const gi=order[idx], item=words[gi]; const guess=normalizeTranslit($('typeInput').value);
  if(!guess){ $('typeFeedback').textContent='Type your guess first!'; $('typeFeedback').className='feedback warn'; return; }
  $('typeFeedback').textContent=''; $('typeInput').value=''; maybeFocusInput();
  handleAnswer(guess===normalizeTranslit(item.translit), gi, 'typing');
});
$('skipBtn').addEventListener('click', ()=>{ $('typeInput').value=''; state.streak=0; persist(); next(); });
$('nextBtn').addEventListener('click', ()=>{ $('typeInput').value=''; next(); });

function startMode(newMode){ endMiniQuiz(); endAudioQuiz(); mode = newMode; resetSessionProgress(); ensureOrder(); showItem(); }
$('learnBtn').addEventListener('click', ()=> startMode('learn'));
$('quizBtn').addEventListener('click', ()=> startMode('quiz'));
$('audioQuizBtn').addEventListener('click', ()=> openAudioQuiz());
$('hintBtn').addEventListener('click', ()=>{ if(mode!=='learn') return; const gi=order[idx], item=words[gi]; $('trans').textContent=item.translit; $('en').textContent=item.en; });
$('revealBtn').addEventListener('click', ()=>{ const gi=order[idx], item=words[gi]; $('fa').textContent=item.fa; $('trans').textContent=item.translit; const s=$('sadFace'); s.style.display='block'; setTimeout(()=>s.classList.add('fade-out'),700); setTimeout(()=>{s.classList.remove('fade-out'); s.style.display='none';},1500); });

$('openAchievements').addEventListener('click', ()=>{ reflectBadges(); $('achModal').style.display='grid'; });
$('closeAch').addEventListener('click', ()=> $('achModal').style.display='none');
$('openMap').addEventListener('click', ()=>{ renderMap(); $('mapModal').style.display='grid'; requestAnimationFrame(startCats); updateShopUI(); updateNamesToggleUI(); updateNamesVisibility(); });
$('closeMap').addEventListener('click', ()=>{ $('mapModal').style.display='none'; stopCats(); });

function updateShopUI(){
  const scoreEl=$('shopScore'), fishEl=$('shopFish'), nipEl=$('shopCatnip');
  if(scoreEl) scoreEl.textContent = state.score; if(fishEl) fishEl.textContent = state.inventory?.fish || 0; if(nipEl) nipEl.textContent = state.inventory?.catnip || 0;
  const buyBtn=$('buyFishBtn'), feedBtn=$('feedFishBtn'), nameBtn=$('toggleNameArea'), furnBtn=$('buyFurnitureBtn');
  if(buyBtn){ buyBtn.textContent = `ğŸŸ Buy Fish (${FISH_COST})`; buyBtn.disabled = state.score < FISH_COST; }
  if(feedBtn) feedBtn.disabled = (state.inventory?.fish||0) <= 0;
  const buyN=$('buyCatnipBtn'); if(buyN){ buyN.textContent = `ğŸŒ¿ Buy Catnip (${CATNIP_COST})`; buyN.disabled = state.score < CATNIP_COST; }
  updateCatnipCountdownUI();
  const hasToken = (state.inventory?.nameTokens||0) > 0;
  if(nameBtn){ nameBtn.textContent = `ğŸ“ Name a Cat (${NAME_COST})`; nameBtn.disabled = !hasToken && (state.score < NAME_COST || (state.mapUnlocked||0) === 0); }
  if($('nameCostNote')) $('nameCostNote').style.display = hasToken ? 'none' : 'inline';

  if(furnBtn){
    const nextKey = nextFurnitureKey();
    if(!nextKey){
      furnBtn.textContent = 'ğŸª‘ All Furniture Purchased';
      furnBtn.disabled = true;
    }else{
      furnBtn.textContent = `ğŸª‘ Buy Furniture (${FURNITURE_COST}) â€” Next: ${furnitureLabel(nextKey)}`;
      furnBtn.disabled = state.score < FURNITURE_COST;
    }
  }

  const sel=$('catSelect');
  if(sel){
    const n = state.mapUnlocked||0; sel.innerHTML='';
    for(let i=0;i<n;i++){ const opt=document.createElement('option'); opt.value=String(i); opt.textContent = `${i+1}: ${getCatName(i)}`; sel.appendChild(opt); }
    if(n>0 && $('nameArea').style.display!=='none'){ sel.value = String(Math.min(getNextCatIndex(), n-1)); }
  }
  if(cats && cats.length){ cats.forEach(c => { const nm=getCatName(c.idx); c.el.title = nm; if(c.label) c.label.textContent = nm; }); }
}
$('openShop').addEventListener('click', ()=>{
  const panel = $('shopPanel'); panel.style.display = panel.style.display==='none' ? 'block' : 'none'; updateShopUI();
});
$('feedFishBtn').addEventListener('click', ()=>{
  if((state.inventory.fish||0) <= 0) return; state.inventory.fish -= 1;
  $('shopMsg').textContent = 'Fed the cats! Theyâ€™re zooming ğŸ˜ºğŸ’¨'; $('shopMsg').className='feedback ok';
  burstHearts(28); if(window.confetti){ confetti({origin:{x:0.2,y:1},particleCount:70,spread:75,startVelocity:50}); confetti({origin:{x:0.8,y:1},particleCount:70,spread:75,startVelocity:50}); }
  boostCatsFor(8000,2.3); flashCatNames(4000); persist();
});
$('buyFishBtn').addEventListener('click', ()=>{ if(state.score < FISH_COST) return; state.score -= FISH_COST; state.inventory.fish = (state.inventory.fish||0) + 1; $('shopMsg').textContent = 'Bought 1 fish! ğŸŸ'; $('shopMsg').className='feedback ok'; persist(); });
$('buyCatnipBtn').addEventListener('click', ()=>{ if(state.score < CATNIP_COST) return; state.score -= CATNIP_COST; state.inventory.catnip = (state.inventory.catnip||0) + 1; $('shopMsg').textContent = 'Picked up fresh catnip! ğŸŒ¿'; $('shopMsg').className='feedback ok'; persist(); });
$('useCatnipBtn').addEventListener('click', ()=>{ if((state.inventory.catnip||0) <= 0 || catnipActive) return; state.inventory.catnip -= 1; $('shopMsg').textContent = 'ğŸŒ¿ Catnip party! Rolling, bouncing cats for a few minutesâ€¦'; $('shopMsg').className='feedback ok'; burstLeaves(40); startCatnipParty(CATNIP_DURATION_MS); persist(); });
$('toggleNameArea').addEventListener('click', ()=>{
  const nCats = state.mapUnlocked||0;
  if(nCats===0){ $('shopMsg').textContent='Unlock a cat first!'; $('shopMsg').className='feedback warn'; return; }
  const hasToken = (state.inventory?.nameTokens||0) > 0;
  if(!hasToken){
    if(state.score < NAME_COST){ $('shopMsg').textContent='Not enough points to buy a name.'; $('shopMsg').className='feedback warn'; return; }
    state.score -= NAME_COST; state.inventory.nameTokens = (state.inventory.nameTokens||0) + 1;
    $('shopMsg').textContent='Name token purchased. Pick a cat below! ğŸ·ï¸'; $('shopMsg').className='feedback ok'; persist();
  }
  $('nameArea').style.display='block';
  const sel = $('catSelect'); if(sel){ const nextIdx = Math.min(getNextCatIndex(), (state.mapUnlocked||1)-1); sel.value = String(nextIdx); }
  updateShopUI();
});
$('confirmNameBtn').addEventListener('click', ()=>{
  const selEl = $('catSelect'); const idx = parseInt((selEl && selEl.value ? selEl.value : String(getNextCatIndex())),10);
  const name = String(($('catNameInput').value||'').trim());
  if(!name){ $('shopMsg').textContent='Enter a name first.'; $('shopMsg').className='feedback warn'; return; }
  if((state.inventory.nameTokens||0) <= 0){ $('shopMsg').textContent='You need to buy a new name token first.'; $('shopMsg').className='feedback warn'; return; }
  if(!state.catNames) state.catNames = {}; state.catNames[idx] = name; state.nameCursor = idx; state.inventory.nameTokens = Math.max(0, (state.inventory.nameTokens||0)-1);
  $('shopMsg').textContent = `Named cat #${idx+1} â€œ${name}â€ ğŸ·ï¸`; $('shopMsg').className='feedback ok'; $('catNameInput').value=''; $('nameArea').style.display='none'; flashCatNames(4000); persist();
});

/* === Sequential furniture purchase: Tree â†’ Toy â†’ Bowl === */
$('buyFurnitureBtn').addEventListener('click', ()=>{
  const key = nextFurnitureKey();
  if(!key){
    $('shopMsg').textContent = 'All furniture purchased!';
    $('shopMsg').className = 'feedback ok';
    return;
  }
  if(state.score < FURNITURE_COST){
    $('shopMsg').textContent = 'Not enough points for furniture.';
    $('shopMsg').className = 'feedback warn';
    return;
  }
  state.score -= FURNITURE_COST;
  state.furniture = state.furniture || {};
  state.furniture[key] = true;

  $('shopMsg').textContent = `${furnitureLabel(key)} placed! The cats approve. ğŸ¾`;
  $('shopMsg').className = 'feedback ok';
  if(window.confetti){ confetti({origin:{x:0.5,y:1},particleCount:90,spread:80,startVelocity:55}); }
  persist();
});

function updateNamesToggleUI(){ const btn = $('toggleNamesBtn'); if(!btn) return; btn.textContent = state.showCatNames ? 'ğŸ¾ Hide Names' : 'ğŸ¾ Show Names'; }
function updateNamesVisibility(){ const show = state.showCatNames || (Date.now() < flashNamesUntil); if(cats && cats.length){ cats.forEach(c=>{ if(c.label){ c.label.style.display = show ? 'block' : 'none'; c.label.textContent = getCatName(c.idx); } c.el.title = getCatName(c.idx); }); } }
function flashCatNames(ms=3000){ flashNamesUntil = Date.now() + ms; updateNamesVisibility(); setTimeout(()=>updateNamesVisibility(), ms+50); }
$('toggleNamesBtn').addEventListener('click', ()=>{ state.showCatNames = !state.showCatNames; persist(); });

$('openSettings').addEventListener('click', ()=>{ $('settingsModal').style.display='grid'; $('reviewToggle').textContent=`ğŸ” Review All Mastered: ${state.settings?.reviewAll?'ON':'OFF'}`; populateThemeDropdown(); });
$('closeSettings').addEventListener('click', ()=> $('settingsModal').style.display='none');
$('settingsModal').addEventListener('click', e=>{ if(e.target.id==='settingsModal') e.currentTarget.style.display='none'; });
$('reviewToggle').addEventListener('click', ()=>{ state.settings.reviewAll = !state.settings.reviewAll; persist(); $('reviewToggle').textContent=`ğŸ” Review All Mastered: ${state.settings.reviewAll?'ON':'OFF'}`; });
$('openSentences').addEventListener('click', ()=>{ $('settingsModal').style.display='none'; openSentences(); });
$('closeSentences').addEventListener('click', ()=> $('sentencesModal').style.display='none');
$('sentPrev').addEventListener('click', ()=>{ sentenceIdx--; renderSentence(); });
$('sentNext').addEventListener('click', ()=>{ sentenceIdx++; renderSentence(); });

/* Reset Cat Names only */
$('resetNamesBtn').addEventListener('click', ()=>{ if(!confirm('Reset ALL cat names for this profile? This cannot be undone.')) return;
  state.catNames = {}; state.nameCursor = -1; persist(); updateShopUI(); updateNamesVisibility();
  if (cats && cats.length) { cats.forEach(c => { const nm = getCatName(c.idx); c.el.title = nm; if (c.label) c.label.textContent = nm; }); }
  const msg = $('shopMsg'); if (msg) { msg.textContent = 'All cat names cleared for this profile.'; msg.className = 'feedback ok'; }
});

/* Danger zone: full reset */
$('resetBtn').addEventListener('click', ()=>{
  if(!confirm('Reset ALL progress for this profile? (score, streak, SRS, unlocks, achievements)')) return;
  state = defaultState();
  state.start_date = todayISO();
  persist();
  alert('Progress cleared for ' + (ACTIVE_PROFILE || 'this profile') + '.');
});

/* Midnight countdown */
function msUntilNextMidnight(){ const n=new Date(), t=new Date(n); t.setHours(24,0,0,0); return t-n; }
function fmt(ms){ const s=Math.floor(ms/1000); const h=Math.floor(s/3600), m=Math.floor((s%3600)/60); return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`; }
function showMidnight(){ alert(`New words unlock at local midnight.\nTime remaining: ${fmt(msUntilNextMidnight())}`); }
$('midnightBtn').addEventListener('click', showMidnight);
$('midnightBtn0').addEventListener('click', showMidnight);

/* Profile flow */
function useProfile(name){
  ACTIVE_PROFILE = String(name||'').trim() || 'Guest';
  loadState(); $('profileBadge').textContent = `Profile: ${ACTIVE_PROFILE}`;
  $('profileOverlay').style.display='none'; $('startOverlay').style.display='grid';
  if (ACTIVE_PROFILE === "Nicole") initSharedNicoleSync();
}
$('quickNicole').addEventListener('click', ()=> useProfile('Nicole'));
$('quickSia').addEventListener('click', ()=>{ const pin = prompt('Enter developer PIN:'); if(pin === '3232'){ useProfile('Sia'); } else{ alert('Incorrect PIN.'); } });

(function(){ const overlay = $('profileOverlay'); const devBtn = $('quickSia'); let seq = '', timer=null, revealed=false;
  window.addEventListener('keydown', (e)=>{ if(!overlay || overlay.style.display!=='grid' || revealed) return; if(!/^[0-9]$/.test(e.key)) return;
    seq+=e.key; clearTimeout(timer); timer=setTimeout(()=>{seq='';},1500);
    if(seq.endsWith('3232')){ revealed=true; devBtn.style.display='inline-block'; const note=document.createElement('div'); note.className='tiny'; note.textContent='Developer button unlocked'; note.style.marginTop='10px'; overlay.querySelector('.overlay-card').appendChild(note); }
  });
})();

/* Start overlay: choose mode */
function startAs(m){ if(m==='audio'){ $('startOverlay').style.display='none'; openAudioQuiz(); return; } mode=m; resetSessionProgress(); ensureOrder(); $('startOverlay').style.display='none'; showItem(); }
['startLearn','startQuiz','startAudio'].forEach(id=>{ const el=$(id); if(el) el.setAttribute('type','button'); });
$('startOverlay').addEventListener('click',(e)=>{ if(e.target.id==='startLearn') startAs('learn'); if(e.target.id==='startQuiz')  startAs('quiz'); });

/* Close modals on backdrop click */
document.addEventListener('click', (e)=>{
  if(e.target.id==='settingsModal') e.target.style.display='none';
  if(e.target.id==='sentencesModal') e.target.style.display='none';
  if(e.target.id==='achModal') e.target.style.display='none';
  if(e.target.id==='mapModal'){ e.target.style.display='none'; stopCats(); }
  if(e.target.id==='postcardsModal'){ e.target.style.display='none'; }
  if(e.target.id==='dictModal'){ e.target.style.display='none'; }
  if(e.target.id==='miniQuizModal'){ endMiniQuiz(); }
  if(e.target.id==='audioQuizModal'){ endAudioQuiz(); }
});

/* Item order & display */
function ensureOrder(){ const pool = (mode==='quiz')? quizPool(): learnPool(); order=pool.slice(); shuffle(order); idx=0; }
function showImageOrEmoji(item){ const pic=$('pic'), emo=$('emoji'); setImageWithFallback(pic, emo, item); }
function showItem(){
  const pool = (mode==='quiz')? quizPool(): learnPool();
  if(order.length===0 || order.some(i=>!pool.includes(i))) ensureOrder();
  const gi = order[idx % order.length]; const item = words[gi]; showImageOrEmoji(item);
  if(mode==='quiz'){ $('en').textContent=item.en; $('fa').textContent='â€¢â€¢â€¢'; $('trans').textContent='â€”'; }
  else { $('en').textContent=item.en; $('fa').textContent=item.fa; $('trans').textContent=item.translit; }
  $('listenBtn').style.display = (mode==='quiz')?'none':'inline-flex';
  $('revealBtn').style.display = (mode==='quiz')?'inline-flex':'none';
  $('hintBtn').style.display = 'none'; $('typeInput').value=''; maybeFocusInput();
}
function next(){ idx=(idx+1)%Math.max(1,order.length); showItem(); }

/* Night Sky background (22:00â€“02:00) â€” brief) */
(function nightSkyBackground(){
  try{
    const reduce = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    let sky = null, sparkTimer = null, showTimer = null, checkTimer = null, lastShownAt = 0;
    const SHOW_MS = 10000, COOLDOWN_MS = 60000;
    function inWindow(){ const h=new Date().getHours(); return (h>=22 || h<2); }
    function createSky(){
      if(sky) return; sky = document.createElement('div'); sky.id='nightSky'; sky.className='night-sky'; document.body.appendChild(sky);
      const area = Math.max(1, window.innerWidth * window.innerHeight); const count = Math.max(90, Math.min(240, Math.round(area / 8000)));
      for(let i=0;i<count;i++){
        const s=document.createElement('span'); s.className='night-star';
        s.style.left=(Math.random()*100).toFixed(2)+'vw'; s.style.top=(Math.random()*100).toFixed(2)+'vh';
        const size=(Math.random()<0.78 ? (1+Math.random()*1.4) : (2+Math.random()*2.2));
        s.style.width=size+'px'; s.style.height=size+'px';
        const dur=(1.2+Math.random()*3.6).toFixed(2)+'s', delay=(Math.random()*3).toFixed(2)+'s';
        s.style.setProperty('--dur',dur); s.style.setProperty('--delay',delay); sky.appendChild(s);
      }
      if(!reduce) startSparkEngine(); clearTimeout(showTimer); showTimer=setTimeout(destroySky, SHOW_MS); lastShownAt=Date.now();
    }
    function destroySky(){ stopSparkEngine(); if(!sky) return; sky.remove(); sky=null; }
    function startSparkEngine(){
      stopSparkEngine(); const stars = ()=> sky ? Array.from(sky.querySelectorAll('.night-star')) : [];
      sparkTimer=setInterval(()=>{ const arr=stars(); if(!arr.length) return;
        const picks=Math.max(1, Math.floor(Math.random()*3)+1);
        for(let i=0;i<picks;i++){
          const s=arr[Math.floor(Math.random()*arr.length)]; if(!s) continue;
          s.classList.remove('spark'); const dur=(0.6+Math.random()*1.0).toFixed(2)+'s'; s.style.setProperty('--sparkDur',dur);
          void s.offsetWidth; s.classList.add('spark'); setTimeout(()=> s && s.classList && s.classList.remove('spark'), 1400);
        }
      }, 850 + Math.floor(Math.random()*600));
    }
    function stopSparkEngine(){ if(sparkTimer){ clearInterval(sparkTimer); sparkTimer=null; } }
    function cycle(){ const now=Date.now(); if(!inWindow() || reduce){ destroySky(); return; } if(!sky && (now-lastShownAt>=COOLDOWN_MS)) createSky(); }
    cycle(); clearInterval(checkTimer); checkTimer=setInterval(cycle, 30000);
    window.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='visible'){ cycle(); } });
    window.addEventListener('resize', ()=>{ if(sky){ destroySky(); createSky(); } });
  }catch{}
})();

/* ===================== POSTCARDS UI ===================== */
let pcIndex = 0;
function postcardsLearned(){ return learnedCount(); }
function unlockThresholdForIndex(i){ return (i + 1) * POSTCARD_UNLOCK_EVERY; }
function postcardsUnlockedCount(){ const learned = postcardsLearned(); return Math.min(POSTCARDS.length, Math.floor(learned / POSTCARD_UNLOCK_EVERY)); }
function remainingToUnlockIndex(i){ return Math.max(0, unlockThresholdForIndex(i) - postcardsLearned()); }

function renderPostcardView(i){
  if(i < 0){
    $('pcViewFa').textContent = '';
    $('pcViewTrans').textContent = '';
    $('pcViewEn').textContent = 'Learn a few more words to unlock your first postcard!';
    $('pcUnlockNote').innerHTML = `Locked â€” learn <b>${remainingToUnlockIndex(0)}</b> more to unlock the first one.`;
    setImageWithFallback($('pcViewImg'), $('pcViewEmoji'), { image:'', emoji:'â“', en:'Locked' });
    return;
  }
  if(i >= POSTCARDS.length) i = POSTCARDS.length - 1; pcIndex = i;
  const p = POSTCARDS[i];
  setImageWithFallback($('pcViewImg'), $('pcViewEmoji'), { image:p.image, emoji:p.emoji||'ğŸ›ï¸', en:p.title });
  $('pcViewFa').textContent    = p.fa || '';
  $('pcViewTrans').textContent = p.translit || '';
  $('pcViewEn').textContent    = p.en || '';
  const learned = postcardsLearned();
  $('pcUnlockNote').innerHTML = `Unlocked âœ“ (Youâ€™ve learned ${learned})`;
}
function renderPostcardsGrid(){
  const box = $('pcGrid'); if(!box) return; box.innerHTML = '';
  const unlocked = postcardsUnlockedCount();
  POSTCARDS.slice(0, unlocked).forEach((p, i)=>{
    const tile = document.createElement('button'); tile.type = 'button'; tile.className = 'pc-tile'; tile.setAttribute('aria-label', p.title);
    const img = document.createElement('img'); img.className = 'pc-thumb'; img.alt = p.title || '';
    const emoji = document.createElement('div'); emoji.className = 'pc-emoji'; emoji.textContent = p.emoji || 'ğŸ›ï¸';
    tile.appendChild(img); tile.appendChild(emoji); setImageWithFallback(img, emoji, { image:p.image, emoji:p.emoji||'ğŸ›ï¸', en:p.title });
    const cap = document.createElement('div'); cap.className = 'pc-cap'; cap.textContent = p.title || ''; tile.appendChild(cap);
    tile.addEventListener('click', ()=> renderPostcardView(i)); box.appendChild(tile);
  });
  if(unlocked < POSTCARDS.length){
    const more = document.createElement('div'); more.className = 'pc-more';
    const need = remainingToUnlockIndex(unlocked);
    more.innerHTML = `<div class="pc-q">?</div><div class="pc-note">Learn ${need} more<br>to unlock the next postcard</div>`;
    box.appendChild(more);
  }
}
function openPostcards(){
  $('postcardsModal').style.display='grid';
  const unlocked = postcardsUnlockedCount();
  renderPostcardView(unlocked ? unlocked - 1 : -1);
  renderPostcardsGrid();
}
$('openPostcards').addEventListener('click', openPostcards);
$('closePostcards').addEventListener('click', ()=> $('postcardsModal').style.display='none');

/* ===================== DICTIONARY (10 / page + click-to-play) ===================== */
const DICT_PAGE_SIZE = 10;
let dictPage = 0;

function learnedIndicesInOrder(){
  // Code order (ascending index), only items learned so far
  return [...getCoveredSet()]
    .filter(i => i < unlockedCount())
    .sort((a,b)=>a-b);
}

/* Ensure scroll wrapper so modal height doesn't jump */
function ensureDictScrollWrapper(){
  const panel = $('dictPanel'); if(!panel) return;
  if ($('dictScroll')) return;
  const tbl = $('dictTable'); const empty = $('dictEmpty');
  const controls = panel.querySelector('.dict-controls');
  const sc = document.createElement('div'); sc.id='dictScroll';
  panel.insertBefore(sc, controls);
  if (tbl)   sc.appendChild(tbl);
  if (empty) sc.appendChild(empty);
}

function renderDictionary(){
  const tbl = $('dictTable'); const empty = $('dictEmpty'); const pageLbl = $('dictPageLabel');
  if(!tbl || !empty || !pageLbl) return;

  const learned = learnedIndicesInOrder();
  const total = learned.length;
  const totalPages = Math.max(1, Math.ceil(total / DICT_PAGE_SIZE));
  if (dictPage >= totalPages) dictPage = totalPages - 1;
  if (dictPage < 0) dictPage = 0;

  tbl.innerHTML = '';
  if(total === 0){
    empty.style.display = 'block';
    pageLbl.textContent = 'Page 1 / 1';
    $('dictPrev').disabled = true; $('dictNext').disabled = true;
    return;
  }
  empty.style.display = 'none';

  const thead = document.createElement('thead');
  thead.innerHTML = '<tr><th style="width:48px">#</th><th>English</th><th>Translit</th></tr>';
  tbl.appendChild(thead);

  const start = dictPage * DICT_PAGE_SIZE;
  const end = Math.min(start + DICT_PAGE_SIZE, total);
  const slice = learned.slice(start, end);

  const tbody = document.createElement('tbody');
  slice.forEach((i, ix) => {
    const w = words[i]; if(!w) return;
    const rowNum = start + ix + 1;
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${rowNum}</td>
      <td>${w.en || ''}</td>
      <td>
        <button class="dict-play" data-idx="${i}" title="Play audio for ${w.en}" aria-label="Play ${w.en}">
          ${w.translit || ''}
        </button>
      </td>`;
    tbody.appendChild(tr);
  });
  tbl.appendChild(tbody);

  pageLbl.textContent = `Page ${dictPage+1} / ${totalPages}`;
  $('dictPrev').disabled = (dictPage === 0);
  $('dictNext').disabled = (dictPage >= totalPages - 1);
}
$('dictTable').addEventListener('click', (e)=>{
  const btn = e.target.closest('.dict-play');
  if(!btn) return;
  const idx = parseInt(btn.dataset.idx, 10);
  const item = words[idx];
  if(!item) return;
  try{ const a = getAudio(item); a.currentTime = 0; a.play(); }catch{}
});
function openDictionary(){ dictPage = 0; ensureDictScrollWrapper(); renderDictionary(); $('dictModal').style.display='grid'; }
function closeDictionary(){ $('dictModal').style.display='none'; }
$('openDictionary').addEventListener('click', openDictionary);
$('closeDict').addEventListener('click', closeDictionary);
$('dictPrev').addEventListener('click', ()=>{ dictPage = Math.max(0, dictPage - 1); renderDictionary(); });
$('dictNext').addEventListener('click', ()=>{ dictPage = dictPage + 1; renderDictionary(); });

/* ===================== BACKGROUND MUSIC ===================== */
const MUSIC_URL = 'audio/backgroundinstrumental.mp3';
let musicAudio = null;
function initMusic(){
  if(musicAudio) return;
  musicAudio = new Audio(MUSIC_URL);
  musicAudio.loop = true; musicAudio.preload = 'auto';
  musicAudio.volume = state.settings?.musicVol ?? 0.28;
  musicAudio.setAttribute('playsinline','');
}
function updateMusicBtnUI(){
  const b = $('musicToggle'); if(!b) return;
  const playing = musicAudio && !musicAudio.paused && !musicAudio.ended;
  b.textContent = playing ? 'â¸ï¸ Pause Music' : 'ğŸµ Play Music';
}
$('musicToggle').addEventListener('click', async ()=>{
  initMusic();
  try{
    if(musicAudio.paused){ await musicAudio.play(); state.settings.musicOn = true; }
    else { musicAudio.pause(); state.settings.musicOn = false; }
    persist();
  }catch(e){
    alert('Could not start audio. After interacting with the page, tap â€œPlay Musicâ€ again.');
  }
  updateMusicBtnUI();
});
document.addEventListener('visibilitychange', updateMusicBtnUI);
updateMusicBtnUI();

/* Init */
initSpeech();
</script>
</body>
</html>
