<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Farsi Fun — Learn Persian Basics</title>
<style>
:root{
  --bg:#0f172a;--card:#111827;--muted:#94a3b8;--text:#e5e7eb;--accent:#22c55e;--accent-2:#38bdf8;--warn:#f59e0b;--err:#ef4444;
  --grad1:#0b1229; --grad2:#121a36;
}
*{box-sizing:border-box}
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans,Ubuntu,Cantarell,Helvetica Neue,Arial,"Apple Color Emoji","Segoe UI Emoji";
  margin:0;background:linear-gradient(135deg,var(--bg),#0b1028);color:var(--text)}
header{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:16px clamp(16px,4vw,32px);
  position:sticky;top:0;background:rgba(15,23,42,.75);backdrop-filter:blur(10px);border-bottom:1px solid #1f2937;z-index:5}
header h1{font-size:clamp(18px,2.5vw,28px);margin:0;letter-spacing:.5px;cursor:pointer}
.stats{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.badge{background:#111827;border:1px solid #1f2937;padding:6px 10px;border-radius:999px;font-size:14px;color:var(--muted)}
.icon-btn{display:inline-flex;align-items:center;justify-content:center;width:40px;height:40px;border-radius:10px;
  background:#111827;border:1px solid #1f2937;cursor:pointer}
.icon-btn:hover{background:#0b1229;border-color:#263042}
.btn,button,select{appearance:none;border:none;background:#111827;color:#e5e7eb;border:1px solid #1f2937;padding:10px 14px;border-radius:12px;cursor:pointer}
.btn:hover,button:hover,select:hover{background:#0b1229;border-color:#263042}
.primary{background:linear-gradient(180deg,var(--accent),#16a34a);border-color:#14532d}
.accent{background:linear-gradient(180deg,var(--accent-2),#0ea5e9);border-color:#075985}
main{max-width:980px;margin:24px auto;padding:0 clamp(16px,4vw,32px) 120px}
.card{background:linear-gradient(180deg,var(--grad1),var(--grad2));border:1px solid #1f2937;border-radius:16px;padding:clamp(16px,3vw,28px)}
.row{display:grid;grid-template-columns:1fr;gap:16px}
@media(min-width:860px){.row{grid-template-columns:1fr 1fr}}
.media-wrap{display:grid;place-items:center}
.pic,.mq-pic{width:min(420px,92%);height:min(280px,45vw);object-fit:contain;background:#0b1229;border:1px solid #1f2937;border-radius:16px;display:none}
.emoji{font-size:clamp(64px,12vw,120px);text-align:center;line-height:1;filter:drop-shadow(0 10px 20px rgba(0,0,0,.35))}
.word{display:flex;flex-direction:column;gap:6px;align-items:flex-start;justify-content:center}
.en{font-size:clamp(26px,3.4vw,34px);font-weight:700;color:#e2e8f0}
.fa{font-size:clamp(18px,2.6vw,22px);color:#cbd5e1;direction:rtl;text-align:right}
.trans{font-size:clamp(26px,3.4vw,34px);font-weight:600;color:#e2e8f0}
.controls{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-top:10px}
.input{background:#0b1229;border:1px solid #1f2937;padding:12px 14px;border-radius:12px;color:#e5e7eb;width:100%;font-size:16px}
.feedback{margin-top:8px;min-height:24px;font-size:15px}
.ok{color:var(--accent)}
.warn{color:var(--warn)}
.err{color:var(--err)}
.progress{margin-top:12px;height:10px;background:#0b1229;border-radius:999px;border:1px solid #1f2937;overflow:hidden}
.bar{height:100%;width:0%;background:linear-gradient(90deg,#38bdf8,#22c55e);transition:width .3s ease}

/* ===== mode row (dictionary on right) ===== */
.mode{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:space-between;margin-bottom:10px}
.mode-left{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.mode-right{margin-left:auto}

.tiny{font-size:12px;color:#94a3b8}
.cele-msg{position:fixed;left:50%;bottom:72px;transform:translateX(-50%);background:rgba(17,24,39,.92);border:1px solid #1f2937;padding:14px 18px;border-radius:14px;font-weight:800;z-index:20}
.fade-out{animation:fadeOut .9s ease forwards}
@keyframes fadeOut { to { opacity:0 } }
.overlay{position:fixed;inset:0;background:radial-gradient(1000px 600px at 50% -10%, rgba(56,189,248,.25), transparent 40%), rgba(15,23,42,.94);display:grid;place-items:center;z-index:10}
.overlay-card,.modal-card{background:linear-gradient(180deg,#0b1229,#121a36);border:1px solid #1f2937;border-radius:18px;padding:24px;box-shadow:0 20px 60px rgba(0,0,0,.35);max-width:760px;margin:0 16px}
.modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.45);z-index:12}
#miniQuizModal,#sentencesModal,#audioQuizModal{backdrop-filter:blur(12px) saturate(120%);-webkit-backdrop-filter:blur(12px) saturate(120%)}
.grid{display:grid;gap:10px}
@media(min-width:760px){.grid{grid-template-columns:1fr 1fr}}
.stat{background:#0b1229;border:1px solid #1f2937;border-radius:12px;padding:10px}
.chip{display:inline-flex;gap:6px;background:#0b1229;border:1px solid #1f2937;border-radius:999px;padding:6px 10px;font-size:12px;color:#94a3b8;margin:2px 4px 0 0}

/* Bazaar */
.map-wrap{position:relative;margin-top:10px}
.map{display:grid;grid-template-columns:repeat(4, minmax(60px,1fr));gap:8px;position:relative;z-index:1}
.tile{aspect-ratio:1/1;background:#0b1229;border:1px dashed #334155;border-radius:10px;display:grid;place-items:center;font-size:28px;color:#334155}

/* Furniture — ensure above grid/cats */
.furniture{
  position:absolute; top:8px; left:8px;
  width:92px; height:auto; z-index:3; pointer-events:none;
  filter: drop-shadow(0 8px 18px rgba(0,0,0,.35));
}

/* roaming cats overlay */
.cat-layer{position:absolute;inset:0;pointer-events:none;z-index:2;overflow:hidden}
.cat{position:absolute;font-size:32px;filter:drop-shadow(0 6px 10px rgba(0,0,0,.35));will-change:transform,left,top}
.cat.flip{transform:scaleX(-1)}
@media(min-width:760px){ .cat{font-size:40px} }
.cat .cat-emoji{display:inline-block}
.cat-name{
  position:absolute; left:50%; top:-18px; transform:translateX(-50%);
  font-size:12px; padding:2px 6px; border-radius:8px;
  background:rgba(17,24,39,.88); border:1px solid #1f2937; color:#e5e7eb;
  white-space:nowrap; pointer-events:none; display:none;
  filter: drop-shadow(0 4px 8px rgba(0,0,0,.35));
}

/* Catnip roll + bounce */
.cat.catnip .cat-emoji{animation:catnipRoll .7s linear infinite}
@keyframes catnipRoll{
  0%{transform:translateY(0) rotate(0deg)}
  50%{transform:translateY(-8px) rotate(180deg)}
  100%{transform:translateY(0) rotate(360deg)}
}

/* Arena when cats are unlocked (grid hidden) */
.map-wrap.arena{
  background:#0b1229;border:1px solid #1f2937;border-radius:12px;
  height:clamp(260px, 45vh, 380px);
}

/* Rewards / shop row */
.shop-row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.muted{color:#94a3b8}

/* Hearts when feeding */
.heart{position:absolute;font-size:20px;pointer-events:none;opacity:0;animation:floatHeart 1.6s ease-out forwards}
@keyframes floatHeart{
  0%{transform:translateY(0) scale(.8);opacity:.9}
  60%{opacity:1}
  100%{transform:translateY(-60px) scale(1.25);opacity:0}
}

/* Leaves burst when using catnip */
.leaf{position:absolute;font-size:20px;pointer-events:none;opacity:0;animation:floatLeaf 2.2s ease-out forwards}
@keyframes floatLeaf{
  0%{transform:translateY(0) rotate(0deg);opacity:.9}
  100%{transform:translateY(-90px) rotate(180deg);opacity:0}
}

/* Heavy blur for profile/start overlays */
#profileOverlay,#startOverlay{
  background: radial-gradient(1000px 600px at 50% -10%, rgba(56,189,248,.25), transparent 40%), rgba(15,23,42,.60);
  backdrop-filter: blur(28px) saturate(120%);
  -webkit-backdrop-filter: blur(28px) saturate(120%);
}

/* ----- Mobile-only header/input behavior ----- */
@media (max-width: 700px){
  header{ position: static; top:auto; background:rgba(15,23,42,.9); backdrop-filter:none; }
  main{ padding:0 16px 120px; }
}

/* ========= Badge visuals ========= */
.badges-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.badge-tile{
  position:relative; padding:10px 12px; border-radius:12px; font-size:14px;
  background:#0b1229; border:1px solid #1f2937; color:#9aa7b7; display:flex; align-items:center; gap:8px;
  filter:grayscale(1) brightness(.7); opacity:.65; transition:filter .25s ease, opacity .25s ease, box-shadow .25s ease;
}
.badge-tile .ico{width:22px; height:22px; display:grid; place-items:center}
.badge-tile .label{flex:1}
.badge-tile.earned{
  filter:none; opacity:1; color:#e5e7eb; box-shadow:0 0 0 0 rgba(56,189,248,.0);
  animation:badgeGlow 2.2s ease-in-out 1 forwards;
}
@keyframes badgeGlow{
  0% { box-shadow:0 0 0px 0 rgba(56,189,248,.0); }
  35% { box-shadow:0 0 18px 6px rgba(56,189,248,.35); }
  100% { box-shadow:0 0 8px 2px rgba(34,197,94,.25); }
}
.badge-tile.sparkle::after{
  content:"✨"; position:absolute; right:8px; top:-6px; font-size:18px; animation:sparklePop .9s ease-out 1 forwards;
}
@keyframes sparklePop{
  0%{ transform:translateY(6px) scale(.6); opacity:0; }
  40%{ transform:translateY(0) scale(1.2); opacity:1; }
  100%{ transform:translateY(0) scale(1); opacity:0; }
}

/* ====== Night Sky Twinkles (22:00–02:00) ====== */
.night-sky{ position:fixed; inset:0; pointer-events:none; z-index:-1; }
.night-star{
  position:absolute;
  width:2px; height:2px; border-radius:50%;
  background: radial-gradient(circle, rgba(255,255,255,.95), rgba(255,255,255,0) 60%);
  opacity:0;
  animation: starTwinkle var(--dur,2.2s) ease-in-out var(--delay,0s) infinite alternate;
  filter: drop-shadow(0 0 6px rgba(255,255,255,.28));
  will-change: opacity, transform;
}
.night-star.spark{
  animation: starTwinkle var(--dur,2.2s) ease-in-out var(--delay,0s) infinite alternate,
             starSpark var(--sparkDur,.9s) ease-out 1;
}
@keyframes starTwinkle{ 0%{opacity:.07;transform:scale(.9)} 50%{opacity:.95;transform:scale(1.1)} 100%{opacity:.15;transform:scale(.92)} }
@keyframes starSpark{ 0%{opacity:.25;transform:scale(1)} 40%{opacity:1;transform:scale(1.35)} 100%{opacity:.25;transform:scale(1)} }
@media (prefers-reduced-motion: reduce){
  .night-star{ animation: none; opacity:.22 }
  .night-star.spark{ animation: none; }
}

/* ======== Audio Quiz styles ======== */
.aq-grid{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
.aq-option{ position:relative; aspect-ratio:1/1; border:1px solid #1f2937; border-radius:12px; background:#0b1229; display:grid; place-items:center; overflow:hidden; }
.aq-option img{ width:100%; height:100%; object-fit:contain; display:block; }
.aq-option .aq-emoji{ font-size:48px; line-height:1; }
.aq-option.correct{ border-color: var(--accent); box-shadow:0 0 0 2px rgba(34,197,94,.25) inset }
.aq-option.wrong{ border-color: var(--err); box-shadow:0 0 0 2px rgba(239,68,68,.22) inset }

/* ======== Postcards ======== */
.pc-grid{ display:grid; gap:10px; grid-template-columns:repeat(auto-fill, minmax(140px,1fr)); }
.pc-tile{
  position:relative; border:1px solid #1f2937; border-radius:12px; background:#0b1229; overflow:hidden; cursor:pointer;
  display:flex; flex-direction:column; align-items:center; justify-content:center; padding:10px;
  transition:transform .08s ease, box-shadow .2s ease;
}
.pc-tile:hover{ transform:translateY(-2px); box-shadow:0 8px 24px rgba(0,0,0,.22) }
.pc-thumb{
  width:100%; aspect-ratio:4/3; object-fit:cover; display:block;
  border-radius:8px; border:1px solid #1f2937; background:#0b1229;
}
.pc-emoji{ font-size:48px; line-height:1; display:none }
.pc-cap{ font-size:13px; color:#cbd5e1; margin-top:8px; text-align:center }

/* ======== Dictionary ======== */
.dict-table{width:100%; border-collapse:collapse;}
.dict-table th,.dict-table td{border-bottom:1px solid #1f2937; padding:8px 10px; text-align:left;}
.dict-table th{color:#9aa7b7;font-weight:600;font-size:13px}
.dict-empty{color:#94a3b8;font-size:14px;padding:6px 0}
.dict-controls{display:flex;align-items:center;justify-content:space-between;margin-top:10px}
#dictPanel{display:flex;flex-direction:column}
.dict-scroll{min-height:280px;max-height:280px;overflow:auto;margin-bottom:10px}
.dict-play{background:transparent;border:none;color:#e5e7eb;cursor:pointer;padding:0;font:inherit;text-decoration:underline dotted #334155}
.dict-play:hover{opacity:.9}
</style>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js" defer></script>
</head>
<body>
<header>
  <h1>✨ Farsi Fun — Learn Persian Basics</h1>
  <div class="stats">
    <div class="badge" id="profileBadge">Profile: —</div>
    <div class="badge" id="scoreBadge">Score: 0</div>
    <div class="badge" id="streakBadge">Streak: 0 🔥</div>
    <div class="badge" id="unlockedBadge">0/0 unlocked</div>
    <button id="openMap" class="icon-btn" title="Bazaar Map">🗺️</button>
    <button id="openPostcards" class="icon-btn" title="Postcards">🏛️</button>
    <button id="openAchievements" class="icon-btn" title="Badges">🏆</button>
    <button id="openSettings" class="icon-btn" title="Settings">⚙️</button>
  </div>
</header>

<!-- Profile chooser -->
<div id="profileOverlay" class="overlay" style="display:grid">
  <div class="overlay-card" style="position:relative; text-align:center">
    <h2 style="margin-top:0">Who are you?</h2>
    <p class="tiny" style="margin-bottom:20px">Choose your profile to continue</p>
    <button id="quickNicole" class="primary" style="font-size:20px; padding:14px 28px;">Nicole</button>
    <button id="quickSia" style="position:absolute; bottom:10px; right:10px; font-size:12px; padding:4px 8px; opacity:0.75; display:none;" class="btn" title="Developer">Siyavash</button>
  </div>
</div>

<!-- Start screen -->
<div id="startOverlay" class="overlay" style="display:none">
  <div class="overlay-card">
    <h2>How do you want to learn today?</h2>
    <p>Pick a mode to get started. You can switch later.</p>
    <div style="display:flex; gap:12px; flex-wrap:wrap">
      <button id="startLearn" class="primary" type="button">📚 Learn Mode</button>
      <button id="startQuiz" class="accent" type="button">🎯 Quiz Mode</button>
    </div>
    <p class="tiny" style="margin-top:10px">Tip: Use <b>Chrome</b>. <b>Listen</b> plays your MP3s.</p>
  </div>
</div>

<main>
  <div class="mode">
    <div class="mode-left">
      <button id="learnBtn" class="btn">Learn Mode</button>
      <button id="quizBtn" class="btn">Quiz Mode</button>
      <button id="audioQuizBtn" class="btn">Audio Quiz</button>
      <button id="musicToggle" class="btn">🎵 Play Music</button>
    </div>
    <div class="mode-right">
      <button id="openDictionary" class="btn" title="Dictionary">📚 Dictionary</button>
    </div>
  </div>

  <div class="card">
    <div class="row">
      <div class="media-wrap">
        <img id="pic" class="pic" alt="" />
        <div class="emoji" id="emoji"></div>
      </div>
      <div class="word" id="wordWrap">
        <div class="en" id="en">apple</div>
        <div class="fa" id="fa" dir="rtl">سیب</div>
        <div class="trans" id="trans">sib</div>

        <!-- Main practice UI -->
        <div id="learnUI">
          <div class="controls">
            <button id="listenBtn" class="accent">🔊 Listen</button>
            <button id="sayBtn" class="btn" disabled title="(optional speech recog)">🎙️ Say it</button>
            <button id="hintBtn" class="btn">💡 Hint</button>
            <button id="revealBtn" class="btn">👀 Reveal</button>
            <button id="nextBtn" class="primary">➡️ Next</button>
          </div>
          <div class="feedback" id="speechFeedback"></div>
          <label class="tiny" for="typeInput">Type the pronunciation (English letters):</label>
          <input class="input" id="typeInput" placeholder="e.g., sib" autocapitalize="off" autocorrect="off" spellcheck="false" inputmode="latin"/>
          <div class="controls">
            <button id="checkBtn" class="primary">✅ Check</button>
            <button id="skipBtn" class="btn">⏭️ Skip</button>
          </div>
          <div class="feedback" id="typeFeedback"></div>
          <div class="progress"><div class="bar" id="progressBar"></div></div>
        </div>
      </div>
    </div>
  </div>
</main>

<footer style="padding:16px;text-align:center;color:#94a3b8">
  Have fun! • New words unlock at
  <button id="midnightBtn" class="btn" style="padding:2px 6px">midnight</button> ⏰
</footer>

<div id="celebration" class="cele-msg" style="display:none">let's goooooo 🎉</div>
<div id="sadFace" class="cele-msg" style="display:none">😢</div>

<!-- Achievements Modal -->
<div id="achModal" class="modal">
  <div class="modal-card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
      <h3 style="margin:0">🏆 Badges</h3>
      <button id="closeAch" class="btn">Close</button>
    </div>
    <div id="achList" class="grid"></div>
  </div>
</div>

<!-- Bazaar Map Modal -->
<div id="mapModal" class="modal">
  <div class="modal-card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
      <div class="shop-row"><button id="toggleNamesBtn" class="btn" title="Show/hide cat names">🐾 Show Names</button></div>
      <div style="display:flex;align-items:center;gap:10px">
        <h3 style="margin:0">🗺️ Persian Bazaar Progress</h3>
        <div class="shop-row">
          <button id="openShop" class="btn accent" title="Redeem cat rewards">💠 Redeem</button>
          <button id="closeMap" class="btn">Close</button>
        </div>
      </div>
    </div>
    <p class="tiny">Lots of cats live here 🐈. Cats are unlocked at 5, 20, 100, 250, 500. </p>

    <div class="map-wrap" id="mapWrap">
      <div id="mapGrid" class="map"></div>
      <div id="catLayer" class="cat-layer"></div>
    </div>

    <div id="shopPanel" class="stat" style="display:none; margin-top:10px">
      <div class="shop-row" style="justify-content:space-between">
        <div class="muted">Score: <b id="shopScore">0</b> • Fish: <b id="shopFish">0</b> • Catnip: <b id="shopCatnip">0</b></div>
        <div class="shop-row">
          <button id="buyFishBtn" class="btn">🐟 Buy Fish (100)</button>
          <button id="feedFishBtn" class="btn">🍽️ Feed Cats</button>
          <button id="buyCatnipBtn" class="btn">🌿 Buy Catnip (250)</button>
          <button id="useCatnipBtn" class="btn">🌿 Use Catnip</button>
          <button id="toggleNameArea" class="btn">📝 Name a Cat (500)</button>
          <button id="buyFurnitureBtn" class="btn">🪑 Buy Furniture (1000)</button>
        </div>
      </div>

      <div id="nameArea" style="display:none; margin-top:8px">
        <div class="shop-row">
          <select id="catSelect" class="btn"></select>
          <input id="catNameInput" class="input" placeholder="Enter a cute name…" style="max-width:260px"/>
          <button id="confirmNameBtn" class="primary">Save Name</button>
          <span id="nameCostNote" class="tiny muted">Costs 500 points.</span>
        </div>
      </div>

      <div id="shopMsg" class="feedback"></div>
    </div>
  </div>
</div>

<!-- Postcards Modal -->
<div id="postcardsModal" class="modal">
  <div class="modal-card" style="max-width:940px">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <h3 id="pcTitle" style="margin:0">🏛️ Landmark Postcards</h3>
      <button id="closePostcards" class="btn">Close</button>
    </div>

    <div id="pcView" class="stat" style="display:grid;grid-template-columns:1fr;gap:10px;margin-bottom:12px">
      <div style="display:grid;place-items:center">
        <img id="pcViewImg" alt="" style="display:none;width:min(780px,100%);height:auto;border-radius:12px;border:1px solid #1f2937;background:#0b1229" loading="lazy"/>
        <div id="pcViewEmoji" class="emoji" style="display:none">🏛️</div>
      </div>
      <div>
        <div id="pcViewFa" class="fa" dir="rtl" lang="fa" style="font-size:22px"></div>
        <div id="pcViewTrans" class="trans" style="font-size:18px;margin-top:6px"></div>
        <div id="pcViewEn" class="en" style="font-size:18px;margin-top:4px"></div>
      </div>
      <div class="tiny" id="pcUnlockNote"></div>
    </div>

    <div id="pcGrid" class="pc-grid"></div>
  </div>
</div>

<!-- Dictionary Modal -->
<div id="dictModal" class="modal">
  <div class="modal-card" style="max-width:720px">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
      <h3 style="margin:0">📚 Dictionary</h3>
      <button id="closeDict" class="btn">Close</button>
    </div>
    <div id="dictPanel" class="stat">
      <div class="dict-scroll">
        <table class="dict-table" id="dictTable"></table>
        <div id="dictEmpty" class="dict-empty" style="display:none">No learned words yet. Practice to add some!</div>
      </div>
      <div class="dict-controls">
        <button id="dictPrev" class="btn">⬅ Prev</button>
        <span id="dictPageLabel" class="tiny">Page 1 / 1</span>
        <button id="dictNext" class="btn">Next ➡</button>
      </div>
    </div>
  </div>
</div>

<!-- Settings Modal -->
<div id="settingsModal" class="modal">
  <div class="modal-card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
      <h3 style="margin:0">⚙️ Settings</h3>
      <button id="closeSettings" class="btn">Close</button>
    </div>
    <div class="grid">
      <div class="stat">
        <b>Themes (rewards)</b>
        <p class="tiny">Unlock a new theme for every <b>50</b> words learned.</p>
        <select id="themeSelect" style="width:100%"></select>
        <div id="themeNote" class="tiny" style="margin-top:6px"></div>
      </div>
      <div class="stat">
        <b>Mini Quiz</b><p class="tiny">Practice 5 items (image → type the transliteration).</p>
        <button id="startMiniQuiz" class="btn">⚡ Start Mini Quiz</button>
      </div>
      <div class="stat">
        <b>Review Mode</b><p class="tiny">Quiz only on words she has mastered (ignores SRS order).</p>
        <button id="reviewToggle" class="btn">🔁 Review All Mastered: OFF</button>
      </div>
      <div class="stat">
        <b>Sentence Practice</b>
        <p class="tiny">Read example sentences & translations.</p>
        <button id="openSentences" class="btn">📖 Open Sentence Practice</button>
      </div>
      <div class="stat">
        <b>Danger zone</b>
        <p class="tiny">Clear this profile’s score, streak, SRS, unlocks, and achievements.</p>
        <button id="resetBtn" class="btn" style="background:linear-gradient(180deg,#ef4444,#dc2626);border-color:#7f1d1d">♻️ Reset Progress</button>
        <button id="resetNamesBtn" class="btn" style="margin-top:8px;background:linear-gradient(180deg,#f59e0b,#d97706);border-color:#b45309" title="Clear all saved cat names for this profile only">🐾 Reset Cat Names</button>
      </div>
    </div>
  </div>
</div>

<!-- Sentence Practice Modal -->
<div id="sentencesModal" class="modal">
  <div class="modal-card" style="max-width:820px">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
      <h3 style="margin:0">📖 Sentence Practice</h3>
      <button id="closeSentences" class="btn">Close</button>
    </div>
    <div id="sentencePanel" class="stat">
      <div class="fa" id="sentFa" dir="rtl" style="font-size:22px"></div>
      <div class="trans" id="sentTrans" style="font-size:18px; margin-top:8px"></div>
      <div class="en" id="sentEn" style="font-size:18px; margin-top:4px"></div>
    </div>
    <div class="controls" style="justify-content:space-between">
      <div class="tiny" id="sentProgress"></div>
      <div>
        <button id="sentPrev" class="btn">⬅️ Prev</button>
        <button id="sentNext" class="primary">Next ➡️</button>
      </div>
    </div>
  </div>
</div>

<!-- Mini Quiz Modal -->
<div id="miniQuizModal" class="modal">
  <div class="modal-card" style="max-width:740px">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
      <h3 style="margin:0">⚡ Mini Quiz</h3>
      <button id="mqQuit" class="btn" title="Exit Mini Quiz">✖ Quit</button>
    </div>
    <div class="qprogress" style="height:8px;background:#0a142e;border:1px solid #1f2937;border-radius:999px;overflow:hidden;margin-bottom:12px">
      <div id="mqBar" class="bar" style="height:8px;width:0%"></div>
    </div>
    <img id="mqPic" class="mq-pic" alt="" style="display:block;margin:auto" loading="lazy"/>
    <div id="mqEmoji" class="emoji" style="display:none; text-align:center; margin-top:8px"></div>
    <input id="mqInput" class="input" placeholder="Type the transliteration…" style="margin-top:12px"/>
    <div class="controls" style="justify-content:flex-end"><button id="mqCheck" class="primary">Check</button></div>
    <div id="mqFeedback" class="feedback"></div>
  </div>
</div>

<!-- Audio Quiz Modal -->
<div id="audioQuizModal" class="modal">
  <div class="modal-card" style="max-width:760px">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
      <h3 style="margin:0">🔊 Audio Quiz</h3>
      <button id="aqQuit" class="btn" title="Exit Audio Quiz">✖ Quit</button>
    </div>
    <div class="qprogress" style="height:8px;background:#0a142e;border:1px solid #1f2937;border-radius:999px;overflow:hidden;margin-bottom:12px">
      <div id="aqBar" class="bar" style="height:8px;width:0%"></div>
    </div>
    <div class="controls" style="justify-content:space-between;margin-bottom:10px">
      <div class="tiny">Hear the word → pick the picture</div>
      <div><button id="aqPlay" class="accent">▶️ Play</button></div>
    </div>
    <div id="aqOptions" class="aq-grid" role="listbox" aria-label="Audio quiz options"></div>
    <div id="aqFeedback" class="feedback"></div>
  </div>
</div>

<script>
/* ===================== HELPER: safe element access & listeners ===================== */
const $ = id => document.getElementById(id);
const bySel = s => document.querySelector(s);
const on = (id, evt, fn) => { const el = $(id); if (el) el.addEventListener(evt, fn); };

/* Force-close overlays if any unexpected runtime error happens */
window.addEventListener('error', () => {
  const so = $('startOverlay'); if (so) so.style.display = 'none';
  const po = $('profileOverlay'); if (po) po.style.display = 'none';
});

/* ===================== PROFILED STORAGE ===================== */
let ACTIVE_PROFILE = null;
const GLOBAL_PREFIX = 'ff';
function PKEY(k){ return `${GLOBAL_PREFIX}:${ACTIVE_PROFILE||'__anon'}:${k}`; }
const store = {
  get:(k,def=null)=>{ try{ const v=localStorage.getItem(PKEY(k)); return v===null?def:JSON.parse(v); }catch{ return def; } },
  set:(k,v)=>{ try{ localStorage.setItem(PKEY(k), JSON.stringify(v)); }catch{} },
  del:(k)=>{ try{ localStorage.removeItem(PKEY(k)); }catch{} }
};

/* ===================== CONSTANTS ===================== */
const DAILY_WORDS = 5;
const SRS_INTERVALS_HOURS = [0,8,24,72,168,336];
const MINI_QUIZ_SIZE = 5;
const AUDIO_QUIZ_SIZE = 8;
const FISH_COST = 100;
const NAME_COST = 500;
const CATNIP_COST = 250;
const CATNIP_DURATION_MS = 180000;
const CATNIP_SPEED_FACTOR = 3.0;
const CATNIP_TURN_FACTOR = 0.45;
const FURNITURE_COST = 1000;

const CAT_TREE_IMG = 'images/cat_tree.png';
const CAT_TOY_IMG  = 'images/cat_toy.png';
const CAT_BOWL_IMG = 'images/cat_bowl.png';

const FURNITURE_ORDER = ['catTree','catToy','catBowl'];
const FURNITURE_META = {
  catTree:{ label:'Cat Tree', img:CAT_TREE_IMG, id:'furnCatTree', pos:{left:8,   top:8,   width:92} },
  catToy: { label:'Cat Toy',  img:CAT_TOY_IMG,  id:'furnCatToy',  pos:{left:128, top:24,  width:70} },
  catBowl:{ label:'Cat Bowl', img:CAT_BOWL_IMG, id:'furnCatBowl', pos:{left:16,  top:126, width:72} }
};

const CAT_UNLOCK_THRESHOLDS = [5, 20, 100, 250, 500];
const POSTCARD_UNLOCK_EVERY = 15;

/* Example sentences */
const SENTENCES = [
  { fa:"من آب می‌نوشم.", translit:"man âb minusham.", en:"I drink water." },
  { fa:"او یک گربه دارد.", translit:"u yek gorbe dârad.", en:"He/She has a cat." },
  { fa:"این خانه بزرگ است.", translit:"in khâne bozorg ast.", en:"This house is big." },
  { fa:"من کتاب می‌خوانم.", translit:"man ketâb mikhânam.", en:"I am reading a book." },
  { fa:"امروز هوا خوب است.", translit:"emruz havâ khub ast.", en:"The weather is good today." },
  { fa:"سگ در پارک است.", translit:"sag dar pârk ast.", en:"The dog is in the park." }
];

/* ===================== WORDS ===================== */
const words = [
  {fa:"سیب", en:"apple", translit:"sib", emoji:"🍎", audio:"audio/sib.mp3", image:"images/sib.png"},
  {fa:"کتاب", en:"book", translit:"ketâb", emoji:"📖", audio:"audio/ketab.mp3", image:"images/ketab.png"},
  {fa:"گربه", en:"cat", translit:"gorbe", emoji:"🐱", audio:"audio/gorbe.mp3", image:"images/gorbe.png"},
  {fa:"سگ", en:"dog", translit:"sag", emoji:"🐶", audio:"audio/sag.mp3", image:"images/sag.png"},
  {fa:"آب", en:"water", translit:"âb", emoji:"💧", audio:"audio/ab.mp3", image:"images/ab.png"},
  /* ... rest of your words unchanged ... */
  {fa:"نه، متشکرم", en:"no, thank you", translit:"na moteshakeram", emoji:"🙅", audio:"audio/na_moteshakeram.mp3", image:"images/na_moteshakeram.png"},
];

/* ===================== THEMES ===================== */
const THEMES = [
 {key:'default', name:'Ocean (default)', unlockAt:0, vars:{'--grad1':'#0b1229','--grad2':'#121a36','--accent-2':'#38bdf8','--accent':'#22c55e','--bg':'#0f172a'}},
 {key:'sunset', name:'Sunset', unlockAt:50, vars:{'--grad1':'#2a0f1b','--grad2':'#3a1f2a','--accent-2':'#fb923c','--accent':'#f59e0b','--bg':'#1a0c12'}},
 {key:'mint', name:'Mint', unlockAt:100,vars:{'--grad1':'#0d1f1a','--grad2':'#123227','--accent-2':'#34d399','--accent':'#10b981','--bg':'#0b1814'}},
 {key:'amethyst',name:'Amethyst', unlockAt:150,vars:{'--grad1':'#1b1330','--grad2':'#2a1f4d','--accent-2':'#a78bfa','--accent':'#8b5cf6','--bg':'#130f24'}},
 {key:'night', name:'Night Bazaar', unlockAt:200,vars:{'--grad1':'#0a0a0f','--grad2':'#15151f','--accent-2':'#60a5fa','--accent':'#22d3ee','--bg':'#0a0b12'}}
];
function applyTheme(key){
  const t = THEMES.find(x=>x.key===key) || THEMES[0];
  for(const [k,v] of Object.entries(t.vars)) document.documentElement.style.setProperty(k, v);
  state.theme = t.key; persist();
}
function learnedCount(){ return (state.covered||[]).length; }
function isThemeUnlocked(theme){ return learnedCount() >= theme.unlockAt; }
function nextUnlockNote(){
  const learned = learnedCount();
  const next = THEMES.find(t=>t.unlockAt>learned);
  return next ? `Next theme unlocks at <b>${next.unlockAt}</b> learned. (You: ${learned})` : `All themes unlocked! 🎉 (You: ${learned})`;
}
function populateThemeDropdown(){
  const sel = $('themeSelect'); if(!sel) return;
  sel.innerHTML='';
  THEMES.forEach(t=>{
    const opt=document.createElement('option');
    opt.value=t.key;
    const locked = !isThemeUnlocked(t);
    opt.textContent = locked ? `${t.name} — locked (needs ${t.unlockAt})` : t.name;
    opt.disabled = locked;
    if((state.theme||'default')===t.key) opt.selected=true;
    sel.appendChild(opt);
  });
  const note = $('themeNote'); if(note) note.innerHTML = nextUnlockNote();
}

/* ===================== POSTCARDS DATA ===================== */
const POSTCARDS = [
  { id:'persepolis', title:'Persepolis (Takht-e Jamshid)', en:'Persepolis: the ceremonial capital of the Achaemenids is a symbol of the splendor of ancient Iranian art and history.', image:'images/postcards/persepolis.jpg', emoji:'🏛️' },
  /* ... rest of your postcards unchanged ... */
];

/* ===================== UTILITIES ===================== */
function now(){return Date.now()}
function todayISO(){const d=new Date();d.setHours(0,0,0,0);return d.toISOString().slice(0,10)}
function normalizeTranslit(s){return (s||'').toLowerCase().normalize('NFKD').replace(/[\u0302\u0304]/g,'').replace(/[^a-z0-9]+/g,'').trim()}
function normalizeFa(s){return (s||'').replace(/\s+/g,'').replace(/ي/g,'ی').replace(/ك/g,'ک').replace(/[\u200C\u200F\u202A-\u202E]/g,'')}
function shuffle(a){ for(let i=a.length-1;i>0;i++){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j]]} return a }
const isMobile = () => window.matchMedia('(max-width:700px)').matches || /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
function maybeFocusInput(){ const el=$('typeInput'); if(el && !isMobile()) el.focus(); }

// FIX: null-safe fallback in media setter
function setImageWithFallback(imgEl, emojiEl, item){
  if(!imgEl) return;
  const safe = item || { emoji:'❓', en:'', image:'' };
  const useEmoji = ()=>{
    imgEl.style.display='none'; imgEl.removeAttribute('src');
    if(emojiEl){ emojiEl.style.display='block'; emojiEl.textContent = safe.emoji || '❓'; }
  };
  if(safe.image){
    if(emojiEl) emojiEl.style.display='none';
    imgEl.onerror = useEmoji;
    imgEl.onload = ()=>{ imgEl.style.display='block'; if(emojiEl) emojiEl.style.display='none'; };
    imgEl.alt = safe.en || '';
    imgEl.src = safe.image;
    imgEl.style.display='block';
  }else{
    useEmoji();
  }
}

/* ===================== STATE (per profile) ===================== */
const defaultState = ()=>({
  score:0, streak:0, srs:{}, covered:[], start_date:null, unlocked_count:0,
  achievements:{first10:false,perfectMini:false,streak7:false,mastered50:false}, achFx:{},
  mapUnlocked:0, mapDays:[],
  settings:{reviewAll:false, musicOn:false, musicVol:0.28},
  theme:'default',
  inventory:{fish:0, catnip:0, nameTokens:0},
  furniture:{ catTree:false, catToy:false, catBowl:false },
  catNames:{}, nameCursor:-1, showCatNames:false
});
let state = defaultState();

let mode='learn', order=[], idx=0;
let sessionTotal = 0;
let sessionAnswered = new Set();
function resetSessionProgress(){ sessionTotal = unlockedCount(); sessionAnswered = new Set(); updateSessionBar(); }
function updateSessionBar(){ const pct = Math.round((sessionAnswered.size/Math.max(1,sessionTotal))*100); const bar=$('progressBar'); if(bar) bar.style.width = pct + '%'; }

/* SRS helpers */
function ensureSRS(i){ if(!state.srs[i]) state.srs[i]={stage:0,due:0,seen:0,correct:0,wrong:0}; return state.srs[i]; }
function isDue(i){ return ensureSRS(i).due <= now(); }
function scheduleAfter(i,h){ ensureSRS(i).due = now()+h*3600*1000; }
function getCoveredSet(){ return new Set(state.covered||[]); }
function addCovered(i){ const s=getCoveredSet(); s.add(i); state.covered=[...s]; persist(); }

/* Cats unlocked from milestones */
function computeCatsUnlocked(){ const learned = learnedCount(); return CAT_UNLOCK_THRESHOLDS.filter(t => learned >= t).length; }

function initDailyUnlock(){
  if(!state.start_date){ state.start_date=todayISO(); }
  const startDate = new Date(state.start_date+'T00:00:00');
  const dNow = new Date(); dNow.setHours(0,0,0,0);
  const diffDays = Math.floor((dNow - startDate)/86400000);
  const shouldUnlock = Math.min(words.length, (diffDays+1)*DAILY_WORDS);
  const current = Number(state.unlocked_count) || 0;
  state.unlocked_count = Math.max(current, shouldUnlock);
  // FIX: guarantee at least DAILY_WORDS on first run
  if(!Number.isFinite(state.unlocked_count) || state.unlocked_count < 1){
    state.unlocked_count = Math.min(words.length, DAILY_WORDS);
  }
  persist();
}
function unlockedCount(){
  // FIX: robust numeric coercion
  const u = Number(state.unlocked_count);
  if(Number.isFinite(u) && u >= 1) return Math.min(words.length, u);
  return Math.min(words.length, DAILY_WORDS);
}
function unlockedIndices(){ return [...Array(unlockedCount()).keys()]; }
function masteredIndices(){ return [...getCoveredSet()].filter(i=>i<unlockedCount()); }
function dueIndices(){ return unlockedIndices().filter(i=>isDue(i)); }
function quizPool(){ const due=dueIndices(); if(due.length) return due; const m=masteredIndices(); return m.length?m:unlockedIndices(); }
function learnPool(){ const u=unlockedIndices(), due=u.filter(i=>isDue(i)), rest=u.filter(i=>!isDue(i)); return [...due,...rest]; }

/* ===================== PERSIST ===================== */
function persist(){
  state.mapUnlocked = computeCatsUnlocked();
  store.set('state', state);
  reflectBadges();
  updateBadges();
  renderMap();
  renderFurniture();
  populateThemeDropdown();
  updateShopUI();
  updateNamesToggleUI();
  updateNamesVisibility();
  if($('postcardsModal')?.style.display==='grid'){ renderPostcardsGrid(); const u=postcardsUnlockedCount(); renderPostcardView(u?u-1:-1); }
  if($('dictModal')?.style.display==='grid'){ renderDictionary(); }
}
function loadState(){
  state = store.get('state', defaultState());
  // normalize missing branches
  if(!state.inventory) state.inventory = {fish:0, catnip:0, nameTokens:0};
  if(state.inventory.fish===undefined) state.inventory.fish=0;
  if(state.inventory.catnip===undefined) state.inventory.catnip=0;
  if(state.inventory.nameTokens===undefined) state.inventory.nameTokens=0;
  if(!state.furniture) state.furniture = { catTree:false, catToy:false, catBowl:false };
  if(state.furniture.catTree===undefined) state.furniture.catTree=false;
  if(state.furniture.catToy===undefined)  state.furniture.catToy=false;
  if(state.furniture.catBowl===undefined) state.furniture.catBowl=false;
  if(!state.catNames) state.catNames = {};
  if(typeof state.nameCursor!=='number') state.nameCursor = -1;
  if(typeof state.showCatNames!=='boolean') state.showCatNames = false;
  if(!state.achievements) state.achievements = defaultState().achievements;
  if(!state.settings) state.settings = {reviewAll:false, musicOn:false, musicVol:0.28};
  if(typeof state.settings.musicOn!=='boolean') state.settings.musicOn=false;
  if(typeof state.settings.musicVol!=='number') state.settings.musicVol=0.28;
  // FIX: ensure unlocked_count is numeric
  if(typeof state.unlocked_count !== 'number' || !Number.isFinite(state.unlocked_count)){
    state.unlocked_count = 0;
  }
  state.achFx = state.achFx || {};
  initDailyUnlock();
  applyTheme(state.theme||'default');
  state.mapUnlocked = computeCatsUnlocked();
}

/* ======== (Optional) Nicole cloud sync: intact ======== */
const SYNC_ENDPOINT = "https://ff-sync.9rmcqs6hjc.workers.dev";
const SYNC_DOC_ID = "nicole";
const SYNC_WRITE_TOKEN = "Gravity123!!";
function mergeStates(local, remote){
  if(!remote || !remote.updated_at) return local;
  const lts = local?.updated_at || 0;
  const rts = remote?.updated_at || 0;
  const base = (lts >= rts) ? {...local} : {...remote};
  const ls = local?.start_date, rs = remote?.start_date;
  const earliestStart = (ls && rs) ? (ls < rs ? ls : rs) : (ls || rs || todayISO());
  base.start_date = earliestStart;
  const dNow = new Date(); dNow.setHours(0,0,0,0);
  const sDate = new Date(earliestStart + 'T00:00:00');
  const diffDays = Math.floor((dNow - sDate)/86400000);
  const shouldUnlock = Math.min(words.length, (diffDays + 1) * DAILY_WORDS);
  const localUnlocked  = Number(local?.unlocked_count)||0;
  const remoteUnlocked = Number(remote?.unlocked_count)||0;
  base.unlocked_count = Math.max(localUnlocked, remoteUnlocked, shouldUnlock);
  const cov = new Set([...(local.covered||[]), ...(remote.covered||[])]); base.covered = [...cov];
  base.score  = Math.max(local.score||0, remote.score||0);
  base.streak = (lts >= rts ? local.streak : remote.streak) || 0;
  base.inventory = {
    fish:      Math.max(local.inventory?.fish||0,      remote.inventory?.fish||0),
    catnip:    Math.max(local.inventory?.catnip||0,    remote.inventory?.catnip||0),
    nameTokens:Math.max(local.inventory?.nameTokens||0,remote.inventory?.nameTokens||0)
  };
  base.furniture = {
    catTree: !!(local.furniture?.catTree || remote.furniture?.catTree),
    catToy:  !!(local.furniture?.catToy  || remote.furniture?.catToy),
    catBowl: !!(local.furniture?.catBowl || remote.furniture?.catBowl),
  };
  base.catNames   = (lts >= rts ? {...(local.catNames||{})} : {...(remote.catNames||{})});
  base.nameCursor = (lts >= rts ? (local.nameCursor??-1)    : (remote.nameCursor??-1));
  base.achievements = {...(local.achievements||{}), ...(remote.achievements||{})};
  base.achFx        = {...(local.achFx||{}),        ...(remote.achFx||{})};
  base.showCatNames = (lts >= rts ? !!local.showCatNames : !!remote.showCatNames);
  return base;
}
async function syncPullNicole(){
  if(!SYNC_ENDPOINT || ACTIVE_PROFILE!=="Nicole") return;
  try{
    const res = await fetch(`${SYNC_ENDPOINT}/p/${SYNC_DOC_ID}`);
    const remote = await res.json().catch(()=>null);
    if(remote && Object.keys(remote).length){
      state = mergeStates(state, remote);
      _persist();
    }
  }catch{}
}
async function syncPushNicole(){
  if(!SYNC_ENDPOINT || ACTIVE_PROFILE!=="Nicole") return;
  try{
    const payload = JSON.stringify({...state, updated_at: Date.now(), profile: ACTIVE_PROFILE});
    await fetch(`${SYNC_ENDPOINT}/p/${SYNC_DOC_ID}`, {
      method:"PUT", headers:{ "Content-Type":"application/json", ...(SYNC_WRITE_TOKEN?{"X-Token":SYNC_WRITE_TOKEN}:{}) }, body:payload
    });
  }catch{}
}
let _persist = persist, _syncTimer=null;
function syncPushDebouncedNicole(){ clearTimeout(_syncTimer); _syncTimer=setTimeout(syncPushNicole,600); }
persist = function(){ _persist(); if(ACTIVE_PROFILE==="Nicole") syncPushDebouncedNicole(); };
function initSharedNicoleSync(){
  if (ACTIVE_PROFILE !== "Nicole" || !SYNC_ENDPOINT) return;
  syncPullNicole().then(()=>syncPushNicole());
  document.addEventListener("visibilitychange", ()=>{ if(document.visibilityState==="visible" && ACTIVE_PROFILE==="Nicole") syncPullNicole(); });
  window.addEventListener("online", ()=>{ if(ACTIVE_PROFILE==="Nicole") syncPushNicole(); });
}

/* ===================== UI UPDATE ===================== */
function updateBadges(){
  const pb=$('profileBadge'), sb=$('scoreBadge'), stb=$('streakBadge'), ub=$('unlockedBadge');
  if(pb) pb.textContent = `Profile: ${ACTIVE_PROFILE||'—'}`;
  if(sb) sb.textContent = `Score: ${state.score}`;
  if(stb) stb.textContent = `Streak: ${state.streak} 🔥`;
  if(ub) ub.textContent= `${unlockedCount()}/${words.length} unlocked`;
  updateSessionBar();
}
function reflectBadges(){
  const A = state.achievements || {};
  const defs = [
    {key:'first10', label:'First 10 mastered', ico:'🥇'},
    {key:'perfectMini', label:'Perfect Mini Quiz', ico:'🎯'},
    {key:'streak7', label:'7-day streak', ico:'🏅'},
    {key:'mastered50', label:'50 mastered', ico:'💪'}
  ];
  const box = $('achList'); if(!box) return;
  box.classList.add('badges-grid'); box.innerHTML = '';
  defs.forEach(d=>{
    const el = document.createElement('div');
    el.className = 'badge-tile' + (A[d.key] ? ' earned' : '');
    el.dataset.key = d.key;
    el.innerHTML = `<div class="ico">${A[d.key]?d.ico:'⬜'}</div><div class="label">${d.label}</div>`;
    box.appendChild(el);
  });
}

/* ===================== ROAMING CATS (unchanged) ===================== */
/* ... cats code unchanged ... */

/* ===================== SENTENCE PRACTICE / MINI QUIZ / AUDIO QUIZ (unchanged) ===================== */
/* ... quiz code unchanged ... */

/* ===================== CELEBRATIONS & BADGE HELPERS (unchanged) ===================== */
/* ... celebration code unchanged ... */

/* ===================== AUDIO (word audio cache) ===================== */
const audioCache=new Map();
function getAudio(item){
  // FIX: null-safe audio
  const url = item && (item.audio || `audio/${(item.translit||'').toLowerCase()}.mp3`);
  if(!url){ const a=new Audio(); return a; }
  if(!audioCache.has(url)){const a=new Audio();a.preload='auto';a.src=url;audioCache.set(url,a);}
  return audioCache.get(url);
}
async function playYourAudio(){ const gi=order[idx], item=words[gi]; try{ const a=getAudio(item); a.currentTime=0; await a.play(); }catch{} }

/* ===================== SPEECH RECOG (unchanged) ===================== */
/* ... speech code unchanged ... */

/* ===================== ANSWERING / MAP (unchanged) ===================== */
/* ... handleAnswer etc unchanged ... */

/* ===================== MAP & FURNITURE RENDER (unchanged) ===================== */
/* ... map & furniture code unchanged ... */

/* ===================== CATNIP PARTY (unchanged) ===================== */
/* ... catnip code unchanged ... */

/* ===================== EVENTS & UI ===================== */
on('listenBtn','click', playYourAudio);
on('typeInput','keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); $('checkBtn')?.click(); } });
on('checkBtn','click', ()=>{
  const gi=order[idx], item=words[gi]; const guess=normalizeTranslit(($('typeInput')?.value)||'');
  if(!guess){ const tf=$('typeFeedback'); if(tf){ tf.textContent='Type your guess first!'; tf.className='feedback warn'; } return; }
  const ti=$('typeInput'); if(ti) ti.value=''; maybeFocusInput();
  handleAnswer(guess===normalizeTranslit(item.translit), gi, 'typing');
});
on('skipBtn','click', ()=>{ const ti=$('typeInput'); if(ti) ti.value=''; state.streak=0; persist(); next(); });
on('nextBtn','click', ()=>{ const ti=$('typeInput'); if(ti) ti.value=''; next(); });

function startMode(newMode){ endMiniQuiz(); endAudioQuiz(); mode = newMode; resetSessionProgress(); ensureOrder(); showItem(); }
on('learnBtn','click', ()=> startMode('learn'));
on('quizBtn','click', ()=> startMode('quiz'));
on('audioQuizBtn','click', ()=> openAudioQuiz());
on('hintBtn','click', ()=>{ if(mode!=='learn') return; const gi=order[idx], item=words[gi]; if($('trans')) $('trans').textContent=item.translit; if($('en')) $('en').textContent=item.en; });
on('revealBtn','click', ()=>{ const gi=order[idx], item=words[gi]; if($('fa')) $('fa').textContent=item.fa; if($('trans')) $('trans').textContent=item.translit; const s=$('sadFace'); if(s){ s.style.display='block'; setTimeout(()=>s.classList.add('fade-out'),700); setTimeout(()=>{s.classList.remove('fade-out'); s.style.display='none';},1500);} });

on('openAchievements','click', ()=>{ reflectBadges(); const m=$('achModal'); if(m) m.style.display='grid'; });
on('closeAch','click', ()=> $('achModal')?.style && ( $('achModal').style.display='none' ));
on('openMap','click', ()=>{ renderMap(); const m=$('mapModal'); if(!m) return; m.style.display='grid'; requestAnimationFrame(startCats); updateShopUI(); updateNamesToggleUI(); updateNamesVisibility(); });
on('closeMap','click', ()=>{ const m=$('mapModal'); if(m) m.style.display='none'; stopCats(); });

/* ... shop / naming / furniture handlers unchanged ... */

on('openSettings','click', ()=>{ const m=$('settingsModal'); if(m) m.style.display='grid'; const r=$('reviewToggle'); if(r) r.textContent=`🔁 Review All Mastered: ${state.settings?.reviewAll?'ON':'OFF'}`; populateThemeDropdown(); });
on('closeSettings','click', ()=> { const m=$('settingsModal'); if(m) m.style.display='none'; });
on('settingsModal','click', e=>{ if(e.target.id==='settingsModal') e.currentTarget.style.display='none'; });
on('reviewToggle','click', ()=>{ state.settings.reviewAll = !state.settings.reviewAll; persist(); const r=$('reviewToggle'); if(r) r.textContent=`🔁 Review All Mastered: ${state.settings.reviewAll?'ON':'OFF'}`; });
on('openSentences','click', ()=>{ const m=$('settingsModal'); if(m) m.style.display='none'; openSentences(); });
on('closeSentences','click', ()=> { const m=$('sentencesModal'); if(m) m.style.display='none'; });
on('sentPrev','click', ()=>{ sentenceIdx--; renderSentence(); });
on('sentNext','click', ()=>{ sentenceIdx++; renderSentence(); });

/* Reset buttons unchanged ... */

/* Midnight countdown */
function msUntilNextMidnight(){ const n=new Date(), t=new Date(n); t.setHours(24,0,0,0); return t-n; }
function fmt(ms){ const s=Math.floor(ms/1000); const h=Math.floor(s/3600), m=Math.floor((s%3600)/60); return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`; }
function showMidnight(){ alert(`New words unlock at local midnight.\nTime remaining: ${fmt(msUntilNextMidnight())}`); }
on('midnightBtn','click', showMidnight);

/* ===================== STARTUP FLOW — FAIL‑SAFE ===================== */
function useProfile(name){
  ACTIVE_PROFILE = String(name||'').trim() || 'Guest';
  loadState(); const pb=$('profileBadge'); if(pb) pb.textContent = `Profile: ${ACTIVE_PROFILE}`;
  const po=$('profileOverlay'); if(po) po.style.display='none';
  const so=$('startOverlay'); if(so) so.style.display='grid';
  if (ACTIVE_PROFILE === "Nicole") initSharedNicoleSync();
}

/* Developer PIN reveal for Sia (unchanged) */
(function(){ const overlay = $('profileOverlay'); const devBtn = $('quickSia'); let seq = '', timer=null, revealed=false;
  window.addEventListener('keydown', (e)=>{ if(!overlay || overlay.style.display!=='grid' || revealed) return; if(!/^[0-9]$/.test(e.key)) return;
    seq+=e.key; clearTimeout(timer); timer=setTimeout(()=>{seq='';},1500);
    if(seq.endsWith('3232')){ revealed=true; if(devBtn) devBtn.style.display='inline-block'; const note=document.createElement('div'); note.className='tiny'; note.textContent='Developer button unlocked'; note.style.marginTop='10px'; overlay.querySelector('.overlay-card').appendChild(note); }
  });
})();

/* Safer start */
function startAs(m){
  const so=$('startOverlay'); if(so) so.style.display='none';
  try{
    if(m==='audio'){ openAudioQuiz(); return; }
    mode=m; resetSessionProgress(); ensureOrder(); showItem();
  }catch(err){
    console.error('startAs error:', err);
    try{ ensureOrder(); showItem(); }catch(_){}
  }
}

/* FIX: single, idempotent binding for profile choices */
function bindProfileButtons(){
  const nic = $('quickNicole'), sia = $('quickSia');
  if(nic && !nic.__bound){ nic.__bound = true; nic.addEventListener('click', ()=> useProfile('Nicole')); }
  if(sia && !sia.__bound){ sia.__bound = true; sia.addEventListener('click', ()=>{ const pin = prompt('Enter developer PIN:'); if(pin === '3232'){ useProfile('Sia'); } else{ alert('Incorrect PIN.'); } }); }
}

/* Start buttons (guarded) */
function bindStartButtons(){
  const l = $('startLearn'), q = $('startQuiz');
  if(l && !l.__bound){
    l.__bound = true;
    l.addEventListener('click', (e)=>{ e.preventDefault(); e.stopPropagation(); startAs('learn'); }, {capture:true});
  }
  if(q && !q.__bound){
    q.__bound = true;
    q.addEventListener('click', (e)=>{ e.preventDefault(); e.stopPropagation(); startAs('quiz'); }, {capture:true});
  }
}
document.addEventListener('DOMContentLoaded', bindStartButtons);

/* Keyboard fallback */
document.addEventListener('keydown', (e)=>{
  const so = $('startOverlay');
  if(!so || so.style.display!=='grid') return;
  if(e.key==='Enter'){ e.preventDefault(); startAs('learn'); }
  if(e.key==='Escape'){ e.preventDefault(); startAs('quiz'); }
});

/* Close modals on backdrop click (safe) */
document.addEventListener('click', (e)=>{
  if(e.target.id==='settingsModal') e.target.style.display='none';
  if(e.target.id==='sentencesModal') e.target.style.display='none';
  if(e.target.id==='achModal') e.target.style.display='none';
  if(e.target.id==='mapModal'){ e.target.style.display='none'; stopCats(); }
  if(e.target.id==='postcardsModal') e.target.style.display='none';
  if(e.target.id==='dictModal') e.target.style.display='none';
  if(e.target.id==='miniQuizModal'){ endMiniQuiz(); }
  if(e.target.id==='audioQuizModal'){ endAudioQuiz(); }
});

/* Item order & display */
// FIX: always ensure a non-empty order; fallback to [0]
function ensureOrder(){
  const pool = (mode==='quiz')? quizPool(): learnPool();
  order = (pool && pool.length) ? pool.slice() : [0];
  shuffle(order); idx=0;
}
function showImageOrEmoji(item){ const pic=$('pic'), emo=$('emoji'); setImageWithFallback(pic, emo, item); }
function showItem(){
  const pool = (mode==='quiz')? quizPool(): learnPool();
  if(!pool.length){ console.warn('Empty pool; falling back to first item'); order = [0]; idx = 0; }
  if(order.length===0 || order.some(i=>!pool.includes(i))) ensureOrder();
  const gi = (order.length ? (order[idx % order.length]) : 0);
  const item = words[gi] || words[0];
  showImageOrEmoji(item);
  if(mode==='quiz'){
    if($('en')) $('en').textContent=item.en;
    if($('fa')) $('fa').textContent='•••';
    if($('trans')) $('trans').textContent='—';
  }else{
    if($('en')) $('en').textContent=item.en;
    if($('fa')) $('fa').textContent=item.fa;
    if($('trans')) $('trans').textContent=item.translit;
  }
  const lb=$('listenBtn'), rb=$('revealBtn'), hb=$('hintBtn');
  if(lb) lb.style.display = (mode==='quiz')?'none':'inline-flex';
  if(rb) rb.style.display = (mode==='quiz')?'inline-flex':'none';
  if(hb) hb.style.display = 'none';
  const ti=$('typeInput'); if(ti){ ti.value=''; maybeFocusInput(); }
}
function next(){ idx=(idx+1)%Math.max(1,order.length||1); showItem(); }

/* Night sky (unchanged) */
/* ... night sky code unchanged ... */

/* ===================== POSTCARDS UI (unchanged) ===================== */
/* ... postcards code unchanged ... */

/* ===================== DICTIONARY (unchanged) ===================== */
/* ... dictionary code unchanged ... */

/* ===================== BACKGROUND MUSIC (unchanged) ===================== */
/* ... music code unchanged ... */

/* ===================== INIT ===================== */
initSpeech();
bindStartButtons();
bindProfileButtons();
updateMusicBtnUI();
</script>
</body>
</html>
