<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Farsi Fun ‚Äî Learn Persian Basics</title>
<style>
  :root{
    --bg:#0f172a;--card:#111827;--muted:#94a3b8;--text:#e5e7eb;--accent:#22c55e;--accent-2:#38bdf8;--warn:#f59e0b;--err:#ef4444;
    --grad1:#0b1229; --grad2:#121a36;
  }
  *{box-sizing:border-box}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans,Ubuntu,Cantarell,Helvetica Neue,Arial,"Apple Color Emoji","Segoe UI Emoji";
       margin:0;background:linear-gradient(135deg,var(--bg),#0b1028);color:var(--text)}
  header{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:16px clamp(16px,4vw,32px);
         position:sticky;top:0;background:rgba(15,23,42,.75);backdrop-filter:blur(10px);border-bottom:1px solid #1f2937;z-index:5}
  header h1{font-size:clamp(18px,2.5vw,28px);margin:0;letter-spacing:.5px;cursor:pointer}
  .stats{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .badge{background:#111827;border:1px solid #1f2937;padding:6px 10px;border-radius:999px;font-size:14px;color:var(--muted)}
  .icon-btn{display:inline-flex;align-items:center;justify-content:center;width:40px;height:40px;border-radius:10px;
            background:#111827;border:1px solid #1f2937;cursor:pointer}
  .icon-btn:hover{background:#0b1229;border-color:#263042}
  .btn,button,select{appearance:none;border:none;background:#111827;color:#e5e7eb;border:1px solid #1f2937;padding:10px 14px;border-radius:12px;cursor:pointer}
  .btn:hover,button:hover,select:hover{background:#0b1229;border-color:#263042}
  .primary{background:linear-gradient(180deg,var(--accent),#16a34a);border-color:#14532d}
  .accent{background:linear-gradient(180deg,var(--accent-2),#0ea5e9);border-color:#075985}

  main{max-width:980px;margin:24px auto;padding:0 clamp(16px,4vw,32px) 120px}
  .card{background:linear-gradient(180deg,var(--grad1),var(--grad2));border:1px solid #1f2937;border-radius:16px;padding:clamp(16px,3vw,28px)}
  .row{display:grid;grid-template-columns:1fr;gap:16px}
  @media(min-width:860px){.row{grid-template-columns:1fr 1fr}}
  .media-wrap{display:grid;place-items:center}
  .pic,.mq-pic{width:min(420px,92%);height:min(280px,45vw);object-fit:contain;background:#0b1229;border:1px solid #1f2937;border-radius:16px;display:none}
  .emoji{font-size:clamp(64px,12vw,120px);text-align:center;line-height:1;filter:drop-shadow(0 10px 20px rgba(0,0,0,.35))}
  .word{display:flex;flex-direction:column;gap:6px;align-items:flex-start;justify-content:center}
  .en{font-size:clamp(26px,3.4vw,34px);font-weight:700;color:#e2e8f0}
  .fa{font-size:clamp(18px,2.6vw,22px);color:#cbd5e1;direction:rtl;text-align:right}
  .trans{font-size:clamp(26px,3.4vw,34px);font-weight:600;color:#e2e8f0}
  .controls{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-top:10px}
  .input{background:#0b1229;border:1px solid #1f2937;padding:12px 14px;border-radius:12px;color:#e5e7eb;width:100%;font-size:16px}
  .feedback{margin-top:8px;min-height:24px;font-size:15px}
  .ok{color:var(--accent)}
  .warn{color:var(--warn)}
  .err{color:var(--err)}
  .progress{margin-top:12px;height:10px;background:#0b1229;border-radius:999px;border:1px solid #1f2937;overflow:hidden}
  .bar{height:100%;width:0%;background:linear-gradient(90deg,#38bdf8,#22c55e);transition:width .3s ease}
  .mode{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px;align-items:center}
  .tiny{font-size:12px;color:#94a3b8}
  .cele-msg{position:fixed;left:50%;bottom:72px;transform:translateX(-50%);background:rgba(17,24,39,.92);border:1px solid #1f2937;padding:14px 18px;border-radius:14px;font-weight:800;z-index:20}
  .fade-out{animation:fadeOut .9s ease forwards}@keyframes FadeOut{to{opacity:0}}
  @keyframes fadeOut { to { opacity:0 } }

  .overlay{position:fixed;inset:0;background:radial-gradient(1000px 600px at 50% -10%, rgba(56,189,248,.25), transparent 40%), rgba(15,23,42,.94);display:grid;place-items:center;z-index:10}
  .overlay-card,.modal-card{background:linear-gradient(180deg,#0b1229,#121a36);border:1px solid #1f2937;border-radius:18px;padding:24px;box-shadow:0 20px 60px rgba(0,0,0,.35);max-width:760px;margin:0 16px}

  /* Standard modal backdrop */
  .modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.45);z-index:12}
  /* Blur for mini quiz & sentences */
  #miniQuizModal,#sentencesModal{backdrop-filter:blur(12px) saturate(120%);-webkit-backdrop-filter:blur(12px) saturate(120%)}

  .grid{display:grid;gap:10px}
  @media(min-width:760px){.grid{grid-template-columns:1fr 1fr}}
  .stat{background:#0b1229;border:1px solid #1f2937;border-radius:12px;padding:10px}
  .chip{display:inline-flex;gap:6px;background:#0b1229;border:1px solid #1f2937;border-radius:999px;padding:6px 10px;font-size:12px;color:#94a3b8;margin:2px 4px 0 0}

  /* Bazaar */
  .map-wrap{position:relative;margin-top:10px}
  .map{display:grid;grid-template-columns:repeat(4, minmax(60px,1fr));gap:8px;position:relative;z-index:1}
  .tile{aspect-ratio:1/1;background:#0b1229;border:1px dashed #334155;border-radius:10px;display:grid;place-items:center;font-size:28px;color:#334155}

  /* roaming cats overlay */
  .cat-layer{position:absolute;inset:0;pointer-events:none;z-index:2;overflow:hidden}
  .cat{position:absolute;font-size:32px;filter:drop-shadow(0 6px 10px rgba(0,0,0,.35));will-change:transform,left,top}
  .cat.flip{transform:scaleX(-1)}
  @media(min-width:760px){ .cat{font-size:40px} }

  /* Arena when cats are unlocked (grid hidden) */
  .map-wrap.arena{
    background:#0b1229;border:1px solid #1f2937;border-radius:12px;
    height:clamp(260px, 45vh, 380px);
  }

  /* Rewards panel */
  .shop-row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .muted{color:#94a3b8}

  /* Hearts when feeding */
  .heart{position:absolute;font-size:20px;pointer-events:none;opacity:0;animation:floatHeart 1.6s ease-out forwards}
  @keyframes floatHeart{
    0%{transform:translateY(0) scale(.8);opacity:.9}
    60%{opacity:1}
    100%{transform:translateY(-60px) scale(1.25);opacity:0}
  }

  /* Heavy blur for profile/start overlays */
  #profileOverlay,#startOverlay{
    background: radial-gradient(1000px 600px at 50% -10%, rgba(56,189,248,.25), transparent 40%), rgba(15,23,42,.60);
    backdrop-filter: blur(28px) saturate(120%);
    -webkit-backdrop-filter: blur(28px) saturate(120%);
  }

  /* ----- Mobile-only header/input behavior ----- */
  @media (max-width: 700px){
    header{ position: static; top:auto; background:rgba(15,23,42,.9); backdrop-filter:none; }
    main{ padding:0 16px 120px; }
  }

  /* === BADGES UPGRADE === */
  #achList{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .badge-item{
    display:flex;align-items:center;gap:10px;padding:10px 12px;border:1px solid #263042;border-radius:12px;
    background:#0b1229; position:relative; overflow:hidden;
    transition:filter .25s ease, opacity .25s ease, box-shadow .25s ease, transform .25s ease;
  }
  .badge-item .bicon{font-size:18px}
  .badge-item .bname{font-size:14px;color:#cbd5e1}
  .badge-item.locked{opacity:.45;filter:grayscale(1)}
  .badge-item.earned{
    opacity:1; filter:none;
    box-shadow:0 0 0 1px #1f2937, 0 0 18px rgba(56,189,248,.35), inset 0 0 0 9999px rgba(56,189,248,.04);
    animation:badgePulse 2.2s ease-in-out infinite;
  }
  @keyframes badgePulse{
    0%,100%{box-shadow:0 0 0 1px #1f2937, 0 0 16px rgba(56,189,248,.28), inset 0 0 0 9999px rgba(56,189,248,.04)}
    50%{box-shadow:0 0 0 1px #1f2937, 0 0 26px rgba(34,197,94,.50), inset 0 0 0 9999px rgba(34,197,94,.06)}
  }
  /* one-time sparkle */
  .badge-item.sparkle::after{
    content:""; position:absolute; inset:-40%;
    background:
      radial-gradient(circle at 20% 30%, rgba(255,255,255,.9), transparent 40%),
      radial-gradient(circle at 80% 60%, rgba(255,255,255,.8), transparent 35%),
      radial-gradient(circle at 50% 50%, rgba(255,255,255,.7), transparent 30%);
    filter:blur(6px); opacity:0; pointer-events:none;
    animation:badgeSpark 900ms ease-out forwards;
  }
  @keyframes badgeSpark{
    0%{transform:scale(.6) rotate(0deg); opacity:0}
    30%{opacity:.9}
    100%{transform:scale(1.6) rotate(35deg); opacity:0}
  }
</style>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js" defer></script>
</head>
<body>
<header>
  <h1>‚ú® Farsi Fun ‚Äî Learn Persian Basics</h1>
  <div class="stats">
    <div class="badge" id="profileBadge">Profile: ‚Äî</div>
    <div class="badge" id="scoreBadge">Score: 0</div>
    <div class="badge" id="streakBadge">Streak: 0 üî•</div>
    <div class="badge" id="unlockedBadge">0/0 unlocked</div>
    <button id="openMap" class="icon-btn" title="Bazaar Map">üó∫Ô∏è</button>
    <button id="openAchievements" class="icon-btn" title="Badges">üèÜ</button>
    <button id="openSettings" class="icon-btn" title="Settings">‚öôÔ∏è</button>
  </div>
</header>

<!-- Profile chooser -->
<div id="profileOverlay" class="overlay" style="display:grid">
  <div class="overlay-card" style="position:relative; text-align:center">
    <h2 style="margin-top:0">Who are you?</h2>
    <p class="tiny" style="margin-bottom:20px">Choose your profile to continue</p>
    <button id="quickNicole" class="primary" style="font-size:20px; padding:14px 28px;">Nicole</button>
    <button id="quickSia" style="position:absolute; bottom:10px; right:10px; font-size:12px; padding:4px 8px; opacity:0.75; display:none;" class="btn" title="Developer">Siyavash</button>
  </div>
</div>

<!-- Start screen -->
<div id="startOverlay" class="overlay" style="display:none">
  <div class="overlay-card">
    <h2>How do you want to learn today?</h2>
    <p>Pick a mode to get started. You can switch later.</p>
    <div style="display:flex; gap:12px; flex-wrap:wrap">
      <button id="startLearn" class="primary" type="button">üìö Learn Mode</button>
      <button id="startQuiz" class="accent" type="button">üéØ Quiz Mode</button>
    </div>
    <p class="tiny" style="margin-top:10px">Tip: Use <b>Chrome</b>. <b>Listen</b> plays your MP3s. New words unlock at <button id="midnightBtn0" class="btn" style="padding:2px 6px">midnight</button>.</p>
  </div>
</div>

<main>
  <div class="mode">
    <button id="learnBtn" class="btn">Learn Mode</button>
    <button id="quizBtn" class="btn">Quiz Mode</button>
    <span class="tiny">New words unlock at <button id="midnightBtn" class="btn" style="padding:2px 6px">midnight</button> ‚è∞</span>
  </div>

  <div class="card">
    <div class="row">
      <div class="media-wrap">
        <img id="pic" class="pic" alt="" />
        <div class="emoji" id="emoji">üçé</div>
      </div>
      <div class="word" id="wordWrap">
        <div class="en" id="en">apple</div>
        <div class="fa" id="fa" dir="rtl">ÿ≥€åÿ®</div>
        <div class="trans" id="trans">sib</div>

        <!-- Main practice UI -->
        <div id="learnUI">
          <div class="controls">
            <button id="listenBtn" class="accent">üîä Listen</button>
            <button id="sayBtn" class="btn" disabled title="(optional speech recog)">üéôÔ∏è Say it</button>
            <button id="hintBtn" class="btn">üí° Hint</button>
            <button id="revealBtn" class="btn">üëÄ Reveal</button>
            <button id="nextBtn" class="primary">‚û°Ô∏è Next</button>
          </div>
          <div class="feedback" id="speechFeedback"></div>

          <label class="tiny" for="typeInput">Type the pronunciation (English letters):</label>
          <input class="input" id="typeInput" placeholder="e.g., sib" autocapitalize="off" autocorrect="off" spellcheck="false" inputmode="latin"/>

          <div class="controls">
            <button id="checkBtn" class="primary">‚úÖ Check</button>
            <button id="skipBtn" class="btn">‚è≠Ô∏è Skip</button>
          </div>
          <div class="feedback" id="typeFeedback"></div>
          <div class="progress"><div class="bar" id="progressBar"></div></div>
        </div>
      </div>
    </div>
  </div>
</main>

<footer style="padding:16px;text-align:center;color:#94a3b8">
  Have fun!
</footer>

<div id="celebration" class="cele-msg" style="display:none">let's goooooo üéâ</div>
<div id="sadFace" class="cele-msg" style="display:none">üò¢</div>

<!-- Achievements Modal -->
<div id="achModal" class="modal">
  <div class="modal-card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
      <h3 style="margin:0">üèÜ Badges</h3>
      <button id="closeAch" class="btn">Close</button>
    </div>
    <div id="achList" class="grid"></div>
  </div>
</div>

<!-- Bazaar Map Modal -->
<div id="mapModal" class="modal">
  <div class="modal-card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
      <h3 style="margin:0">üó∫Ô∏è Persian Bazaar Progress</h3>
      <div class="shop-row">
        <button id="openShop" class="btn accent" title="Redeem cat rewards">üí† Redeem</button>
        <button id="closeMap" class="btn">Close</button>
      </div>
    </div>
    <p class="tiny">Lots of cats live here üêà.</p>
    <div class="tiny" id="catUnlockMsg"></div>
    <div class="map-wrap" id="mapWrap">
      <div id="mapGrid" class="map"></div>
      <div id="catLayer" class="cat-layer"></div>
    </div>

    <!-- Cat Rewards panel (toggles from Redeem button) -->
    <div id="shopPanel" class="stat" style="display:none; margin-top:10px">
      <div class="shop-row" style="justify-content:space-between">
        <div class="muted">Score: <b id="shopScore">0</b> ‚Ä¢ Fish: <b id="shopFish">0</b></div>
        <div class="shop-row">
          <button id="buyFishBtn" class="btn">üêü Buy Fish (100)</button>
          <button id="feedFishBtn" class="btn">üçΩÔ∏è Feed Cats</button>
          <button id="toggleNameArea" class="btn">üìù Name a Cat (500)</button>
        </div>
      </div>

      <div id="nameArea" style="display:none; margin-top:8px">
        <div class="shop-row">
          <select id="catSelect" class="btn"></select>
          <input id="catNameInput" class="input" placeholder="Enter a cute name‚Ä¶" style="max-width:260px"/>
          <button id="confirmNameBtn" class="primary">Save Name</button>
          <span id="nameCostNote" class="tiny muted">Costs 500 points.</span>
        </div>
      </div>
      <div id="shopMsg" class="feedback"></div>
    </div>
  </div>
</div>

<!-- Settings Modal -->
<div id="settingsModal" class="modal">
  <div class="modal-card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
      <h3 style="margin:0">‚öôÔ∏è Settings</h3>
      <button id="closeSettings" class="btn">Close</button>
    </div>
    <div class="grid">
      <div class="stat">
        <b>Themes (rewards)</b>
        <p class="tiny">Unlock a new theme for every <b>50</b> words learned.</p>
        <select id="themeSelect" style="width:100%"></select>
        <div id="themeNote" class="tiny" style="margin-top:6px"></div>
      </div>

      <div class="stat">
        <b>Mini Quiz</b><p class="tiny">Practice 5 items (image ‚Üí type the transliteration).</p>
        <button id="startMiniQuiz" class="btn">‚ö° Start Mini Quiz</button>
      </div>

      <div class="stat">
        <b>Review Mode</b><p class="tiny">Quiz only on words she has mastered (ignores SRS order).</p>
        <button id="reviewToggle" class="btn">üîÅ Review All Mastered: OFF</button>
      </div>

      <div class="stat">
        <b>Sentence Practice</b>
        <p class="tiny">Read example sentences & translations.</p>
        <button id="openSentences" class="btn">üìñ Open Sentence Practice</button>
      </div>

      <div class="stat">
        <b>Danger zone</b><p class="tiny">Clear this profile‚Äôs score, streak, SRS, unlocks, and achievements.</p>
        <button id="resetBtn" class="btn" style="background:linear-gradient(180deg,#ef4444,#dc2626);border-color:#7f1d1d">‚ôªÔ∏è Reset Progress</button>
      </div>
    </div>
  </div>
</div>

<!-- Sentence Practice Modal -->
<div id="sentencesModal" class="modal">
  <div class="modal-card" style="max-width:820px">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
      <h3 style="margin:0">üìñ Sentence Practice</h3>
      <button id="closeSentences" class="btn">Close</button>
    </div>
    <div id="sentencePanel" class="stat">
      <div class="fa" id="sentFa" dir="rtl" style="font-size:22px"></div>
      <div class="trans" id="sentTrans" style="font-size:18px; margin-top:8px"></div>
      <div class="en" id="sentEn" style="font-size:18px; margin-top:4px"></div>
    </div>
    <div class="controls" style="justify-content:space-between">
      <div class="tiny" id="sentProgress"></div>
      <div>
        <button id="sentPrev" class="btn">‚¨ÖÔ∏è Prev</button>
        <button id="sentNext" class="primary">Next ‚û°Ô∏è</button>
      </div>
    </div>
  </div>
</div>

<!-- Mini Quiz Modal -->
<div id="miniQuizModal" class="modal">
  <div class="modal-card" style="max-width:740px">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
      <h3 style="margin:0">‚ö° Mini Quiz</h3>
      <button id="mqQuit" class="btn" title="Exit Mini Quiz">‚úñ Quit</button>
    </div>
    <div class="qprogress" style="height:8px;background:#0a142e;border:1px solid #1f2937;border-radius:999px;overflow:hidden;margin-bottom:12px">
      <div id="mqBar" class="bar" style="height:8px;width:0%"></div>
    </div>
    <img id="mqPic" class="mq-pic" alt="" style="display:block;margin:auto"/>
    <input id="mqInput" class="input" placeholder="Type the transliteration‚Ä¶" style="margin-top:12px"/>
    <div class="controls" style="justify-content:flex-end"><button id="mqCheck" class="primary">Check</button></div>
    <div id="mqFeedback" class="feedback"></div>
  </div>
</div>

<script>
/* ===================== PROFILED STORAGE ===================== */
let ACTIVE_PROFILE = null;
const GLOBAL_PREFIX = 'ff';
function PKEY(k){ return `${GLOBAL_PREFIX}:${ACTIVE_PROFILE||'__anon'}:${k}`; }
const store = {
  get:(k,def=null)=>{ try{ const v=localStorage.getItem(PKEY(k)); return v===null?def:JSON.parse(v); }catch{ return def; } },
  set:(k,v)=>{ try{ localStorage.setItem(PKEY(k), JSON.stringify(v)); }catch{} },
  del:(k)=>{ try{ localStorage.removeItem(PKEY(k)); }catch{} }
};

/* ===================== CONSTANTS ===================== */
const DAILY_WORDS = 5;
const SRS_INTERVALS_HOURS = [0,8,24,72,168,336];
const MINI_QUIZ_SIZE = 5;
/* Cat shop pricing */
const FISH_COST = 100;
const NAME_COST = 500;

/* Example sentences shown in Sentence Practice modal */
const SENTENCES = [
  { fa:"ŸÖŸÜ ÿ¢ÿ® ŸÖ€å‚ÄåŸÜŸàÿ¥ŸÖ.", translit:"man √¢b minusham.", en:"I drink water." },
  { fa:"ÿßŸà €å⁄© ⁄Øÿ±ÿ®Ÿá ÿØÿßÿ±ÿØ.", translit:"u yek gorbe d√¢rad.", en:"He/She has a cat." },
  { fa:"ÿß€åŸÜ ÿÆÿßŸÜŸá ÿ®ÿ≤ÿ±⁄Ø ÿßÿ≥ÿ™.", translit:"in kh√¢ne bozorg ast.", en:"This house is big." },
  { fa:"ŸÖŸÜ ⁄©ÿ™ÿßÿ® ŸÖ€å‚ÄåÿÆŸàÿßŸÜŸÖ.", translit:"man ket√¢b mikh√¢nam.", en:"I am reading a book." },
  { fa:"ÿßŸÖÿ±Ÿàÿ≤ ŸáŸàÿß ÿÆŸàÿ® ÿßÿ≥ÿ™.", translit:"emruz hav√¢ khub ast.", en:"The weather is good today." },
  { fa:"ÿ≥⁄Ø ÿØÿ± Ÿæÿßÿ±⁄© ÿßÿ≥ÿ™.", translit:"sag dar p√¢rk ast.", en:"The dog is in the park." }
];

/* ===================== WORDS ===================== */
const words = [
  {fa:"ÿ≥€åÿ®", en:"apple", translit:"sib", emoji:"üçé", audio:"audio/sib.mp3", image:"images/sib.png"},
  {fa:"⁄©ÿ™ÿßÿ®", en:"book", translit:"ket√¢b", emoji:"üìñ", audio:"audio/ketab.mp3", image:"images/ketab.png"},
  {fa:"⁄Øÿ±ÿ®Ÿá", en:"cat", translit:"gorbe", emoji:"üê±", audio:"audio/gorbe.mp3", image:"images/gorbe.png"},
  {fa:"ÿ≥⁄Ø", en:"dog", translit:"sag", emoji:"üê∂", audio:"audio/sag.mp3", image:"images/sag.png"},
  {fa:"ÿ¢ÿ®", en:"water", translit:"√¢b", emoji:"üíß", audio:"audio/ab.mp3", image:"images/ab.png"},
  {fa:"ŸÜÿßŸÜ", en:"bread", translit:"n√¢n", emoji:"üçû", audio:"audio/nan.mp3", image:"images/nan.png"},
  {fa:"⁄Üÿß€å", en:"tea", translit:"ch√¢y", emoji:"üçµ", audio:"audio/chay.mp3", image:"images/chay.png"},
  {fa:"ŸÖÿßÿ¥€åŸÜ", en:"car", translit:"m√¢shin", emoji:"üöó", audio:"audio/mashin.mp3", image:"images/mashin.png"},
  {fa:"ÿÆÿßŸÜŸá", en:"house", translit:"kh√¢ne", emoji:"üè†", audio:"audio/khane.mp3", image:"images/khane.png"},
  {fa:"ÿØÿ±", en:"door", translit:"dar", emoji:"üö™", audio:"audio/dar.mp3", image:"images/dar.png"},
  {fa:"ÿ≥ŸÑÿßŸÖ", en:"hello", translit:"sal√¢m", emoji:"üëã", audio:"audio/salam.mp3", image:"images/salam.png"},
  {fa:"ÿÆÿØÿßÿ≠ÿßŸÅÿ∏", en:"goodbye", translit:"khod√¢h√¢fez", emoji:"üëã", audio:"audio/khodahafez.mp3", image:"images/khodahafez.png"},
  {fa:"ÿ®ŸÑŸá", en:"yes", translit:"bale", emoji:"‚úÖ", audio:"audio/bale.mp3", image:"images/bale.png"},
  {fa:"ŸÜŸá", en:"no", translit:"na", emoji:"‚ùå", audio:"audio/na.mp3", image:"images/na.png"},
  {fa:"ŸÑÿ∑ŸÅÿßŸã", en:"please", translit:"lotfan", emoji:"üôè", audio:"audio/lotfan.mp3", image:"images/lotfan.png"},
  {fa:"ŸÖÿ™ÿ¥⁄©ÿ±ŸÖ", en:"thank you", translit:"merci", emoji:"üôè", audio:"audio/merci.mp3", image:"images/merci.png"},
  {fa:"ÿµÿ®ÿ≠ ÿ®ÿÆ€åÿ±", en:"good morning", translit:"sobh bekheir", emoji:"üåÖ", audio:"audio/sobh_bekheir.mp3", image:"images/sobh_bekheir.png"},
  {fa:"ÿ¥ÿ® ÿ®ÿÆ€åÿ±", en:"good night", translit:"shab bekheir", emoji:"üåô", audio:"audio/shab_bekheir.mp3", image:"images/shab_bekheir.png"},
  {fa:"ÿßŸÖÿ±Ÿàÿ≤", en:"today", translit:"emruz", emoji:"üìÖ", audio:"audio/emruz.mp3", image:"images/emruz.png"},
{fa:"⁄©ÿ±Ÿá", en:"butter", translit:"kare", emoji:"üßà", audio:"audio/kare.mp3", image:"images/kare.png"},
{fa:"ŸæŸÜ€åÿ±", en:"cheese", translit:"panir", emoji:"üßÄ", audio:"audio/panir.mp3", image:"images/panir.png"},
{fa:"ÿ™ÿÆŸÖ ŸÖÿ±ÿ∫", en:"egg", translit:"tokhm morgh", emoji:"ü•ö", audio:"audio/tokhm_morgh.mp3", image:"images/tokhm_morgh.png"},
{fa:"⁄ØŸàÿ¥ÿ™", en:"meat", translit:"gusht", emoji:"ü•©", audio:"audio/gusht.mp3", image:"images/gusht.png"},
{fa:"ŸÖÿ±ÿ∫", en:"chicken", translit:"morgh", emoji:"üçó", audio:"audio/morgh.mp3", image:"images/morgh.png"},
{fa:"ŸÖÿßŸá€å", en:"fish", translit:"m√¢hi", emoji:"üêü", audio:"audio/mahi.mp3", image:"images/mahi.png"},
{fa:"ÿ®ÿ±ŸÜÿ¨", en:"rice", translit:"berenj", emoji:"üçö", audio:"audio/berenj.mp3", image:"images/berenj.png"},
{fa:"ÿ≥ŸàŸæ", en:"soup", translit:"sup", emoji:"üç≤", audio:"audio/sup.mp3", image:"images/sup.png"},
{fa:"Ÿæ€åÿ™ÿ≤ÿß", en:"pizza", translit:"pitza", emoji:"üçï", audio:"audio/pitza.mp3", image:"images/pitza.png"},
{fa:"ÿ≥ÿßŸÑÿßÿØ", en:"salad", translit:"s√¢l√¢d", emoji:"ü•ó", audio:"audio/salad.mp3", image:"images/salad.png"},
{fa:"ÿ¥⁄©ÿ±", en:"sugar", translit:"shekar", emoji:"üç¨", audio:"audio/shekar.mp3", image:"images/shekar.png"},
{fa:"ŸÜŸÖ⁄©", en:"salt", translit:"namak", emoji:"üßÇ", audio:"audio/namak.mp3", image:"images/namak.png"},
{fa:"ŸÅŸÑŸÅŸÑ", en:"pepper", translit:"felfel", emoji:"üå∂Ô∏è", audio:"audio/felfel.mp3", image:"images/felfel.png"},
{fa:"ŸÑ€åŸÖŸà", en:"lemon", translit:"limu", emoji:"üçã", audio:"audio/limu.mp3", image:"images/limu.png"},
{fa:"Ÿæÿ±ÿ™ŸÇÿßŸÑ", en:"orange", translit:"portegh√¢l", emoji:"üçä", audio:"audio/porteghal.mp3", image:"images/porteghal.png"},
{fa:"ŸÖŸàÿ≤", en:"banana", translit:"moz", emoji:"üçå", audio:"audio/moz.mp3", image:"images/moz.png"},
{fa:"ŸáŸÜÿØŸàÿßŸÜŸá", en:"watermelon", translit:"hendune", emoji:"üçâ", audio:"audio/hendune.mp3", image:"images/hendune.png"},
{fa:"ÿßŸÜ⁄ØŸàÿ±", en:"grape", translit:"angur", emoji:"üçá", audio:"audio/angur.mp3", image:"images/angur.png"},
{fa:"⁄©€åŸà€å", en:"kiwi", translit:"kivi", emoji:"ü•ù", audio:"audio/kivi.mp3", image:"images/kivi.png"},
{fa:"ÿ™Ÿàÿ™ ŸÅÿ±ŸÜ⁄Ø€å", en:"strawberry", translit:"tut farangi", emoji:"üçì", audio:"audio/tut_farangi.mp3", image:"images/tut_farangi.png"},
{fa:"ÿÆ€åÿßÿ±", en:"cucumber", translit:"khi√¢r", emoji:"ü•í", audio:"audio/khiar.mp3", image:"images/khiar.png"},
{fa:"⁄ØŸàÿ¨Ÿá", en:"tomato", translit:"goje", emoji:"üçÖ", audio:"audio/goje.mp3", image:"images/goje.png"},
{fa:"ÿ≥€åÿ® ÿ≤ŸÖ€åŸÜ€å", en:"potato", translit:"sib zamini", emoji:"ü•î", audio:"audio/sib_zamini.mp3", image:"images/sib_zamini.png"},
{fa:"ŸáŸà€åÿ¨", en:"carrot", translit:"havij", emoji:"ü•ï", audio:"audio/havij.mp3", image:"images/havij.png"},
{fa:"ŸÇÿßÿ±⁄Ü", en:"mushroom", translit:"gh√¢rch", emoji:"üçÑ", audio:"audio/gharch.mp3", image:"images/gharch.png"},
{fa:"ÿ®ÿßÿØŸÖÿ¨ÿßŸÜ", en:"eggplant", translit:"b√¢demj√¢n", emoji:"üçÜ", audio:"audio/bademjan.mp3", image:"images/bademjan.png"},
{fa:"ŸÑŸàÿ®€åÿß", en:"bean", translit:"lubi√¢", emoji:"ü´ò", audio:"audio/lubia.mp3", image:"images/lubia.png"},
{fa:"ÿπÿØÿ≥", en:"lentil", translit:"adas", emoji:"ü´ò", audio:"audio/adas.mp3", image:"images/adas.png"},
{fa:"ÿ∫ÿ∞ÿß", en:"food", translit:"ghaz√¢", emoji:"üçΩÔ∏è", audio:"audio/ghaza.mp3", image:"images/ghaza.png"},
{fa:"ÿ¢ÿ®ŸÖ€åŸàŸá", en:"juice", translit:"√¢b mive", emoji:"üßÉ", audio:"audio/ab_mive.mp3", image:"images/ab_mive.png"},
{fa:"ÿ¥€åÿ±", en:"milk", translit:"shir", emoji:"ü•õ", audio:"audio/shir.mp3", image:"images/shir.png"},
{fa:"ŸÇŸáŸàŸá", en:"coffee", translit:"ghahve", emoji:"‚òï", audio:"audio/ghahve.mp3", image:"images/ghahve.png"},
{fa:"ÿ¢ÿ®ÿ¨Ÿà", en:"beer", translit:"√¢bjo", emoji:"üç∫", audio:"audio/abjo.mp3", image:"images/abjo.png"},
{fa:"ÿ¥ÿ±ÿßÿ®", en:"wine", translit:"shar√¢b", emoji:"üç∑", audio:"audio/sharab.mp3", image:"images/sharab.png"},
{fa:"ÿØŸàÿ∫", en:"doogh", translit:"dugh", emoji:"ü•õ", audio:"audio/dugh.mp3", image:"images/dugh.png"},
{fa:"ÿ®ÿ≥ÿ™ŸÜ€å", en:"ice cream", translit:"bastani", emoji:"üç®", audio:"audio/bastani.mp3", image:"images/bastani.png"},
{fa:"ÿ¥⁄©ŸÑÿßÿ™", en:"chocolate", translit:"shokol√¢t", emoji:"üç´", audio:"audio/shokolat.mp3", image:"images/shokolat.png"},
{fa:"⁄©€å⁄©", en:"cake", translit:"keyk", emoji:"üéÇ", audio:"audio/keyk.mp3", image:"images/keyk.png"},
{fa:"ŸæŸàŸÑ ŸÜŸÇÿØ", en:"cash", translit:"pul naghd", emoji:"üíµ", audio:"audio/pul_naghd.mp3", image:"images/pul_naghd.png"},
{fa:"⁄©ÿßÿ±ÿ™ ÿ®ÿßŸÜ⁄©€å", en:"bank card", translit:"k√¢rt b√¢nki", emoji:"üí≥", audio:"audio/kart_banki.mp3", image:"images/kart_banki.png"},
{fa:"ŸáÿØ€åŸá", en:"gift", translit:"hedye", emoji:"üéÅ", audio:"audio/hedye.mp3", image:"images/hedye.png"},
{fa:"ÿπÿ±Ÿàÿ≥€å", en:"wedding", translit:"arusi", emoji:"üíí", audio:"audio/arusi.mp3", image:"images/arusi.png"},
{fa:"ÿ™ŸàŸÑÿØ", en:"birthday", translit:"tavallod", emoji:"üéâ", audio:"audio/tavallod.mp3", image:"images/tavallod.png"},
{fa:"ÿπÿ¥ŸÇ", en:"love", translit:"eshgh", emoji:"‚ù§Ô∏è", audio:"audio/eshgh.mp3", image:"images/eshgh.png"},
{fa:"ÿØŸàÿ≥ÿ™ ÿØÿßÿ¥ÿ™ŸÜ", en:"to like", translit:"dust d√¢shtan", emoji:"üëç", audio:"audio/dust_dashtan.mp3", image:"images/dust_dashtan.png"},
{fa:"ÿ±ŸÅÿ™ŸÜ", en:"to go", translit:"raftan", emoji:"üèÉ", audio:"audio/raftan.mp3", image:"images/raftan.png"},
{fa:"ÿ¢ŸÖÿØŸÜ", en:"to come", translit:"√¢madan", emoji:"üö∂", audio:"audio/amadan.mp3", image:"images/amadan.png"},
{fa:"ÿØ€åÿØŸÜ", en:"to see", translit:"didan", emoji:"üëÄ", audio:"audio/didan.mp3", image:"images/didan.png"},
{fa:"ÿ¥ŸÜ€åÿØŸÜ", en:"to hear", translit:"shenidan", emoji:"üëÇ", audio:"audio/shenidan.mp3", image:"images/shenidan.png"},
{fa:"⁄ØŸÅÿ™ŸÜ", en:"to say", translit:"goftan", emoji:"üó£Ô∏è", audio:"audio/goftan.mp3", image:"images/goftan.png"},
{fa:"ÿÆŸàÿ±ÿØŸÜ", en:"to eat", translit:"khordan", emoji:"üçΩÔ∏è", audio:"audio/khordan.mp3", image:"images/khordan.png"},
{fa:"ÿ¢ÿ¥ÿßŸÖ€åÿØŸÜ", en:"to drink", translit:"√¢sh√¢midan", emoji:"ü•§", audio:"audio/ashamidan.mp3", image:"images/ashamidan.png"},
{fa:"ÿÆŸàÿßÿ®€åÿØŸÜ", en:"to sleep", translit:"kh√¢bidan", emoji:"üò¥", audio:"audio/khabidan.mp3", image:"images/khabidan.png"},
{fa:"ÿ®€åÿØÿßÿ± ÿ¥ÿØŸÜ", en:"to wake up", translit:"bid√¢r shodan", emoji:"‚è∞", audio:"audio/bidar_shodan.mp3", image:"images/bidar_shodan.png"},
{fa:"⁄©ÿßÿ± ⁄©ÿ±ÿØŸÜ", en:"to work", translit:"k√¢r kardan", emoji:"üíº", audio:"audio/kar_kardan.mp3", image:"images/kar_kardan.png"},
{fa:"ÿÆŸàÿßŸÜÿØŸÜ", en:"to read", translit:"kh√¢ndan", emoji:"üìñ", audio:"audio/khandan.mp3", image:"images/khandan.png"},
{fa:"ŸÜŸàÿ¥ÿ™ŸÜ", en:"to write", translit:"neveshtan", emoji:"‚úçÔ∏è", audio:"audio/neveshtan.mp3", image:"images/neveshtan.png"},
{fa:"€åÿßÿØ ⁄Øÿ±ŸÅÿ™ŸÜ", en:"to learn", translit:"y√¢d gereftan", emoji:"üß†", audio:"audio/yad_gereftan.mp3", image:"images/yad_gereftan.png"},
{fa:"ÿØÿ±ÿ≥ ÿØÿßÿØŸÜ", en:"to teach", translit:"dars d√¢dan", emoji:"üë©‚Äçüè´", audio:"audio/dars_dadan.mp3", image:"images/dars_dadan.png"},
{fa:"Ÿæÿ±ÿ≥€åÿØŸÜ", en:"to ask", translit:"porsidan", emoji:"‚ùì", audio:"audio/porsidan.mp3", image:"images/porsidan.png"},
{fa:"Ÿæÿßÿ≥ÿÆ ÿØÿßÿØŸÜ", en:"to answer", translit:"p√¢sokh d√¢dan", emoji:"üí¨", audio:"audio/pasokh_dadan.mp3", image:"images/pasokh_dadan.png"},
{fa:"ÿÆÿ±€åÿØ ⁄©ÿ±ÿØŸÜ", en:"to shop", translit:"kharid kardan", emoji:"üõçÔ∏è", audio:"audio/kharid_kardan.mp3", image:"images/kharid_kardan.png"},
{fa:"ÿ±ÿßŸÜŸÜÿØ⁄Ø€å ⁄©ÿ±ÿØŸÜ", en:"to drive", translit:"r√¢nandegi kardan", emoji:"üöó", audio:"audio/ranandegi_kardan.mp3", image:"images/ranandegi_kardan.png"},
{fa:"Ÿæ€åÿßÿØŸá ÿ±ŸÅÿ™ŸÜ", en:"to walk", translit:"pi√¢de raftan", emoji:"üö∂", audio:"audio/piade_raftan.mp3", image:"images/piade_raftan.png"},
{fa:"ÿ¥ŸÜÿß ⁄©ÿ±ÿØŸÜ", en:"to swim", translit:"shen√¢ kardan", emoji:"üèä", audio:"audio/shena_kardan.mp3", image:"images/shena_kardan.png"},
{fa:"ÿ®ÿßÿ≤€å ⁄©ÿ±ÿØŸÜ", en:"to play", translit:"b√¢zi kardan", emoji:"üéÆ", audio:"audio/bazi_kardan.mp3", image:"images/bazi_kardan.png"},
{fa:"ÿ™ŸÖÿßÿ¥ÿß ⁄©ÿ±ÿØŸÜ", en:"to watch", translit:"tam√¢sh√¢ kardan", emoji:"üì∫", audio:"audio/tamasha_kardan.mp3", image:"images/tamasha_kardan.png"},
{fa:"ŸÑÿ®ÿÆŸÜÿØ", en:"smile", translit:"labkhand", emoji:"üòä", audio:"audio/labkhand.mp3", image:"images/labkhand.png"},
{fa:"⁄Øÿ±€åŸá", en:"cry", translit:"gerye", emoji:"üò¢", audio:"audio/gerye.mp3", image:"images/gerye.png"},
{fa:"ÿÆŸÜÿØŸá", en:"laugh", translit:"khande", emoji:"üòÇ", audio:"audio/khande.mp3", image:"images/khande.png"},
{fa:"⁄Øÿ±ÿ≥ŸÜŸá", en:"hungry", translit:"gorsne", emoji:"üçΩÔ∏è", audio:"audio/gorsne.mp3", image:"images/gorsne.png"},
{fa:"ÿ™ÿ¥ŸÜŸá", en:"thirsty", translit:"tashne", emoji:"ü•§", audio:"audio/tashne.mp3", image:"images/tashne.png"},
{fa:"ÿÆÿ≥ÿ™Ÿá", en:"tired", translit:"khast√©", emoji:"üò¥", audio:"audio/khaste.mp3", image:"images/khaste.png"},
{fa:"ÿÆŸàÿ¥ÿ≠ÿßŸÑ", en:"happy", translit:"khoshh√¢l", emoji:"üòÑ", audio:"audio/khoshhal.mp3", image:"images/khoshhal.png"},
{fa:"ŸÜÿßÿ±ÿßÿ≠ÿ™", en:"sad", translit:"n√¢r√¢hat", emoji:"üòî", audio:"audio/narahat.mp3", image:"images/narahat.png"},
{fa:"ÿπÿµÿ®ÿßŸÜ€å", en:"angry", translit:"asab√¢ni", emoji:"üò†", audio:"audio/asabani.mp3", image:"images/asabani.png"},
{fa:"ÿ¢ÿ±ÿßŸÖ", en:"calm", translit:"√¢r√¢m", emoji:"üòå", audio:"audio/aram.mp3", image:"images/aram.png"},
{fa:"ÿ®ÿ≤ÿ±⁄Ø", en:"big", translit:"bozorg", emoji:"üîµ", audio:"audio/bozorg.mp3", image:"images/bozorg.png"},
{fa:"⁄©Ÿà⁄Ü⁄©", en:"small", translit:"kuchak", emoji:"‚ö™", audio:"audio/kuchak.mp3", image:"images/kuchak.png"},
{fa:"ÿ®ŸÑŸÜÿØ", en:"tall", translit:"boland", emoji:"üìè", audio:"audio/boland.mp3", image:"images/boland.png"},
{fa:"⁄©Ÿàÿ™ÿßŸá", en:"short", translit:"kut√¢h", emoji:"üìè", audio:"audio/kutah.mp3", image:"images/kutah.png"},
{fa:"⁄Øÿ±ŸÖ", en:"hot", translit:"garm", emoji:"üî•", audio:"audio/garm.mp3", image:"images/garm.png"},
{fa:"ÿ≥ÿ±ÿØ", en:"cold", translit:"sard", emoji:"‚ùÑÔ∏è", audio:"audio/sard.mp3", image:"images/sard.png"},
{fa:"ÿ±Ÿàÿ¥ŸÜ", en:"light", translit:"roshan", emoji:"üí°", audio:"audio/roshan.mp3", image:"images/roshan.png"},
{fa:"ÿ™ÿßÿ±€å⁄©", en:"dark", translit:"t√¢rik", emoji:"üåë", audio:"audio/tarik.mp3", image:"images/tarik.png"},
{fa:"ÿ≥ŸÅ€åÿØ", en:"white", translit:"sefid", emoji:"‚ö™", audio:"audio/sefid.mp3", image:"images/sefid.png"},
{fa:"ÿ≥€åÿßŸá", en:"black", translit:"siy√¢h", emoji:"‚ö´", audio:"audio/siyah.mp3", image:"images/siyah.png"},
{fa:"ŸÇÿ±ŸÖÿ≤", en:"red", translit:"ghermez", emoji:"üî¥", audio:"audio/ghermez.mp3", image:"images/ghermez.png"},
{fa:"ÿ¢ÿ®€å", en:"blue", translit:"√¢bi", emoji:"üîµ", audio:"audio/abi.mp3", image:"images/abi.png"},
{fa:"ÿ≥ÿ®ÿ≤", en:"green", translit:"sabz", emoji:"üü¢", audio:"audio/sabz.mp3", image:"images/sabz.png"},
{fa:"ÿ≤ÿ±ÿØ", en:"yellow", translit:"zard", emoji:"üü°", audio:"audio/zard.mp3", image:"images/zard.png"},
{fa:"ÿ®ŸÜŸÅÿ¥", en:"purple", translit:"banafsh", emoji:"üü£", audio:"audio/banafsh.mp3", image:"images/banafsh.png"},
{fa:"ŸÜÿßÿ±ŸÜÿ¨€å", en:"orange (color)", translit:"n√¢renji", emoji:"üü†", audio:"audio/narenji.mp3", image:"images/narenji.png"},
{fa:"ÿµŸàÿ±ÿ™€å", en:"pink", translit:"surati", emoji:"üå∏", audio:"audio/surati.mp3", image:"images/surati.png"}
];

/* ===================== THEMES ===================== */
const THEMES = [
  {key:'default', name:'Ocean (default)', unlockAt:0, vars:{'--grad1':'#0b1229','--grad2':'#121a36','--accent-2':'#38bdf8','--accent':'#22c55e','--bg':'#0f172a'}},
  {key:'sunset', name:'Sunset', unlockAt:50, vars:{'--grad1':'#2a0f1b','--grad2':'#3a1f2a','--accent-2':'#fb923c','--accent':'#f59e0b','--bg':'#1a0c12'}},
  {key:'mint', name:'Mint', unlockAt:100,vars:{'--grad1':'#0d1f1a','--grad2':'#123227','--accent-2':'#34d399','--accent':'#10b981','--bg':'#0b1814'}},
  {key:'amethyst',name:'Amethyst', unlockAt:150,vars:{'--grad1':'#1b1330','--grad2':'#2a1f4d','--accent-2':'#a78bfa','--accent':'#8b5cf6','--bg':'#130f24'}},
  {key:'night', name:'Night Bazaar', unlockAt:200,vars:{'--grad1':'#0a0a0f','--grad2':'#15151f','--accent-2':'#60a5fa','--accent':'#22d3ee','--bg':'#0a0b12'}}
];
function applyTheme(key){
  const t = THEMES.find(x=>x.key===key) || THEMES[0];
  for(const [k,v] of Object.entries(t.vars)) document.documentElement.style.setProperty(k, v);
  state.theme = t.key; persist();
}
function learnedCount(){ return (state.covered||[]).length; }
function isThemeUnlocked(theme){ return learnedCount() >= theme.unlockAt; }
function nextUnlockNote(){
  const learned = learnedCount();
  const next = THEMES.find(t=>t.unlockAt>learned);
  return next ? `Next theme unlocks at <b>${next.unlockAt}</b> learned. (You: ${learned})` : `All themes unlocked! üéâ (You: ${learned})`;
}
function populateThemeDropdown(){
  const sel = $('themeSelect'); if(!sel) return;
  sel.innerHTML='';
  THEMES.forEach(t=>{
    const opt=document.createElement('option');
    opt.value=t.key;
    const locked = !isThemeUnlocked(t);
    opt.textContent = locked ? `${t.name} ‚Äî locked (needs ${t.unlockAt})` : t.name;
    opt.disabled = locked;
    if((state.theme||'default')===t.key) opt.selected=true;
    sel.appendChild(opt);
  });
  $('themeNote').innerHTML = nextUnlockNote();
}

/* ===================== UTILITIES ===================== */
const $=id=>document.getElementById(id);
const bySel=s=>document.querySelector(s);
function now(){return Date.now()}
function todayISO(){const d=new Date();d.setHours(0,0,0,0);return d.toISOString().slice(0,10)}
function normalizeTranslit(s){return (s||'').toLowerCase().normalize('NFKD').replace(/[\u0302\u0304]/g,'').replace(/[^a-z0-9]+/g,'').trim()}
function normalizeFa(s){return (s||'').replace(/\s+/g,'').replace(/Ÿä/g,'€å').replace(/ŸÉ/g,'⁄©').replace(/[\u200C\u200F\u202A-\u202E]/g,'')}
function shuffle(a){ for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j]]} return a }
/* Mobile detection for input focus */
const isMobile = () => window.matchMedia('(max-width:700px)').matches || /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
function maybeFocusInput(){ if(!isMobile()) $('typeInput').focus(); }

/* ===================== STATE (per profile) ===================== */
const defaultState = ()=>({
  score:0, streak:0, srs:{}, covered:[], start_date:null, unlocked_count:0,
  achievements:{first10:false,perfectMini:false,streak7:false,mastered50:false},
  /* === BADGES UPGRADE: remember which ones already sparkled === */
  achSparkled:{first10:false,perfectMini:false,streak7:false,mastered50:false},
  mapUnlocked:0, mapDays:[], // {date, correct, goalMet}
  settings:{reviewAll:false}, theme:'default',
  inventory:{fish:0, nameTokens:0},
  catNames:{} // {0:"Mishi", ...}
});
let state = defaultState();
let mode='learn', order=[], idx=0;

/* ===== Session progress ===== */
let sessionTotal = 0;
let sessionAnswered = new Set();
function resetSessionProgress(){ sessionTotal = unlockedCount(); sessionAnswered = new Set(); updateSessionBar(); }
function updateSessionBar(){ const pct = Math.round((sessionAnswered.size/Math.max(1,sessionTotal))*100); $('progressBar').style.width = pct + '%'; }

/* Helpers for SRS & pools */
function ensureSRS(i){ if(!state.srs[i]) state.srs[i]={stage:0,due:0,seen:0,correct:0,wrong:0}; return state.srs[i]; }
function isDue(i){ return ensureSRS(i).due <= now(); }
function scheduleAfter(i,h){ ensureSRS(i).due = now()+h*3600*1000; }
function getCoveredSet(){ return new Set(state.covered||[]); }
function addCovered(i){ const s=getCoveredSet(); s.add(i); state.covered=[...s]; persist(); }
function initDailyUnlock(){
  if(!state.start_date){ state.start_date=todayISO(); }
  const startDate = new Date(state.start_date+'T00:00:00');
  const dNow = new Date(); dNow.setHours(0,0,0,0);
  const diffDays = Math.floor((dNow - startDate)/86400000);
  const shouldUnlock = Math.min(words.length, (diffDays+1)*DAILY_WORDS);
  state.unlocked_count = Math.max(state.unlocked_count||0, shouldUnlock);
  persist();
}
function unlockedCount(){ return state.unlocked_count||Math.min(words.length, DAILY_WORDS); }
function unlockedIndices(){ return [...Array(unlockedCount()).keys()]; }
function masteredIndices(){ return [...getCoveredSet()].filter(i=>i<unlockedCount()); }
function dueIndices(){ return unlockedIndices().filter(i=>isDue(i)); }
function quizPool(){ const due=dueIndices(); if(due.length) return due; const m=masteredIndices(); return m.length?m:unlockedIndices(); }
function learnPool(){ const u=unlockedIndices(), due=u.filter(i=>isDue(i)), rest=u.filter(i=>!isDue(i)); return [...due,...rest]; }

/* ===================== CAT UNLOCKS BY WORDS LEARNED ===================== */
const CAT_THRESHOLDS = [5, 20, 50, 100, 250, 500];
function catsUnlockedByWords(){
  const learned = learnedCount();
  return CAT_THRESHOLDS.reduce((n,t)=>n+(learned>=t?1:0),0);
}
function nextCatNote(){
  const learned = learnedCount();
  const next = CAT_THRESHOLDS.find(t => learned < t);
  return next
    ? `Next cat unlocks at <b>${next}</b> words learned. (You: ${learned})`
    : `All cats unlocked! üêæ (You: ${learned})`;
}

/* ===================== PERSIST ===================== */
function persist(){
  store.set('state', state);
  reflectBadges();
  updateBadges();
  renderMap();
  populateThemeDropdown();
  updateShopUI();
}
function loadState(){
  state = store.get('state', defaultState());
  if(!state.inventory) state.inventory = {fish:0, nameTokens:0};
  if(!state.catNames) state.catNames = {};
  if(!state.achSparkled) state.achSparkled = {first10:false,perfectMini:false,streak7:false,mastered50:false};
  initDailyUnlock();
  applyTheme(state.theme||'default');
}

/* ======== SHARED NICOLE SYNC ======== */
const SYNC_ENDPOINT = "https://ff-sync.9rmcqs6hjc.workers.dev";
const SYNC_DOC_ID = "nicole";
const SYNC_WRITE_TOKEN = "Gravity123!!";
function mergeStates(local, remote){
  if(!remote || !remote.updated_at) return local;
  const newer = (local.updated_at||0) >= (remote.updated_at||0) ? local : remote;
  const cov = new Set([...(local.covered||[]), ...(remote.covered||[])]);
  newer.covered = [...cov];
  newer.score = Math.max(local.score||0, remote.score||0);
  newer.streak = (newer===local ? local.streak : remote.streak) || 0;
  // merge cat data & inventory (additive)
  newer.inventory = {
    fish: (local.inventory?.fish||0) + (remote.inventory?.fish||0),
    nameTokens: (local.inventory?.nameTokens||0) + (remote.inventory?.nameTokens||0)
  };
  newer.catNames = {...remote.catNames, ...local.catNames};
  // achievements: take OR
  const keys = Object.keys(local.achievements||{});
  newer.achievements = newer.achievements||{};
  newer.achSparkled = newer.achSparkled||{};
  keys.forEach(k=>{
    newer.achievements[k] = Boolean((local.achievements||{})[k] || (remote.achievements||{})[k]);
    newer.achSparkled[k] = Boolean((local.achSparkled||{})[k] || (remote.achSparkled||{})[k]);
  });
  return newer;
}
async function syncPullNicole(){
  if(!SYNC_ENDPOINT || ACTIVE_PROFILE!=="Nicole") return;
  try{
    const res = await fetch(`${SYNC_ENDPOINT}/p/${SYNC_DOC_ID}`);
    const remote = await res.json().catch(()=>null);
    if(remote && Object.keys(remote).length){
      state = mergeStates(state, remote);
      _persist();
    }
  }catch{}
}
async function syncPushNicole(){
  if(!SYNC_ENDPOINT || ACTIVE_PROFILE!=="Nicole") return;
  try{
    const payload = JSON.stringify({...state, updated_at: Date.now(), profile: ACTIVE_PROFILE});
    await fetch(`${SYNC_ENDPOINT}/p/${SYNC_DOC_ID}`, {
      method:"PUT",
      headers:{ "Content-Type":"application/json", ...(SYNC_WRITE_TOKEN?{"X-Token":SYNC_WRITE_TOKEN}:{}) },
      body:payload
    });
  }catch{}
}
let _persist = persist, _syncTimer=null;
function syncPushDebouncedNicole(){ clearTimeout(_syncTimer); _syncTimer=setTimeout(syncPushNicole,600); }
persist = function(){ _persist(); if(ACTIVE_PROFILE==="Nicole") syncPushDebouncedNicole(); };
function initSharedNicoleSync(){
  if (ACTIVE_PROFILE !== "Nicole" || !SYNC_ENDPOINT) return;
  syncPullNicole().then(()=>syncPushNicole());
  document.addEventListener("visibilitychange", ()=>{
    if(document.visibilityState==="visible" && ACTIVE_PROFILE==="Nicole") syncPullNicole();
  });
  window.addEventListener("online", ()=>{ if(ACTIVE_PROFILE==="Nicole") syncPushNicole(); });
}

/* ===================== UI UPDATE ===================== */
function updateBadges(){
  $('profileBadge').textContent = `Profile: ${ACTIVE_PROFILE||'‚Äî'}`;
  $('scoreBadge').textContent = `Score: ${state.score}`;
  $('streakBadge').textContent = `Streak: ${state.streak} üî•`;
  $('unlockedBadge').textContent = `${unlockedCount()}/${words.length} unlocked`;
  updateSessionBar();
}
function showImageOrEmoji(item){
  const pic=$('pic'), emo=$('emoji');
  if(item.image){ pic.style.display='block'; emo.style.display='none'; pic.src=item.image; pic.alt=item.en; }
  else { pic.style.display='none'; emo.style.display='block'; emo.textContent=item.emoji||'‚ùì'; }
}
function ensureOrder(){ const pool = (mode==='quiz')? quizPool(): learnPool(); order=pool.slice(); shuffle(order); idx=0; }
function showItem(){
  const pool = (mode==='quiz')? quizPool(): learnPool();
  if(order.length===0 || order.some(i=>!pool.includes(i))) ensureOrder();
  const gi = order[idx % order.length];
  const item = words[gi];
  showImageOrEmoji(item);
  if(mode==='quiz'){
    $('en').textContent=item.en; $('fa').textContent='‚Ä¢‚Ä¢‚Ä¢'; $('trans').textContent='‚Äî';
  } else {
    $('en').textContent=item.en; $('fa').textContent=item.fa; $('trans').textContent=item.translit;
  }
  $('listenBtn').style.display = (mode==='quiz')?'none':'inline-flex';
  $('revealBtn').style.display = (mode==='quiz')?'inline-flex':'none';
  $('hintBtn').style.display = 'none'; // hide hint button in all modes
  $('typeInput').value=''; maybeFocusInput();
}
function next(){ idx=(idx+1)%Math.max(1,order.length); showItem(); }

/* ===================== CELEBRATIONS ===================== */
function happyDing(){ try{const AC=window.AudioContext||window.webkitAudioContext;if(!AC) return;const ctx=new AC();const tones=[659,784,988];const t0=ctx.currentTime;
tones.forEach((f,i)=>{const o=ctx.createOscillator(),g=ctx.createGain();o.type='sine';o.frequency.value=f;o.connect(g);g.connect(ctx.destination);
const st=t0+i*0.05;g.gain.setValueAtTime(0,st);g.gain.linearRampToValueAtTime(0.35,st+0.03);g.gain.exponentialRampToValueAtTime(0.0001,st+0.22); o.start(st);o.stop(st+0.25);});}catch{}}
function confettiPop(){ if(window.confetti) confetti({origin:{y:1,x:0.5},gravity:1.2,ticks:180,scalar:0.9,particleCount:70,spread:75,startVelocity:55}); }
function fireworks(){ if(!window.confetti) return;
  const base={origin:{y:1,x:0.5},gravity:1.0,ticks:260,scalar:1.0};
  confetti({...base,particleCount:180,spread:120,startVelocity:65});
  confetti({...base,particleCount:140,spread:140,startVelocity:60,origin:{y:1,x:0.2}});
  confetti({...base,particleCount:140,spread:140,startVelocity:60,origin:{y:1,x:0.8}});
}
function celebrateSimple(){ happyDing(); confettiPop();
  const c=$('celebration'); c.textContent="let's goooooo üéâ"; c.style.display='block';
  setTimeout(()=>c.classList.add('fade-out'),800);
  setTimeout(()=>{c.classList.remove('fade-out'); c.style.display='none';},1600);
}

/* ===================== AUDIO ===================== */
const audioCache=new Map();
function getAudio(item){
  const url=item.audio||`audio/${(item.translit||'').toLowerCase()}.mp3`;
  if(!audioCache.has(url)){const a=new Audio();a.preload='auto';a.src=url;audioCache.set(url,a);}
  return audioCache.get(url);
}
async function playYourAudio(){
  const gi=order[idx], item=words[gi];
  try{ const a=getAudio(item); a.currentTime=0; await a.play(); }catch{}
}

/* ===================== SPEECH RECOG ===================== */
let SR=null;
function levenshtein(a,b){const m=a.length,n=b.length,dp=Array.from({length:m+1},()=>Array(n+1).fill(0));for(let i=0;i<=m;i++)dp[i][0]=i;for(let j=0;j<=n;j++)dp[0][j]=j;for(let i=1;i<=m;i++){for(let j=1;j<=n;j++){const c=a[i-1]===b[j-1]?0:1;dp[i][j]=Math.min(dp[i-1][j]+1,dp[i][j-1]+1,dp[i-1][j-1]+c)}}return dp[m][n]}
function closeEnough(a,b){if(!a||!b)return false;if(a===b)return true;return levenshtein(a,b)<=1}
function hasPersian(s){return /[\u0600-\u06FF]/.test(s||'')}
function normalizeSRTranslit(s){return (s||'').toLowerCase().replace(/[^a-z0-9]+/g,'')}
function initSpeech(){
  const SRClass = window.SpeechRecognition || window.webkitSpeechRecognition;
  const btn = $('sayBtn');
  if(!SRClass){ btn.disabled=true; btn.title='Speech not supported (try Chrome).'; return; }
  SR = new SRClass(); SR.lang = 'fa-IR'; SR.interimResults = false; SR.maxAlternatives = 4;
  btn.disabled=false; btn.title='Say the word in Persian (e.g., ¬´ÿÆÿßŸÜŸá¬ª). Speaking the transliteration also works.';
  SR.onstart = ()=>{ $('speechFeedback').textContent='üéôÔ∏è Listening‚Ä¶'; $('speechFeedback').className='feedback tiny'; };
  SR.onerror = ()=>{ $('speechFeedback').textContent='Mic error. Try again.'; $('speechFeedback').className='feedback err'; };
  SR.onend = ()=>{ if($('speechFeedback').textContent.includes('Listening')){ $('speechFeedback').textContent='Didn‚Äôt catch that‚Äîtry again.'; $('speechFeedback').className='feedback warn'; } };
  SR.onresult = (event)=>{
    const gi=order[idx], item=words[gi];
    const targetFa = normalizeFa(item.fa);
    const targetTr = normalizeTranslit(item.translit);
    const heard = []; for(let i=0;i<event.results[0].length;i++){ heard.push(event.results[0][i].transcript); }
    let ok=false, picked='';
    for(const h of heard){ if(hasPersian(h) && closeEnough(normalizeFa(h), targetFa)){ ok=true; picked=h.trim(); break; } }
    if(!ok){ for(const h of heard){ if(closeEnough(normalizeSRTranslit(h), targetTr)){ ok=true; picked=h.trim(); break; } } }
    $('speechFeedback').innerHTML = ok ? `Heard: "<b>${picked}</b>" ‚úì` : `Heard: "<b>${(heard[0]||'(nothing)').trim()}</b>" ‚úó ‚Äî target is "<b>${item.fa}</b>" (${item.translit})`;
    $('speechFeedback').className = 'feedback ' + (ok?'ok':'warn');
    handleAnswer(ok, gi, 'speech', picked);
  };
  $('sayBtn').addEventListener('click', ()=>{ if(!SR) return; try{ SR.stop(); SR.start(); }catch(_){} });
}

/* ===================== ANSWERING / MAP ===================== */
function handleAnswer(correct, gi, source='typing'){
  const r=ensureSRS(gi); r.seen++;
  if(correct){
    r.correct++; r.stage=Math.min(r.stage+1, SRS_INTERVALS_HOURS.length-1); scheduleAfter(gi,SRS_INTERVALS_HOURS[r.stage]||24);
    state.score+=10; state.streak+=1; addCovered(gi); sessionAnswered.add(gi); updateSessionBar();
    if(source!=='speech'){ $('typeFeedback').textContent='Great! +10 points'; $('typeFeedback').className='feedback ok'; }
    celebrateSimple();
    checkDailyGoalAndMap(); populateThemeDropdown();
  }else{
    r.wrong++; r.stage=Math.max(0,r.stage-1); scheduleAfter(gi,2); state.streak=0;
    if(source!=='speech'){ $('typeFeedback').textContent='Not quite.'; $('typeFeedback').className='feedback warn'; }
  }
  evaluateAchievements(); // <-- recalc after progress
  persist();
  setTimeout(next, 450);
}

/* Daily goal & map tiles (cats are NOT tied to daily goal anymore) */
function checkDailyGoalAndMap(){
  const today=todayISO();
  let days = state.mapDays||[];
  let todayRec = days.find(d=>d.date===today);
  if(!todayRec){ todayRec={date:today, correct:0, goalMet:false}; days=[...days,todayRec]; }
  todayRec.correct++;
  if(!todayRec.goalMet && todayRec.correct>=DAILY_WORDS){
    todayRec.goalMet=true;
    if(window.confetti){ confetti({ origin:{y:1,x:Math.random()}, particleCount:60, spread:70, startVelocity:45, scalar:1.1 }); }
  }
  state.mapDays = days;
}

/* === BADGES UPGRADE === */
/* compute consecutive days (ending today) where goalMet==true */
function consecutiveGoalDays(){
  const list = [...(state.mapDays||[])].sort((a,b)=>a.date.localeCompare(b.date));
  const today = new Date(todayISO()+'T00:00:00');
  let streak=0;
  for(let offset=0;;offset++){
    const d = new Date(today); d.setDate(d.getDate()-offset);
    const iso = d.toISOString().slice(0,10);
    const rec = list.find(x=>x.date===iso);
    if(rec && rec.goalMet) streak++; else break;
  }
  return streak;
}

/* mark achievement with one-time sparkle */
function unlockAchievementOnce(key){
  if(state.achievements[key]) return; // already earned previously
  state.achievements[key] = true;
  persist(); // save first so it shows as earned
  // sparkle once
  const el = bySel(`.badge-item[data-key="${key}"]`);
  if(el && !state.achSparkled[key]){
    el.classList.add('sparkle');
    fireworks(); // big moment
    state.achSparkled[key] = true;
  }
}

/* recalc which badges are earned based on current progress */
function evaluateAchievements(){
  const mastered = masteredIndices().length;
  const dayStreak = consecutiveGoalDays();

  if(mastered >= 10) unlockAchievementOnce('first10');
  if(mastered >= 50) unlockAchievementOnce('mastered50');
  if(dayStreak >= 7) unlockAchievementOnce('streak7');
  // perfectMini handled at mini-quiz completion
}

/* render badge list with greyed locked / glowing earned */
function reflectBadges(){
  const A = state.achievements||{};
  const items = [
    {key:'first10',  name:'First 10 mastered',   icon:'üèÖ'},
    {key:'perfectMini', name:'Perfect Mini Quiz', icon:'‚ú®'},
    {key:'streak7',  name:'7-day streak',        icon:'ü•á'},
    {key:'mastered50', name:'50 mastered',       icon:'üèÜ'}
  ];
  const wrap = $('achList'); if(!wrap) return;
  wrap.innerHTML = '';
  items.forEach(it=>{
    const earned = !!A[it.key];
    const div = document.createElement('div');
    div.className = `badge-item ${earned?'earned':'locked'}`;
    div.setAttribute('data-key', it.key);
    div.innerHTML = `<span class="bicon">${it.icon}</span><span class="bname">${it.name}</span>`;
    wrap.appendChild(div);
  });
}

/* ===================== MAP RENDER ===================== */
function renderMap(){
  const wrap = $('mapGrid'), layer=$('catLayer'), container=$('mapWrap');
  if(!wrap || !layer || !container) return;

  const catsUnlocked = catsUnlockedByWords();
  const noteEl = $('catUnlockMsg'); if(noteEl) noteEl.innerHTML = nextCatNote();

  if(catsUnlocked<=0){
    container.classList.remove('arena');
    wrap.style.display='grid'; layer.style.display='none'; wrap.innerHTML='';
    const tiles=12; for(let i=0;i<tiles;i++){ const t=document.createElement('div'); t.className='tile'; t.textContent='?'; wrap.appendChild(t); }
  }else{
    wrap.style.display='none'; wrap.innerHTML='';
    container.classList.add('arena'); layer.style.display='block';
  }
}

/* ===================== ROAMING CATS ===================== */
const CAT_EMOJIS = ['üêà','üêà‚Äç‚¨õ','üê±','üòº','üôÄ','üêÖ','üêÜ'];
let cats = [];
let catAnim = { running:false, lastTs:0, bounds:null };
function getCatName(i){ return state.catNames && state.catNames[i] ? state.catNames[i] : `Cat ${i+1}`; }
function spawnCats(count){
  const layer = $('catLayer'); if(!layer) return;
  layer.innerHTML = ''; cats = [];
  const rect = layer.getBoundingClientRect(); catAnim.bounds = { w: rect.width, h: rect.height, pad: 6 };
  for(let i=0;i<count;i++){
    const el = document.createElement('div'); el.className = 'cat'; el.textContent = CAT_EMOJIS[i % CAT_EMOJIS.length]; el.title = getCatName(i);
    layer.appendChild(el);
    const speed = 30 + Math.random()*50; const angle = Math.random()*Math.PI*2;
    const vx = Math.cos(angle)*speed; const vy = Math.sin(angle)*speed;
    const x = Math.random()*(catAnim.bounds.w-40); const y = Math.random()*(catAnim.bounds.h-40);
    cats.push({ el, x, y, vx, vy, speed, idx:i, nextTurn: performance.now()+800+Math.random()*1600 });
    el.style.left = x + 'px'; el.style.top = y + 'px'; if(vx<0) el.classList.add('flip');
  }
}
function stepCats(ts){
  if(!catAnim.running) return;
  const dt = Math.min(0.04, (ts - catAnim.lastTs)/1000); catAnim.lastTs = ts; const B = catAnim.bounds;
  for(const c of cats){
    if(ts > c.nextTurn){ const dTheta = (Math.random()-0.5) * (Math.PI/3); const angle = Math.atan2(c.vy, c.vx) + dTheta;
      const sp = Math.max(20, Math.min(90, c.speed + (Math.random()-0.5)*20)); c.speed = sp; c.vx = Math.cos(angle)*c.speed; c.vy = Math.sin(angle)*c.speed; c.nextTurn = ts + 800 + Math.random()*1600; }
    c.x += c.vx * dt; c.y += c.vy * dt;
    const r = 6;
    if(c.x < r){ c.x=r; c.vx = Math.abs(c.vx); }
    if(c.y < r){ c.y=r; c.vy = Math.abs(c.vy); }
    if(c.x > B.w-40-r){ c.x=B.w-40-r; c.vx = -Math.abs(c.vx); }
    if(c.y > B.h-40-r){ c.y=B.h-40-r; c.vy = -Math.abs(c.vy); }
    if(c.vx < 0) c.el.classList.add('flip'); else c.el.classList.remove('flip');
    c.el.style.left = c.x + 'px'; c.el.style.top = c.y + 'px';
  }
  requestAnimationFrame(stepCats);
}
function startCats(){
  const count = Math.max(0, catsUnlockedByWords());
  if(count<=0){ stopCats(); return; }
  spawnCats(count); catAnim.running = true; catAnim.lastTs = performance.now(); requestAnimationFrame(stepCats); window.addEventListener('resize', onResizeCats);
}
function stopCats(){ catAnim.running = false; const layer = $('catLayer'); if(layer) layer.innerHTML=''; cats = []; window.removeEventListener('resize', onResizeCats); }
function onResizeCats(){
  if(!catAnim.running) return;
  const layer = $('catLayer'); const rect = layer.getBoundingClientRect();
  catAnim.bounds = { w: rect.width, h: rect.height, pad: 6 };
  for(const c of cats){ c.x = Math.max(6, Math.min(c.x, catAnim.bounds.w-40-6)); c.y = Math.max(6, Math.min(c.y, catAnim.bounds.h-40-6)); }
}
/* Feeding boost */
function boostCatsFor(ms, factor=1.6){
  for(const c of cats){ const angle = Math.atan2(c.vy, c.vx); c.speed *= factor; c.vx = Math.cos(angle)*c.speed; c.vy = Math.sin(angle)*c.speed; }
  setTimeout(()=>{ for(const c of cats){ const angle = Math.atan2(c.vy, c.vx); c.speed /= factor; c.vx = Math.cos(angle)*c.speed; c.vy = Math.sin(angle)*c.speed; } }, ms);
}
/* Hearts burst near cats */
function burstHearts(count=24){
  const layer = $('catLayer'); if(!layer) return;
  const B = catAnim.bounds || layer.getBoundingClientRect();
  const groups = cats.length ? cats : [{x:B.w/2, y:B.h-30}];
  for(const c of groups){
    const n = Math.ceil(count / groups.length);
    for(let i=0;i<n;i++){
      const span = document.createElement('span'); span.className = 'heart'; span.textContent = '‚ù§Ô∏è';
      const jx = (Math.random()*40-20), jy = (Math.random()*20-10);
      span.style.left = (c.x + 20 + jx) + 'px'; span.style.top = (c.y + jy) + 'px';
      layer.appendChild(span); setTimeout(()=>span.remove(), 1700);
    }
  }
}

/* ===================== SENTENCE PRACTICE ===================== */
let sentenceIdx = 0;
function renderSentence(){
  if(!SENTENCES.length){
    $('sentFa').textContent='‚Äî'; $('sentTrans').textContent=''; $('sentEn').textContent='No sentences available yet.'; $('sentProgress').textContent=''; return;
  }
  if(sentenceIdx < 0) sentenceIdx = SENTENCES.length - 1;
  if(sentenceIdx >= SENTENCES.length) sentenceIdx = 0;
  const s = SENTENCES[sentenceIdx];
  $('sentFa').textContent = s.fa; $('sentTrans').textContent = s.translit; $('sentEn').textContent = s.en;
  $('sentProgress').textContent = `${sentenceIdx+1} / ${SENTENCES.length}`;
}
function openSentences(){ sentenceIdx=0; renderSentence(); $('sentencesModal').style.display='grid'; }

/* ===================== MINI QUIZ ===================== */
let miniQ={queue:[],current:null,correct:0,total:0}, MINI_ACTIVE=false;
function endMiniQuiz(){ MINI_ACTIVE=false; $('miniQuizModal').style.display='none'; $('mqInput').value=''; $('mqFeedback').textContent=''; $('mqBar').style.width='0%'; }
$('startMiniQuiz').addEventListener('click', ()=>{
  $('settingsModal').style.display='none';
  const pool=[...new Set([...quizPool(), ...masteredIndices(), ...unlockedIndices()])]; shuffle(pool);
  miniQ={queue:pool.slice(0,MINI_QUIZ_SIZE),current:null,correct:0,total:0}; MINI_ACTIVE=true;
  $('miniQuizModal').style.display='grid'; nextMiniQuestion();
});
function nextMiniQuestion(){
  if(!MINI_ACTIVE) return;
  if(!miniQ.queue.length){
    $('mqFeedback').innerHTML=`Mini Quiz complete! Score: <b>${miniQ.correct}</b> / ${miniQ.total}`;
    $('mqBar').style.width='100%';
    // === BADGES: perfect mini quiz
    if(miniQ.total===MINI_QUIZ_SIZE && miniQ.correct===MINI_QUIZ_SIZE){ unlockAchievementOnce('perfectMini'); }
    setTimeout(()=>{ endMiniQuiz(); showItem(); }, 1200);
    return;
  }
  miniQ.current = miniQ.queue.shift();
  const item=words[miniQ.current];
  $('mqPic').style.display='block'; $('mqPic').src=item.image||''; $('mqPic').alt=item.en||'';
  $('mqInput').value=''; $('mqFeedback').textContent='';
  $('mqBar').style.width = `${(miniQ.total/MINI_QUIZ_SIZE)*100}%`; $('mqInput').focus();
}
$('mqCheck').addEventListener('click', ()=>{
  if(!MINI_ACTIVE) return;
  const item=words[miniQ.current]; miniQ.total++;
  const ok = normalizeTranslit($('mqInput').value)===normalizeTranslit(item.translit);
  if(ok){ miniQ.correct++; $('mqFeedback').textContent='Nice!'; $('mqFeedback').className='feedback ok'; celebrateSimple(); }
  else { $('mqFeedback').textContent=`Answer: ${item.translit}`; $('mqFeedback').className='feedback warn'; state.streak=0; persist(); }
  setTimeout(nextMiniQuestion, 350);
});
$('mqInput').addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); $('mqCheck').click(); } });
$('mqQuit').addEventListener('click', ()=> endMiniQuiz());

/* ===================== EVENTS ===================== */
$('listenBtn').addEventListener('click', playYourAudio);
/* Enter-to-submit for main input */
$('typeInput').addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); $('checkBtn').click(); } });
$('checkBtn').addEventListener('click', ()=>{
  const gi=order[idx], item=words[gi];
  const guess=normalizeTranslit($('typeInput').value);
  if(!guess){ $('typeFeedback').textContent='Type your guess first!'; $('typeFeedback').className='feedback warn'; return; }
  $('typeFeedback').textContent=''; $('typeInput').value=''; maybeFocusInput();
  handleAnswer(guess===normalizeTranslit(item.translit), gi, 'typing');
});
$('skipBtn').addEventListener('click', ()=>{ $('typeInput').value=''; state.streak=0; persist(); next(); });
$('nextBtn').addEventListener('click', ()=>{ $('typeInput').value=''; next(); });
/* Mode switchers ‚Äî reset session progress on each switch */
function startMode(newMode){ endMiniQuiz(); mode = newMode; resetSessionProgress(); ensureOrder(); showItem(); }
$('learnBtn').addEventListener('click', ()=> startMode('learn'));
$('quizBtn').addEventListener('click', ()=> startMode('quiz'));
$('hintBtn').addEventListener('click', ()=>{ if(mode!=='learn') return; const gi=order[idx], item=words[gi]; $('trans').textContent=item.translit; $('en').textContent=item.en; });
$('revealBtn').addEventListener('click', ()=>{
  const gi=order[idx], item=words[gi]; $('fa').textContent=item.fa; $('trans').textContent=item.translit;
  const s=$('sadFace'); s.style.display='block'; setTimeout(()=>s.classList.add('fade-out'),700);
  setTimeout(()=>{s.classList.remove('fade-out'); s.style.display='none';},1500);
});
$('openAchievements').addEventListener('click', ()=>{ reflectBadges(); $('achModal').style.display='grid'; });
$('closeAch').addEventListener('click', ()=> $('achModal').style.display='none');

/* Bazaar open/close + roaming cats */
$('openMap').addEventListener('click', ()=>{ renderMap(); $('mapModal').style.display='grid'; requestAnimationFrame(startCats); updateShopUI(); });
$('closeMap').addEventListener('click', ()=>{ $('mapModal').style.display='none'; stopCats(); });

/* --------- Cat Rewards (Shop) --------- */
function updateShopUI(){
  const scoreEl=$('shopScore'), fishEl=$('shopFish'); if(scoreEl) scoreEl.textContent = state.score; if(fishEl) fishEl.textContent = state.inventory?.fish || 0;
  const buyBtn=$('buyFishBtn'), feedBtn=$('feedFishBtn'), nameBtn=$('toggleNameArea');
  if(buyBtn){ buyBtn.textContent = `üêü Buy Fish (${FISH_COST})`; buyBtn.disabled = state.score < FISH_COST; }
  if(feedBtn) feedBtn.disabled = (state.inventory?.fish||0) <= 0;

  const hasToken = (state.inventory?.nameTokens||0) > 0;
  const nCats = catsUnlockedByWords();

  if(nameBtn){
    nameBtn.textContent = hasToken ? `üìù Name a Cat (${state.inventory.nameTokens} ready)` : `üìù Name a Cat (${NAME_COST})`;
    nameBtn.disabled = !hasToken && (state.score < NAME_COST || nCats === 0);
  }
  if($('nameCostNote')) $('nameCostNote').style.display = hasToken ? 'none' : 'inline';

  const sel=$('catSelect');
  if(sel){
    sel.innerHTML='';
    for(let i=0;i<nCats;i++){ const opt=document.createElement('option'); opt.value=String(i); opt.textContent = `${i+1}: ${getCatName(i)}`; sel.appendChild(opt); }
  }
  if(cats && cats.length){ cats.forEach(c => { c.el.title = getCatName(c.idx); }); }
}
$('openShop').addEventListener('click', ()=>{ const panel = $('shopPanel'); panel.style.display = panel.style.display==='none' ? 'block' : 'none'; updateShopUI(); });
$('buyFishBtn').addEventListener('click', ()=>{
  if(state.score < FISH_COST) return; state.score -= FISH_COST; state.inventory.fish = (state.inventory.fish||0) + 1;
  $('shopMsg').textContent = 'Bought 1 fish! üêü'; $('shopMsg').className='feedback ok'; persist();
});
$('feedFishBtn').addEventListener('click', ()=>{
  if((state.inventory.fish||0) <= 0) return; state.inventory.fish -= 1;
  $('shopMsg').textContent = 'Fed the cats! They‚Äôre zooming üò∫üí®'; $('shopMsg').className='feedback ok';
  burstHearts(28);
  if(window.confetti){
    confetti({origin:{x:0.2,y:1},particleCount:70,spread:75,startVelocity:50});
    confetti({origin:{x:0.8,y:1},particleCount:70,spread:75,startVelocity:50});
  }
  boostCatsFor(8000,2.3); persist();
});
$('toggleNameArea').addEventListener('click', ()=>{
  const nCats = catsUnlockedByWords();
  if(nCats===0){ $('shopMsg').textContent='Unlock a cat first!'; $('shopMsg').className='feedback warn'; return; }
  const hasToken = (state.inventory?.nameTokens||0) > 0;
  if(!hasToken){
    if(state.score < NAME_COST){ $('shopMsg').textContent='Not enough points to buy a name.'; $('shopMsg').className='feedback warn'; return; }
    state.score -= NAME_COST; state.inventory.nameTokens = (state.inventory.nameTokens||0) + 1;
    $('shopMsg').textContent='Name token purchased. Pick a cat below! üè∑Ô∏è'; $('shopMsg').className='feedback ok'; persist();
  }
  $('nameArea').style.display='block'; updateShopUI();
});
$('confirmNameBtn').addEventListener('click', ()=>{
  const idx = parseInt(($('catSelect').value||'0'),10);
  const name = String(($('catNameInput').value||'').trim());
  if(!name){ $('shopMsg').textContent='Enter a name first.'; $('shopMsg').className='feedback warn'; return; }
  if((state.inventory.nameTokens||0) <= 0){ $('shopMsg').textContent='You need to buy a new name token first.'; $('shopMsg').className='feedback warn'; return; }
  if(!state.catNames) state.catNames = {}; state.catNames[idx] = name;
  state.inventory.nameTokens = Math.max(0, (state.inventory.nameTokens||0)-1);
  $('shopMsg').textContent = `Named cat #${idx+1} ‚Äú${name}‚Äù üè∑Ô∏è`; $('shopMsg').className='feedback ok';
  $('catNameInput').value=''; $('nameArea').style.display='none'; persist();
});

/* Settings etc */
$('openSettings').addEventListener('click', ()=>{
  $('settingsModal').style.display='grid';
  $('reviewToggle').textContent=`Review All Mastered: ${state.settings?.reviewAll?'ON':'OFF'}`;
  populateThemeDropdown();
});
$('closeSettings').addEventListener('click', ()=> $('settingsModal').style.display='none');
$('settingsModal').addEventListener('click', e=>{ if(e.target.id==='settingsModal') e.currentTarget.style.display='none'; });
$('reviewToggle').addEventListener('click', ()=>{
  state.settings.reviewAll = !state.settings.reviewAll; persist();
  $('reviewToggle').textContent=`Review All Mastered: ${state.settings.reviewAll?'ON':'OFF'}`;
});

/* Sentence Practice */
$('openSentences').addEventListener('click', ()=>{ $('settingsModal').style.display='none'; openSentences(); });
$('closeSentences').addEventListener('click', ()=> $('sentencesModal').style.display='none');
$('sentPrev').addEventListener('click', ()=>{ sentenceIdx--; renderSentence(); });
$('sentNext').addEventListener('click', ()=>{ sentenceIdx++; renderSentence(); });

/* Midnight countdown */
function msUntilNextMidnight(){ const n=new Date(), t=new Date(n); t.setHours(24,0,0,0); return t-n; }
function fmt(ms){ const s=Math.floor(ms/1000); const h=Math.floor(s/3600), m=Math.floor((s%3600)/60), sec=s%60;
  return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}`;
}
function showMidnight(){ alert(`New words unlock at local midnight.\nTime remaining: ${fmt(msUntilNextMidnight())}`); }
$('midnightBtn').addEventListener('click', showMidnight);
$('midnightBtn0').addEventListener('click', showMidnight);

/* ===================== PROFILE FLOW ===================== */
function useProfile(name){
  ACTIVE_PROFILE = String(name||'').trim() || 'Guest';
  loadState();
  $('profileBadge').textContent = `Profile: ${ACTIVE_PROFILE}`;
  $('profileOverlay').style.display='none';
  $('startOverlay').style.display='grid';
  if (ACTIVE_PROFILE === "Nicole") initSharedNicoleSync();
}
$('quickNicole').addEventListener('click', ()=> useProfile('Nicole'));
$('quickSia').addEventListener('click', ()=>{
  const pin = prompt('Enter developer PIN:');
  if(pin === '3232'){ useProfile('Sia'); } else{ alert('Incorrect PIN.'); }
});

/* Dev PIN reveal on profile overlay */
(function(){
  const overlay = $('profileOverlay'); const devBtn = $('quickSia'); let seq = '', timer=null, revealed=false;
  window.addEventListener('keydown', (e)=>{
    if(!overlay || overlay.style.display!=='grid' || revealed) return;
    if(!/^[0-9]$/.test(e.key)) return;
    seq+=e.key; clearTimeout(timer); timer=setTimeout(()=>{seq='';},1500);
    if(seq.endsWith('3232')){ revealed=true; devBtn.style.display='inline-block';
      const note=document.createElement('div'); note.className='tiny'; note.textContent='Developer button unlocked'; note.style.marginTop='10px';
      overlay.querySelector('.overlay-card').appendChild(note);
    }
  });
})();

/* Start overlay fallback */
function startAs(m){ mode=m; resetSessionProgress(); ensureOrder(); $('startOverlay').style.display='none'; showItem(); }
['startLearn','startQuiz'].forEach(id=>{ const el=$(id); if(el) el.setAttribute('type','button'); });
$('startOverlay').addEventListener('click',(e)=>{ if(e.target.id==='startLearn') startAs('learn'); if(e.target.id==='startQuiz') startAs('quiz'); });

/* Close modals on backdrop click */
document.addEventListener('click', (e)=>{
  if(e.target.id==='settingsModal') e.target.style.display='none';
  if(e.target.id==='sentencesModal') e.target.style.display='none';
  if(e.target.id==='achModal') e.target.style.display='none';
  if(e.target.id==='mapModal'){ e.target.style.display='none'; stopCats(); }
  if(e.target.id==='miniQuizModal'){ endMiniQuiz(); }
});

/* Init */
initSpeech();
</script>
</body>
</html>
