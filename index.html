<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Farsi Fun â€” Learn Persian Basics</title>
<style>
  :root{
    --bg:#0f172a;--card:#111827;--muted:#94a3b8;--text:#e5e7eb;--accent:#22c55e;--accent-2:#38bdf8;--warn:#f59e0b;--err:#ef4444;
    --grad1:#0b1229; --grad2:#121a36;
  }
  *{box-sizing:border-box}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans,Ubuntu,Cantarell,Helvetica Neue,Arial,"Apple Color Emoji","Segoe UI Emoji";
       margin:0;background:linear-gradient(135deg,var(--bg),#0b1028);color:var(--text)}
  header{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:16px clamp(16px,4vw,32px);
         position:sticky;top:0;background:rgba(15,23,42,.75);backdrop-filter:blur(10px);border-bottom:1px solid #1f2937;z-index:5}
  header h1{font-size:clamp(18px,2.5vw,28px);margin:0;letter-spacing:.5px;cursor:pointer}
  .stats{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .badge{background:#111827;border:1px solid #1f2937;padding:6px 10px;border-radius:999px;font-size:14px;color:var(--muted)}
  .icon-btn{display:inline-flex;align-items:center;justify-content:center;width:40px;height:40px;border-radius:10px;
            background:#111827;border:1px solid #1f2937;cursor:pointer}
  .icon-btn:hover{background:#0b1229;border-color:#263042}
  .btn,button,select{appearance:none;border:none;background:#111827;color:#e5e7eb;border:1px solid #1f2937;padding:10px 14px;border-radius:12px;cursor:pointer}
  .btn:hover,button:hover,select:hover{background:#0b1229;border-color:#263042}
  .primary{background:linear-gradient(180deg,var(--accent),#16a34a);border-color:#14532d}
  .accent{background:linear-gradient(180deg,var(--accent-2),#0ea5e9);border-color:#075985}
  main{max-width:980px;margin:24px auto;padding:0 clamp(16px,4vw,32px) 120px}
  .card{background:linear-gradient(180deg,var(--grad1),var(--grad2));border:1px solid #1f2937;border-radius:16px;padding:clamp(16px,3vw,28px)}
  .row{display:grid;grid-template-columns:1fr;gap:16px}
  @media(min-width:860px){.row{grid-template-columns:1fr 1fr}}
  .media-wrap{display:grid;place-items:center}
  .pic,.mq-pic{width:min(420px,92%);height:min(280px,45vw);object-fit:contain;background:#0b1229;border:1px solid #1f2937;border-radius:16px;display:none}
  .emoji{font-size:clamp(64px,12vw,120px);text-align:center;line-height:1;filter:drop-shadow(0 10px 20px rgba(0,0,0,.35))}
  .word{display:flex;flex-direction:column;gap:6px;align-items:flex-start;justify-content:center}
  .en{font-size:clamp(26px,3.4vw,34px);font-weight:700;color:#e2e8f0}
  .fa{font-size:clamp(18px,2.6vw,22px);color:#cbd5e1;direction:rtl;text-align:right}
  .trans{font-size:clamp(26px,3.4vw,34px);font-weight:600;color:#e2e8f0}
  .controls{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-top:10px}
  .input{background:#0b1229;border:1px solid #1f2937;padding:12px 14px;border-radius:12px;color:#e5e7eb;width:100%;font-size:16px}
  .feedback{margin-top:8px;min-height:24px;font-size:15px}
  .ok{color:var(--accent)} .warn{color:var(--warn)} .err{color:var(--err)}
  .progress{margin-top:12px;height:10px;background:#0b1229;border-radius:999px;border:1px solid #1f2937;overflow:hidden}
  .bar{height:100%;width:0%;background:linear-gradient(90deg,#38bdf8,#22c55e);transition:width .4s ease}
  .mode{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px;align-items:center}
  .tiny{font-size:12px;color:#94a3b8}
  .cele-msg{position:fixed;left:50%;bottom:72px;transform:translateX(-50%);background:rgba(17,24,39,.92);border:1px solid #1f2937;padding:14px 18px;border-radius:14px;font-weight:800;z-index:20}
  .fade-out{animation:fadeOut .9s ease forwards}@keyframes fadeOut{to{opacity:0}}

  .overlay{position:fixed;inset:0;background:radial-gradient(1000px 600px at 50% -10%, rgba(56,189,248,.25), transparent 40%), rgba(15,23,42,.94);display:grid;place-items:center;z-index:10}
  .overlay-card,.modal-card{background:linear-gradient(180deg,#0b1229,#121a36);border:1px solid #1f2937;border-radius:18px;padding:24px;box-shadow:0 20px 60px rgba(0,0,0,.35);max-width:760px;margin:0 16px}

  /* Standard modal backdrop */
  .modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.45);z-index:12}
  /* Blur for mini quiz & sentences */
  #miniQuizModal,#sentencesModal{backdrop-filter:blur(12px) saturate(120%);-webkit-backdrop-filter:blur(12px) saturate(120%)}

  .grid{display:grid;gap:10px}@media(min-width:760px){.grid{grid-template-columns:1fr 1fr}}
  .stat{background:#0b1229;border:1px solid #1f2937;border-radius:12px;padding:10px}
  .chip{display:inline-flex;gap:6px;background:#0b1229;border:1px solid #1f2937;border-radius:999px;padding:6px 10px;font-size:12px;color:#94a3b8;margin:2px 4px 0 0}

  /* Bazaar yard + cats */
  .yard{position:relative;border:1px solid #1f2937;background:#0b1229;border-radius:14px;height:360px;overflow:hidden}
  .cat{position:absolute;font-size:36px;user-select:none;cursor:pointer;filter:drop-shadow(0 8px 16px rgba(0,0,0,.35))}
  .cat-tag{position:absolute;left:50%;transform:translateX(-50%);bottom:42px;font-size:12px;background:rgba(0,0,0,.35);padding:2px 6px;border-radius:8px;color:#e5e7eb;border:1px solid #1f2937;white-space:nowrap}
  .heart{position:absolute;font-size:18px;pointer-events:none;opacity:0;transform:translate(-50%,0)}
  .cat:hover .cat-tag{background:rgba(0,0,0,.5)}
  .yard-hud{position:absolute;right:10px;top:10px;z-index:2;background:#111827;border:1px solid #1f2937;border-radius:999px;padding:6px 10px;font-size:12px;color:#94a3b8}

  /* Old grid (only when 0 cats) */
  .map{display:grid;grid-template-columns:repeat(4, minmax(60px,1fr));gap:8px;margin-top:10px}
  .tile{aspect-ratio:1/1;background:#0b1229;border:1px dashed #334155;border-radius:10px;display:grid;place-items:center;font-size:28px;color:#334155}
  .tile.unlocked{border-style:solid;color:#e5e7eb}

  /* Heavy blur for profile/start overlays */
  #profileOverlay,#startOverlay{
    background:
      radial-gradient(1000px 600px at 50% -10%, rgba(56,189,248,.25), transparent 40%),
      rgba(15,23,42,.60);
    backdrop-filter: blur(28px) saturate(120%);
    -webkit-backdrop-filter: blur(28px) saturate(120%);
  }
</style>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js" defer></script>
</head>
<body>
<header>
  <h1>âœ¨ Farsi Fun â€” Learn Persian Basics</h1>
  <div class="stats">
    <div class="badge" id="profileBadge">Profile: â€”</div>
    <div class="badge" id="scoreBadge">Score: 0</div>
    <div class="badge" id="streakBadge">Streak: 0 ğŸ”¥</div>
    <div class="badge" id="unlockedBadge">0/0 unlocked</div>
    <button id="openMap" class="icon-btn" title="Cat Bazaar">ğŸ±</button>
    <button id="openAchievements" class="icon-btn" title="Badges">ğŸ†</button>
    <button id="openSettings" class="icon-btn" title="Settings">âš™ï¸</button>
  </div>
</header>

<!-- Profile chooser -->
<div id="profileOverlay" class="overlay" style="display:grid">
  <div class="overlay-card" style="position:relative; text-align:center">
    <h2 style="margin-top:0">Who are you?</h2>
    <p class="tiny" style="margin-bottom:20px">Choose your profile to continue</p>
    <button id="quickNicole" class="primary" style="font-size:20px; padding:14px 28px;">Nicole</button>
    <button id="quickSia"
      style="position:absolute; bottom:10px; right:10px; font-size:12px; padding:4px 8px; opacity:0.75; display:none;"
      class="btn" title="Developer">Siyavash</button>
  </div>
</div>

<!-- Start screen -->
<div id="startOverlay" class="overlay" style="display:none">
  <div class="overlay-card">
    <h2>How do you want to learn today?</h2>
    <p>Pick a mode to get started. You can switch later.</p>
    <div style="display:flex; gap:12px; flex-wrap:wrap">
      <button id="startLearn" class="primary" type="button">ğŸ“š Learn Mode</button>
      <button id="startQuiz" class="accent" type="button">ğŸ¯ Quiz Mode</button>
    </div>
    <p class="tiny" style="margin-top:10px">Tip: Use <b>Chrome</b>. <b>Listen</b> plays your MP3s. New words unlock at <button id="midnightBtn0" class="btn" style="padding:2px 6px">midnight</button>.</p>
  </div>
</div>

<main>
  <div class="mode">
    <button id="learnBtn" class="btn">Learn Mode</button>
    <button id="quizBtn" class="btn">Quiz Mode</button>
    <span class="tiny">New words unlock at <button id="midnightBtn" class="btn" style="padding:2px 6px">midnight</button> â°</span>
  </div>

  <div class="card">
    <div class="row">
      <div class="media-wrap">
        <img id="pic" class="pic" alt="" />
        <div class="emoji" id="emoji">ğŸ</div>
      </div>
      <div class="word" id="wordWrap">
        <div class="en" id="en">apple</div>
        <div class="fa" id="fa" dir="rtl">Ø³ÛŒØ¨</div>
        <div class="trans" id="trans">sib</div>

        <!-- Main practice UI -->
        <div id="learnUI">
          <div class="controls">
            <button id="listenBtn" class="accent">ğŸ”Š Listen</button>
            <button id="sayBtn" class="btn" disabled title="(optional speech recog)">ğŸ™ï¸ Say it</button>
            <button id="hintBtn" class="btn">ğŸ’¡ Hint</button>
            <button id="revealBtn" class="btn">ğŸ‘€ Reveal</button>
            <button id="nextBtn" class="primary">â¡ï¸ Next</button>
          </div>

          <div class="feedback" id="speechFeedback"></div>

          <label class="tiny" for="typeInput">Type the pronunciation (English letters):</label>
          <input class="input" id="typeInput" placeholder="e.g., sib"/>
          <div class="controls">
            <button id="checkBtn" class="primary">âœ… Check</button>
            <button id="skipBtn" class="btn">â­ï¸ Skip</button>
          </div>
          <div class="feedback" id="typeFeedback"></div>

          <div class="progress"><div class="bar" id="progressBar"></div></div>
        </div>
      </div>
    </div>
  </div>
</main>

<footer style="padding:16px;text-align:center;color:#94a3b8">
  Put images in <b>/images</b> (e.g., <code>images/sib.png</code>). Put audio in <b>/audio</b> (e.g., <code>audio/sib.mp3</code>). Optional encouragement in <b>/audio/encouragement/</b>.
</footer>

<div id="celebration" class="cele-msg" style="display:none">let's goooooo ğŸ‰</div>
<div id="sadFace" class="cele-msg" style="display:none">ğŸ˜¢</div>

<!-- Achievements Modal -->
<div id="achModal" class="modal">
  <div class="modal-card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
      <h3 style="margin:0">ğŸ† Badges</h3>
      <button id="closeAch" class="btn">Close</button>
    </div>
    <div id="achList" class="grid"></div>
  </div>
</div>

<!-- Bazaar / Cat Yard Modal -->
<div id="mapModal" class="modal">
  <div class="modal-card" style="max-width:900px">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
      <h3 style="margin:0">ğŸ± Cat Bazaar</h3>
      <div style="display:flex;gap:8px">
        <button id="openShop" class="btn accent" title="Redeem rewards">ğŸ Redeem</button>
        <button id="closeMap" class="btn">Close</button>
      </div>
    </div>
    <p class="tiny">Meet your daily goal (learn/check <b>at least 5 words</b>) to unlock a new bazaar cat.</p>

    <!-- If 0 cats -> show placeholder grid with ? tiles -->
    <div id="bazaarGrid" class="map" style="display:none"></div>

    <!-- Once thereâ€™s at least 1 cat -> show roaming cats here -->
    <div id="bazaarYard" class="yard" style="display:none">
      <div id="fishHUD" class="yard-hud">ğŸŸ 0</div>
    </div>
  </div>
</div>

<!-- Shop Modal -->
<div id="shopModal" class="modal">
  <div class="modal-card" style="max-width:820px">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
      <h3 style="margin:0">ğŸ Cat Bazaar â€” Redeem</h3>
      <button id="closeShop" class="btn">Close</button>
    </div>

    <div class="grid">
      <div class="stat">
        <b>Balance</b>
        <div class="tiny" style="margin-top:6px">
          Score: <b id="scoreBalance">0</b> â€¢ Fish: <b id="fishBalance">0</b>
        </div>
      </div>

      <div class="stat">
        <b>Buy Fish</b>
        <p class="tiny">Feed cats to make them happy.</p>
        <div class="controls">
          <button id="buyFish1" class="btn">ğŸŸ Ã—1 â€” 20 pts</button>
          <button id="buyFish5" class="btn">ğŸŸ Ã—5 â€” 80 pts</button>
        </div>
      </div>

      <div class="stat">
        <b>Name a Cat</b>
        <p class="tiny">Give a cat a name (50 pts).</p>
        <div class="controls" style="gap:8px">
          <select id="nameCatSelect" class="btn"></select>
          <input id="nameCatInput" class="input" placeholder="Type a cute nameâ€¦"/>
          <button id="nameCatBtn" class="primary">Save</button>
        </div>
        <div id="nameCatFeedback" class="tiny" style="margin-top:6px"></div>
      </div>
    </div>
  </div>
</div>

<!-- Sentence Practice Modal (left as-is from your version) -->
<div id="sentencesModal" class="modal">
  <div class="modal-card" style="max-width:820px">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
      <h3 style="margin:0">ğŸ“– Sentence Practice</h3>
      <button id="closeSentences" class="btn">Close</button>
    </div>

    <div id="sentencePanel" class="stat">
      <div class="fa" id="sentFa" dir="rtl" style="font-size:22px"></div>
      <div class="trans" id="sentTrans" style="font-size:18px; margin-top:8px"></div>
      <div class="en" id="sentEn" style="font-size:18px; margin-top:4px"></div>
    </div>

    <div class="controls" style="justify-content:space-between">
      <div class="tiny" id="sentProgress"></div>
      <div>
        <button id="sentPrev" class="btn">â¬…ï¸ Prev</button>
        <button id="sentNext" class="primary">Next â¡ï¸</button>
      </div>
    </div>
  </div>
</div>

<!-- Mini Quiz Modal -->
<div id="miniQuizModal" class="modal">
  <div class="modal-card" style="max-width:740px">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
      <h3 style="margin:0">âš¡ Mini Quiz</h3>
      <button id="mqQuit" class="btn" title="Exit Mini Quiz">âœ– Quit</button>
    </div>
    <div class="qprogress" style="height:8px;background:#0a142e;border:1px solid #1f2937;border-radius:999px;overflow:hidden;margin-bottom:12px">
      <div id="mqBar" class="bar" style="height:8px;width:0%"></div>
    </div>
    <img id="mqPic" class="mq-pic" alt="" style="display:block;margin:auto"/>
    <input id="mqInput" class="input" placeholder="Type the transliterationâ€¦" style="margin-top:12px"/>
    <div class="controls" style="justify-content:flex-end"><button id="mqCheck" class="primary">Check</button></div>
    <div id="mqFeedback" class="feedback"></div>
  </div>
</div>

<script>
/* ===================== PROFILED STORAGE ===================== */
let ACTIVE_PROFILE = null;
const GLOBAL_PREFIX = 'ff';
function PKEY(k){ return `${GLOBAL_PREFIX}:${ACTIVE_PROFILE||'__anon'}:${k}`; }
const store = {
  get:(k,def=null)=>{ try{ const v=localStorage.getItem(PKEY(k)); return v===null?def:JSON.parse(v); }catch{ return def; } },
  set:(k,v)=>{ try{ localStorage.setItem(PKEY(k), JSON.stringify(v)); }catch{} },
  del:(k)=>{ try{ localStorage.removeItem(PKEY(k)); }catch{} }
};

/* ===================== CONSTANTS ===================== */
const DAILY_WORDS = 5;
const SRS_INTERVALS_HOURS = [0,8,24,72,168,336];
const MINI_QUIZ_SIZE = 5;

/* Example sentences */
const SENTENCES = [
  { fa:"Ù…Ù† Ø¢Ø¨ Ù…ÛŒâ€ŒÙ†ÙˆØ´Ù….", translit:"man Ã¢b minusham.", en:"I drink water." },
  { fa:"Ø§Ùˆ ÛŒÚ© Ú¯Ø±Ø¨Ù‡ Ø¯Ø§Ø±Ø¯.", translit:"u yek gorbe dÃ¢rad.", en:"He/She has a cat." },
  { fa:"Ø§ÛŒÙ† Ø®Ø§Ù†Ù‡ Ø¨Ø²Ø±Ú¯ Ø§Ø³Øª.", translit:"in khÃ¢ne bozorg ast.", en:"This house is big." },
  { fa:"Ù…Ù† Ú©ØªØ§Ø¨ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù†Ù….", translit:"man ketÃ¢b mikhÃ¢nam.", en:"I am reading a book." },
  { fa:"Ø§Ù…Ø±ÙˆØ² Ù‡ÙˆØ§ Ø®ÙˆØ¨ Ø§Ø³Øª.", translit:"emruz havÃ¢ khub ast.", en:"The weather is good today." },
  { fa:"Ø³Ú¯ Ø¯Ø± Ù¾Ø§Ø±Ú© Ø§Ø³Øª.", translit:"sag dar pÃ¢rk ast.", en:"The dog is in the park." }
];

/* ===================== WORDS ===================== */
const words = [
  {fa:"Ø³ÛŒØ¨", en:"apple", translit:"sib", emoji:"ğŸ", audio:"audio/sib.mp3", image:"images/sib.png"},
  {fa:"Ú©ØªØ§Ø¨", en:"book", translit:"ketÃ¢b", emoji:"ğŸ“–", audio:"audio/ketab.mp3", image:"images/ketab.png"},
  {fa:"Ú¯Ø±Ø¨Ù‡", en:"cat", translit:"gorbe", emoji:"ğŸ±", audio:"audio/gorbe.mp3", image:"images/gorbe.png"},
  {fa:"Ø³Ú¯", en:"dog", translit:"sag", emoji:"ğŸ¶", audio:"audio/sag.mp3", image:"images/sag.png"},
  {fa:"Ø¢Ø¨", en:"water", translit:"Ã¢b", emoji:"ğŸ’§", audio:"audio/ab.mp3", image:"images/ab.png"},
  {fa:"Ù†Ø§Ù†", en:"bread", translit:"nÃ¢n", emoji:"ğŸ", audio:"audio/nan.mp3", image:"images/nan.png"},
  {fa:"Ú†Ø§ÛŒ", en:"tea", translit:"chÃ¢y", emoji:"ğŸµ", audio:"audio/chay.mp3", image:"images/chay.png"},
  {fa:"Ù…Ø§Ø´ÛŒÙ†", en:"car", translit:"mÃ¢shin", emoji:"ğŸš—", audio:"audio/mashin.mp3", image:"images/mashin.png"},
  {fa:"Ø®Ø§Ù†Ù‡", en:"house", translit:"khÃ¢ne", emoji:"ğŸ ", audio:"audio/khane.mp3", image:"images/khane.png"},
  {fa:"Ø¯Ø±", en:"door", translit:"dar", emoji:"ğŸšª", audio:"audio/dar.mp3", image:"images/dar.png"},
  {fa:"Ø³Ù„Ø§Ù…", en:"hello", translit:"salÃ¢m", emoji:"ğŸ‘‹", audio:"audio/salam.mp3", image:"images/salam.png"},
  {fa:"Ø®Ø¯Ø§Ø­Ø§ÙØ¸", en:"goodbye", translit:"khodÃ¢hÃ¢fez", emoji:"ğŸ‘‹", audio:"audio/khodahafez.mp3", image:"images/khodahafez.png"},
  {fa:"Ø¨Ù„Ù‡", en:"yes", translit:"bale", emoji:"âœ…", audio:"audio/bale.mp3", image:"images/bale.png"},
  {fa:"Ù†Ù‡", en:"no", translit:"na", emoji:"âŒ", audio:"audio/na.mp3", image:"images/na.png"},
  {fa:"Ù„Ø·ÙØ§Ù‹", en:"please", translit:"lotfan", emoji:"ğŸ™", audio:"audio/lotfan.mp3", image:"images/lotfan.png"},
  {fa:"Ù…ØªØ´Ú©Ø±Ù…", en:"thank you", translit:"moteshakeram", emoji:"ğŸ™", audio:"audio/moteshakeram.mp3", image:"images/moteshakeram.png"},
  {fa:"ØµØ¨Ø­ Ø¨Ø®ÛŒØ±", en:"good morning", translit:"sobh bekheir", emoji:"ğŸŒ…", audio:"audio/sobh_bekheir.mp3", image:"images/sobh_bekheir.png"},
  {fa:"Ø´Ø¨ Ø¨Ø®ÛŒØ±", en:"good night", translit:"shab bekheir", emoji:"ğŸŒ™", audio:"audio/shab_bekheir.mp3", image:"images/shab_bekheir.png"},
  {fa:"Ø§Ù…Ø±ÙˆØ²", en:"today", translit:"emruz", emoji:"ğŸ“…", audio:"audio/emruz.mp3", image:"images/emruz.png"},
  {fa:"ÙØ±Ø¯Ø§", en:"tomorrow", translit:"fardÃ¢", emoji:"ğŸ“…", audio:"audio/farda.mp3", image:"images/farda.png"},
  {fa:"Ø¯ÛŒØ±ÙˆØ²", en:"yesterday", translit:"diruz", emoji:"ğŸ“…", audio:"audio/diruz.mp3", image:"images/diruz.png"},
  {fa:"Ø¯ÙˆØ³Øª", en:"friend", translit:"dust", emoji:"ğŸ¤", audio:"audio/dust.mp3", image:"images/dust.png"},
  {fa:"Ø®Ø§Ù†ÙˆØ§Ø¯Ù‡", en:"family", translit:"khÃ¢nevÃ¢de", emoji:"ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦", audio:"audio/khanevade.mp3", image:"images/khanevade.png"},
  {fa:"Ù¾Ø¯Ø±", en:"father", translit:"pedar", emoji:"ğŸ‘¨", audio:"audio/pedar.mp3", image:"images/pedar.png"},
  {fa:"Ù…Ø§Ø¯Ø±", en:"mother", translit:"mÃ¢dar", emoji:"ğŸ‘©", audio:"audio/madar.mp3", image:"images/madar.png"},
  {fa:"Ø¨Ø±Ø§Ø¯Ø±", en:"brother", translit:"barÃ¢dar", emoji:"ğŸ‘¦", audio:"audio/baradar.mp3", image:"images/baradar.png"},
  {fa:"Ø®ÙˆØ§Ù‡Ø±", en:"sister", translit:"khÃ¢har", emoji:"ğŸ‘§", audio:"audio/khahar.mp3", image:"images/khahar.png"},
  {fa:"Ø¨Ú†Ù‡", en:"child", translit:"bache", emoji:"ğŸ§’", audio:"audio/bache.mp3", image:"images/bache.png"},
  {fa:"Ù…Ø¯Ø±Ø³Ù‡", en:"school", translit:"madrese", emoji:"ğŸ«", audio:"audio/madrese.mp3", image:"images/madrese.png"},
  {fa:"Ø¯Ø§Ù†Ø´Ú¯Ø§Ù‡", en:"university", translit:"dÃ¢neÅ¡gÃ¢h", emoji:"ğŸ“", audio:"audio/danesgah.mp3", image:"images/danesgah.png"},
  {fa:"Ú©Ø§Ø±", en:"work", translit:"kÃ¢r", emoji:"ğŸ’¼", audio:"audio/kÃ¢r.mp3", image:"images/kÃ¢r.png"},
  {fa:"Ø¯ÙØªØ±", en:"office", translit:"daftar", emoji:"ğŸ¢", audio:"audio/daftar.mp3", image:"images/daftar.png"},
  {fa:"Ù…ØºØ§Ø²Ù‡", en:"shop", translit:"maghÃ¢ze", emoji:"ğŸª", audio:"audio/maghaze.mp3", image:"images/maghaze.png"},
  {fa:"Ø¨Ø§Ø²Ø§Ø±", en:"bazaar", translit:"bÃ¢zÃ¢r", emoji:"ğŸ›ï¸", audio:"audio/bazar.mp3", image:"images/bazar.png"},
  {fa:"Ù¾ÙˆÙ„", en:"money", translit:"pul", emoji:"ğŸ’µ", audio:"audio/pul.mp3", image:"images/pul.png"},
  {fa:"ØªÙ„ÙÙ†", en:"phone", translit:"telefon", emoji:"ğŸ“±", audio:"audio/telefon.mp3", image:"images/telefon.png"},
  {fa:"Ú©Ø§Ù…Ù¾ÛŒÙˆØªØ±", en:"computer", translit:"kÃ¢mpiyuter", emoji:"ğŸ’»", audio:"audio/kampiyuter.mp3", image:"images/kampiyuter.png"},
  {fa:"Ø§ÛŒÙ†ØªØ±Ù†Øª", en:"internet", translit:"internet", emoji:"ğŸŒ", audio:"audio/internet.mp3", image:"images/internet.png"},
  {fa:"Ù…ÛŒØ²", en:"table", translit:"miz", emoji:"ğŸ›‹ï¸", audio:"audio/miz.mp3", image:"images/miz.png"},
  {fa:"ØµÙ†Ø¯Ù„ÛŒ", en:"chair", translit:"sandali", emoji:"ğŸª‘", audio:"audio/sandali.mp3", image:"images/sandali.png"},
  {fa:"ØªØ®Øª", en:"bed", translit:"takht", emoji:"ğŸ›ï¸", audio:"audio/takht.mp3", image:"images/takht.png"},
  {fa:"Ø¢Ø´Ù¾Ø²Ø®Ø§Ù†Ù‡", en:"kitchen", translit:"Ã¢shpazkhÃ¢ne", emoji:"ğŸ³", audio:"audio/ashpazkhane.mp3", image:"images/ashpazkhane.png"},
  {fa:"Ø­Ù…Ø§Ù…", en:"bathroom", translit:"hamÃ¢m", emoji:"ğŸš¿", audio:"audio/hamÃ¢m.mp3", image:"images/hamÃ¢m.png"},
  {fa:"Ø§ØªØ§Ù‚", en:"room", translit:"otÃ¢gh", emoji:"ğŸšª", audio:"audio/otagh.mp3", image:"images/otagh.png"},
  {fa:"Ø´Ù‡Ø±", en:"city", translit:"shahr", emoji:"ğŸ™ï¸", audio:"audio/shahr.mp3", image:"images/shahr.png"},
  {fa:"Ø±ÙˆØ³ØªØ§", en:"village", translit:"rustÃ¢", emoji:"ğŸ¡", audio:"audio/rustÃ¢.mp3", image:"images/rustÃ¢.png"},
  {fa:"Ø®ÛŒØ§Ø¨Ø§Ù†", en:"street", translit:"khiÃ¢bÃ¢n", emoji:"ğŸ›£ï¸", audio:"audio/khiÃ¢bÃ¢n.mp3", image:"images/khiÃ¢bÃ¢n.png"},
  {fa:"Ù¾Ø§Ø±Ú©", en:"park", translit:"pÃ¢rk", emoji:"ğŸŒ³", audio:"audio/pÃ¢rk.mp3", image:"images/pÃ¢rk.png"},
  {fa:"Ø¨ÛŒÙ…Ø§Ø±Ø³ØªØ§Ù†", en:"hospital", translit:"bimÃ¢restÃ¢n", emoji:"ğŸ¥", audio:"audio/bimÃ¢restÃ¢n.mp3", image:"images/bimÃ¢restÃ¢n.png"},
  {fa:"Ø¯Ø§Ø±ÙˆØ®Ø§Ù†Ù‡", en:"pharmacy", translit:"dÃ¢rukhÃ¢ne", emoji:"ğŸ’Š", audio:"audio/dÃ¢rukhÃ¢ne.mp3", image:"images/dÃ¢rukhÃ¢ne.png"},
  {fa:"Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡", en:"library", translit:"ketÃ¢bkhÃ¢ne", emoji:"ğŸ“š", audio:"audio/ketÃ¢Ø¨khÃ¢ne.mp3", image:"images/ketÃ¢Ø¨khÃ¢ne.png"},
  {fa:"Ø§ÛŒØ³ØªÚ¯Ø§Ù‡", en:"station", translit:"istgÃ¢h", emoji:"ğŸš‰", audio:"audio/istgÃ¢h.mp3", image:"images/istgÃ¢h.png"},
  {fa:"ÙØ±ÙˆØ¯Ú¯Ø§Ù‡", en:"airport", translit:"forudgÃ¢h", emoji:"âœˆï¸", audio:"audio/forudgÃ¢h.mp3", image:"images/forudgÃ¢h.png"},
  {fa:"Ø§ØªÙˆØ¨ÙˆØ³", en:"bus", translit:"otobus", emoji:"ğŸšŒ", audio:"audio/otobus.mp3", image:"images/otobus.png"},
  {fa:"ØªØ§Ú©Ø³ÛŒ", en:"taxi", translit:"tÃ¢xi", emoji:"ğŸš•", audio:"audio/tÃ¢xi.mp3", image:"images/tÃ¢xi.png"},
  {fa:"Ù‚Ø·Ø§Ø±", en:"train", translit:"ghatÃ¢r", emoji:"ğŸš†", audio:"audio/ghatÃ¢r.mp3", image:"images/ghatÃ¢r.png"},
  {fa:"Ø¯ÙˆÚ†Ø±Ø®Ù‡", en:"bicycle", translit:"docharkhe", emoji:"ğŸš²", audio:"audio/docharkhe.mp3", image:"images/docharkhe.png"},
  {fa:"Ù‡ÙˆØ§Ù¾ÛŒÙ…Ø§", en:"airplane", translit:"havÃ¢peymÃ¢", emoji:"âœˆï¸", audio:"audio/havÃ¢peymÃ¢.mp3", image:"images/havÃ¢peymÃ¢.png"},
  {fa:"Ú©ÙØ´", en:"shoe", translit:"kafsh", emoji:"ğŸ‘Ÿ", audio:"audio/kafsh.mp3", image:"images/kafsh.png"},
  {fa:"Ù„Ø¨Ø§Ø³", en:"clothes", translit:"lebÃ¢s", emoji:"ğŸ‘•", audio:"audio/lebÃ¢Ø³.mp3", image:"images/lebÃ¢Ø³.png"},
  {fa:"Ø´Ù„ÙˆØ§Ø±", en:"pants", translit:"shalvÃ¢r", emoji:"ğŸ‘–", audio:"audio/shalvÃ¢r.mp3", image:"images/shalvÃ¢r.png"},
  {fa:"Ù¾ÛŒØ±Ø§Ù‡Ù†", en:"shirt", translit:"pirÃ¢han", emoji:"ğŸ‘”", audio:"audio/pirÃ¢han.mp3", image:"images/pirÃ¢han.png"},
  {fa:"Ú©Ù„Ø§Ù‡", en:"hat", translit:"kolÃ¢h", emoji:"ğŸ©", audio:"audio/kolÃ¢h.mp3", image:"images/kolÃ¢h.png"},
  {fa:"Ø¹ÛŒÙ†Ú©", en:"glasses", translit:"eynÃ¢k", emoji:"ğŸ‘“", audio:"audio/eynÃ¢k.mp3", image:"images/eynÃ¢k.png"},
  {fa:"Ø³Ø§Ø¹Øª", en:"clock", translit:"sÃ¢'at", emoji:"â°", audio:"audio/sÃ¢'at.mp3", image:"images/sÃ¢'at.png"},
  {fa:"Ø±ÙˆØ²", en:"day", translit:"ruz", emoji:"ğŸŒ", audio:"audio/ruz.mp3", image:"images/ruz.png"},
  {fa:"Ø´Ø¨", en:"night", translit:"shab", emoji:"ğŸŒ™", audio:"audio/shab.mp3", image:"images/shab.png"},
  {fa:"ØµØ¨Ø­", en:"morning", translit:"sobh", emoji:"ğŸŒ…", audio:"audio/sobh.mp3", image:"images/sobh.png"},
  {fa:"Ø¹ØµØ±", en:"evening", translit:"asr", emoji:"ğŸŒ†", audio:"audio/asr.mp3", image:"images/asr.png"},
  {fa:"Ù‡ÙØªÙ‡", en:"week", translit:"hafte", emoji:"ğŸ“…", audio:"audio/hafte.mp3", image:"images/hafte.png"},
  {fa:"Ù…Ø§Ù‡", en:"month", translit:"mÃ¢h", emoji:"ğŸ“†", audio:"audio/mÃ¢h.mp3", image:"images/mÃ¢h.png"},
  {fa:"Ø³Ø§Ù„", en:"year", translit:"sÃ¢l", emoji:"ğŸ“†", audio:"audio/sÃ¢l.mp3", image:"images/sÃ¢l.png"},
  {fa:"ÛŒÚ©", en:"one", translit:"yek", emoji:"1ï¸âƒ£", audio:"audio/yek.mp3", image:"images/yek.png"},
  {fa:"Ø¯Ùˆ", en:"two", translit:"do", emoji:"2ï¸âƒ£", audio:"audio/do.mp3", image:"images/do.png"},
  {fa:"Ø³Ù‡", en:"three", translit:"se", emoji:"3ï¸âƒ£", audio:"audio/se.mp3", image:"images/se.png"},
  {fa:"Ú†Ù‡Ø§Ø±", en:"four", translit:"chahÃ¢r", emoji:"4ï¸âƒ£", audio:"audio/chahÃ¢r.mp3", image:"images/chahÃ¢r.png"},
  {fa:"Ù¾Ù†Ø¬", en:"five", translit:"panj", emoji:"5ï¸âƒ£", audio:"audio/panj.mp3", image:"images/panj.png"},
  {fa:"Ø´Ø´", en:"six", translit:"shesh", emoji:"6ï¸âƒ£", audio:"audio/shesh.mp3", image:"images/shesh.png"},
  {fa:"Ù‡ÙØª", en:"seven", translit:"haft", emoji:"7ï¸âƒ£", audio:"audio/haft.mp3", image:"images/haft.png"},
  {fa:"Ù‡Ø´Øª", en:"eight", translit:"hasht", emoji:"8ï¸âƒ£", audio:"audio/hasht.mp3", image:"images/hasht.png"},
  {fa:"Ù†Ù‡", en:"nine", translit:"noh", emoji:"9ï¸âƒ£", audio:"audio/noh.mp3", image:"images/noh.png"},
  {fa:"Ø¯Ù‡", en:"ten", translit:"dah", emoji:"ğŸ”Ÿ", audio:"audio/dah.mp3", image:"images/dah.png"}
];

/* ===================== THEMES (rewards) ===================== */
const THEMES = [
  {key:'default', name:'Ocean (default)', unlockAt:0,  vars:{'--grad1':'#0b1229','--grad2':'#121a36','--accent-2':'#38bdf8','--accent':'#22c55e','--bg':'#0f172a'}},
  {key:'sunset',  name:'Sunset',          unlockAt:50, vars:{'--grad1':'#2a0f1b','--grad2':'#3a1f2a','--accent-2':'#fb923c','--accent':'#f59e0b','--bg':'#1a0c12'}},
  {key:'mint',    name:'Mint',            unlockAt:100,vars:{'--grad1':'#0d1f1a','--grad2':'#123227','--accent-2':'#34d399','--accent':'#10b981','--bg':'#0b1814'}},
  {key:'amethyst',name:'Amethyst',        unlockAt:150,vars:{'--grad1':'#1b1330','--grad2':'#2a1f4d','--accent-2':'#a78bfa','--accent':'#8b5cf6','--bg':'#130f24'}},
  {key:'night',   name:'Night Bazaar',    unlockAt:200,vars:{'--grad1':'#0a0a0f','--grad2':'#15151f','--accent-2':'#60a5fa','--accent':'#22d3ee','--bg':'#0a0b12'}}
];
function applyTheme(key){
  const t = THEMES.find(x=>x.key===key) || THEMES[0];
  for(const [k,v] of Object.entries(t.vars)) document.documentElement.style.setProperty(k, v);
  state.theme = t.key; persist();
}
function learnedCount(){ return (state.covered||[]).length; }
function isThemeUnlocked(theme){ return learnedCount() >= theme.unlockAt; }
function nextUnlockNote(){
  const learned = learnedCount();
  const next = THEMES.find(t=>t.unlockAt>learned);
  return next ? `Next theme unlocks at <b>${next.unlockAt}</b> learned. (You: ${learned})` : `All themes unlocked! ğŸ‰ (You: ${learned})`;
}
function populateThemeDropdown(){
  const sel = $('themeSelect'); if(!sel) return;
  sel.innerHTML='';
  THEMES.forEach(t=>{
    const opt=document.createElement('option');
    opt.value=t.key;
    const locked = !isThemeUnlocked(t);
    opt.textContent = locked ? `${t.name} â€” locked (needs ${t.unlockAt})` : t.name;
    opt.disabled = locked;
    if((state.theme||'default')===t.key) opt.selected=true;
    sel.appendChild(opt);
  });
  $('themeNote').innerHTML = nextUnlockNote();
}

/* ===================== UTILITIES ===================== */
const $=id=>document.getElementById(id);
const bySel=s=>document.querySelector(s);
function now(){return Date.now()}
function todayISO(){const d=new Date();d.setHours(0,0,0,0);return d.toISOString().slice(0,10)}
function normalizeTranslit(s){return (s||'').toLowerCase().normalize('NFKD').replace(/[\u0302\u0304]/g,'').replace(/[^a-z0-9]+/g,'').trim()}
function normalizeFa(s){return (s||'').replace(/\s+/g,'').replace(/ÙŠ/g,'ÛŒ').replace(/Ùƒ/g,'Ú©').replace(/[\u200C\u200F\u202A-\u202E]/g,'')}
function shuffle(a){ for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]} return a }
function isTouch(){ return ('ontouchstart' in window) || navigator.maxTouchPoints>0; }

/* ===================== STATE (per profile) ===================== */
const defaultState = ()=>({
  score:0, streak:0, srs:{}, covered:[], start_date:null, unlocked_count:0,
  achievements:{first10:false,perfectMini:false,streak7:false,mastered50:false},
  mapUnlocked:0, mapDays:[], // {date, correct, goalMet}
  settings:{reviewAll:false},
  theme:'default',
  cats:{ fish:0, names:{} }  // ğŸ‘ˆ NEW: cat economy
});
let state = defaultState();
let mode='learn', order=[], idx=0;

/* Helpers for SRS & pools */
function ensureSRS(i){ if(!state.srs[i]) state.srs[i]={stage:0,due:0,seen:0,correct:0,wrong:0}; return state.srs[i]; }
function isDue(i){ return ensureSRS(i).due <= now(); }
function scheduleAfter(i,h){ ensureSRS(i).due = now()+h*3600*1000; }
function getCoveredSet(){ return new Set(state.covered||[]); }
function addCovered(i){ const s=getCoveredSet(); s.add(i); state.covered=[...s]; persist(); }

function initDailyUnlock(){
  if(!state.start_date){ state.start_date=todayISO(); }
  const startDate = new Date(state.start_date+'T00:00:00');
  const dNow = new Date(); dNow.setHours(0,0,0,0);
  const diffDays = Math.floor((dNow - startDate)/86400000);
  const shouldUnlock = Math.min(words.length, (diffDays+1)*DAILY_WORDS);
  state.unlocked_count = Math.max(state.unlocked_count||0, shouldUnlock);
  persist();
}
function unlockedCount(){ return state.unlocked_count||Math.min(words.length, DAILY_WORDS); }
function unlockedIndices(){ return [...Array(unlockedCount()).keys()]; }
function masteredIndices(){ return [...getCoveredSet()].filter(i=>i<unlockedCount()); }
function dueIndices(){ return unlockedIndices().filter(i=>isDue(i)); }
function quizPool(){ const due=dueIndices(); if(due.length) return due; const m=masteredIndices(); return m.length?m:unlockedIndices(); }
function learnPool(){ const u=unlockedIndices(), due=u.filter(i=>isDue(i)), rest=u.filter(i=>!isDue(i)); return [...due,...rest]; }

/* ===================== PERSIST ===================== */
function persist(){ store.set('state', state); reflectBadges(); updateBadges(); renderBazaar(); populateThemeDropdown(); }
function loadState(){ state = store.get('state', defaultState()); initDailyUnlock(); if(!state.cats) state.cats={fish:0,names:{}}; applyTheme(state.theme||'default'); }

/* ======== (OPTIONAL) Shared Nicole Sync from your previous version ======== */
const SYNC_ENDPOINT = "https://ff-sync.9rmcqs6hjc.workers.dev";
const SYNC_DOC_ID = "nicole";
const SYNC_WRITE_TOKEN = "Gravity123!!";

function mergeStates(local, remote){
  if(!remote || !remote.updated_at) return local;
  const newer = (local.updated_at||0) >= (remote.updated_at||0) ? local : remote;
  const other = newer===local ? remote : local;
  const cov = new Set([...(local.covered||[]), ...(remote.covered||[])]);
  newer.covered = [...cov];
  newer.score = Math.max(local.score||0, remote.score||0);
  newer.streak = (newer===local ? local.streak : remote.streak) || 0;
  if(!newer.cats) newer.cats={fish:0,names:{}};
  if(!other.cats) other.cats={fish:0,names:{}};
  newer.cats.fish = Math.max(newer.cats.fish||0, other.cats.fish||0);
  newer.cats.names = {...other.cats.names, ...newer.cats.names};
  return newer;
}
async function syncPullNicole(){
  if(!SYNC_ENDPOINT || ACTIVE_PROFILE!=="Nicole") return;
  try{
    const res = await fetch(`${SYNC_ENDPOINT}/p/${SYNC_DOC_ID}`, { method:"GET" });
    const remote = await res.json().catch(()=>null);
    if(remote && Object.keys(remote).length){
      state = mergeStates(state, remote);
      _persist(); 
    }
  }catch{}
}
async function syncPushNicole(){
  if(!SYNC_ENDPOINT || ACTIVE_PROFILE!=="Nicole") return;
  try{
    const payload = JSON.stringify({...state, updated_at: Date.now(), profile: ACTIVE_PROFILE});
    await fetch(`${SYNC_ENDPOINT}/p/${SYNC_DOC_ID}`, {
      method: "PUT",
      headers: { "Content-Type": "application/json", ...(SYNC_WRITE_TOKEN?{"X-Token": SYNC_WRITE_TOKEN}:{}) },
      body: payload
    });
  }catch{}
}
let _persist = persist;
let _syncTimer = null;
function syncPushDebouncedNicole(){ clearTimeout(_syncTimer); _syncTimer = setTimeout(syncPushNicole, 600); }
persist = function(){ _persist(); if (ACTIVE_PROFILE === "Nicole") syncPushDebouncedNicole(); };
function initSharedNicoleSync(){
  if (ACTIVE_PROFILE !== "Nicole" || !SYNC_ENDPOINT) return;
  syncPullNicole().then(()=>syncPushNicole());
  document.addEventListener("visibilitychange", ()=> { if (document.visibilityState === "visible" && ACTIVE_PROFILE === "Nicole") syncPullNicole(); });
  window.addEventListener("online", ()=> { if (ACTIVE_PROFILE === "Nicole") syncPushNicole(); });
}

/* ===================== UI UPDATE ===================== */
function updateBadges(){
  $('profileBadge').textContent = `Profile: ${ACTIVE_PROFILE||'â€”'}`;
  $('scoreBadge').textContent = `Score: ${state.score}`;
  $('streakBadge').textContent = `Streak: ${state.streak} ğŸ”¥`;
  $('unlockedBadge').textContent = `${unlockedCount()}/${words.length} unlocked`;
  const pct = Math.round((getCoveredSet().size/Math.max(1,unlockedCount()))*100);
  $('progressBar').style.width = pct + '%';
}
function showImageOrEmoji(item){
  const pic=$('pic'), emo=$('emoji');
  if(item.image){ pic.style.display='block'; emo.style.display='none'; pic.src=item.image; pic.alt=item.en; }
  else { pic.style.display='none'; emo.style.display='block'; emo.textContent=item.emoji||'â“'; }
}
function ensureOrder(){ const pool = (mode==='quiz')? quizPool(): learnPool(); order=pool.slice(); shuffle(order); idx=0; }
function showItem(){
  const pool = (mode==='quiz')? quizPool(): learnPool();
  if(order.length===0 || order.some(i=>!pool.includes(i))) ensureOrder();
  const gi = order[idx % order.length]; const item = words[gi];

  showImageOrEmoji(item);
  if(mode==='quiz'){ $('en').textContent=item.en; $('fa').textContent='â€¢â€¢â€¢'; $('trans').textContent='â€”'; }
  else { $('en').textContent=item.en; $('fa').textContent=item.fa; $('trans').textContent=item.translit; }

  $('listenBtn').style.display = (mode==='quiz')?'none':'inline-flex';
  $('revealBtn').style.display = (mode==='quiz')?'inline-flex':'none';

  // mobile: donâ€™t auto-focus (keeps image visible)
  if(!isTouch()) { $('typeInput').value=''; $('typeInput').focus(); }
  else { $('typeInput').value=''; }
}
function next(){ idx=(idx+1)%Math.max(1,order.length); showItem(); }

/* ===================== CELEBRATIONS ===================== */
function happyDing(){
  try{const AC=window.AudioContext||window.webkitAudioContext;if(!AC) return;const ctx=new AC();const tones=[659,784,988];const t0=ctx.currentTime;
    tones.forEach((f,i)=>{const o=ctx.createOscillator(),g=ctx.createGain();o.type='sine';o.frequency.value=f;o.connect(g);g.connect(ctx.destination);
      const st=t0+i*0.05;g.gain.setValueAtTime(0,st);g.gain.linearRampToValueAtTime(0.35,st+0.03);g.gain.exponentialRampToValueAtTime(0.0001,st+0.22);
      o.start(st);o.stop(st+0.25);});}catch{}}
function confettiPop(){ if(window.confetti) confetti({origin:{y:1,x:0.5},gravity:1.2,ticks:180,scalar:0.9,particleCount:70,spread:75,startVelocity:55}); }
function fireworks(){ if(!window.confetti) return;
  const base={origin:{y:1,x:0.5},gravity:1.0,ticks:260,scalar:1.0};
  confetti({...base,particleCount:180,spread:120,startVelocity:65});
  confetti({...base,particleCount:140,spread:140,startVelocity:60,origin:{y:1,x:0.2}});
  confetti({...base,particleCount:140,spread:140,startVelocity:60,origin:{y:1,x:0.8}});
}
function celebrateSimple(){ happyDing(); confettiPop(); const c=$('celebration'); c.textContent="let's goooooo ğŸ‰"; c.style.display='block'; setTimeout(()=>c.classList.add('fade-out'),800); setTimeout(()=>{c.classList.remove('fade-out'); c.style.display='none';},1600); }
function celebrateStreak7(){
  fireworks();
  state.achievements.streak7 = true; persist();
  const c=$('celebration'); c.textContent="7-day streak! ğŸ…"; c.style.display='block';
  setTimeout(()=>c.classList.add('fade-out'),1200);
  setTimeout(()=>{c.classList.remove('fade-out'); c.style.display='none';},2200);
}

/* ===================== AUDIO ===================== */
const audioCache=new Map();
function getAudio(item){ const url=item.audio||`audio/${(item.translit||'').toLowerCase()}.mp3`; if(!audioCache.has(url)){const a=new Audio();a.preload='auto';a.src=url;audioCache.set(url,a);} return audioCache.get(url);}
async function playYourAudio(){ const gi=order[idx], item=words[gi]; try{ const a=getAudio(item); a.currentTime=0; await a.play(); }catch{} }

/* ===================== SPEECH RECOG (fa-IR first) ===================== */
let SR=null;
function levenshtein(a,b){const m=a.length,n=b.length,dp=Array.from({length:m+1},()=>Array(n+1).fill(0));for(let i=0;i<=m;i++)dp[i][0]=i;for(let j=0;j<=n;j++)dp[0][j]=j;for(let i=1;i<=m;i++){for(let j=1;j<=n;j++){const c=a[i-1]===b[j-1]?0:1;dp[i][j]=Math.min(dp[i-1][j]+1,dp[i][j-1]+1,dp[i-1][j-1]+c)}}return dp[m][n]}
function closeEnough(a,b){if(!a||!b)return false;if(a===b)return true;return levenshtein(a,b)<=1}
function hasPersian(s){return /[\u0600-\u06FF]/.test(s||'')}
function normalizeSRTranslit(s){return (s||'').toLowerCase().replace(/[^a-z0-9]+/g,'')}

function initSpeech(){
  const SRClass = window.SpeechRecognition || window.webkitSpeechRecognition;
  const btn = $('sayBtn');
  if(!SRClass){ btn.disabled=true; btn.title='Speech not supported (try Chrome).'; return; }

  SR = new SRClass();
  SR.lang = 'fa-IR';
  SR.interimResults = false;
  SR.maxAlternatives = 4;

  btn.disabled=false;
  btn.title='Say the word in Persian (e.g., Â«Ø®Ø§Ù†Ù‡Â»). Speaking the transliteration also works.';

  SR.onstart = ()=>{ $('speechFeedback').textContent='ğŸ™ï¸ Listeningâ€¦'; $('speechFeedback').className='feedback tiny'; };
  SR.onerror = ()=>{ $('speechFeedback').textContent='Mic error. Try again.'; $('speechFeedback').className='feedback err'; };
  SR.onend = ()=>{ if($('speechFeedback').textContent.includes('Listening')){ $('speechFeedback').textContent='Didnâ€™t catch thatâ€”try again.'; $('speechFeedback').className='feedback warn'; } };

  SR.onresult = (event)=>{
    const gi=order[idx], item=words[gi];
    const targetFa = normalizeFa(item.fa);
    const targetTr = normalizeTranslit(item.translit);

    const heard = [];
    for(let i=0;i<event.results[0].length;i++){
      heard.push(event.results[0][i].transcript);
    }

    let ok=false, picked='';
    for(const h of heard){
      if(hasPersian(h) && closeEnough(normalizeFa(h), targetFa)){ ok=true; picked=h.trim(); break; }
    }
    if(!ok){
      for(const h of heard){
        if(closeEnough(normalizeSRTranslit(h), targetTr)){ ok=true; picked=h.trim(); break; }
      }
    }

    $('speechFeedback').innerHTML = ok
      ? `Heard: "<b>${picked}</b>" âœ“`
      : `Heard: "<b>${(heard[0]||'(nothing)').trim()}</b>" âœ— â€” target is "<b>${item.fa}</b>" (${item.translit})`;
    $('speechFeedback').className = 'feedback ' + (ok?'ok':'warn');
    handleAnswer(ok, gi, 'speech', picked);
  };

  $('sayBtn').addEventListener('click', ()=>{
    if(!SR) return;
    try{ SR.stop(); SR.start(); }catch(_){}
  });
}

/* ===================== ANSWERING (SRS + score + map + theme) ===================== */
function handleAnswer(correct, gi, source='typing'){
  const r=ensureSRS(gi); r.seen++;
  if(correct){
    r.correct++; r.stage=Math.min(r.stage+1, SRS_INTERVALS_HOURS.length-1);
    scheduleAfter(gi,SRS_INTERVALS_HOURS[r.stage]||24);
    state.score+=10; state.streak+=1; addCovered(gi);
    if(source!=='speech'){ $('typeFeedback').textContent='Great! +10 points'; $('typeFeedback').className='feedback ok'; }
    celebrateSimple();
    if(state.streak===7) celebrateStreak7();
    checkDailyGoalAndMap();
    populateThemeDropdown();
  }else{
    r.wrong++; r.stage=Math.max(0,r.stage-1); scheduleAfter(gi,2);
    state.streak=0; if(source!=='speech'){ $('typeFeedback').textContent='Not quite.'; $('typeFeedback').className='feedback warn'; }
  }
  persist();
  setTimeout(next, 450);
}
function checkDailyGoalAndMap(){
  const today=todayISO();
  let days = state.mapDays||[];
  let todayRec = days.find(d=>d.date===today);
  if(!todayRec){ todayRec={date:today, correct:0, goalMet:false}; days=[...days,todayRec]; }
  todayRec.correct++;
  if(!todayRec.goalMet && todayRec.correct>=DAILY_WORDS){
    todayRec.goalMet=true;
    state.mapUnlocked = (state.mapUnlocked||0)+1;
    confetti({origin:{y:1,x:Math.random()},particleCount:60,spread:70,startVelocity:45,scalar:1.1});
  }
  state.mapDays = days;
  persist();
}

/* ===================== MAP / BADGES RENDER ===================== */
function reflectBadges(){
  const a=state.achievements;
  const list = `
    <div class="chip">${a.first10?'ğŸ…':'â¬œ'} First 10 mastered</div>
    <div class="chip">${a.perfectMini?'ğŸ…':'â¬œ'} Perfect Mini Quiz</div>
    <div class="chip">${a.streak7?'ğŸ…':'â¬œ'} 7-day streak</div>
    <div class="chip">${a.mastered50?'ğŸ…':'â¬œ'} 50 mastered</div>
  `;
  $('achList').innerHTML = list;
}

/* ===================== CAT BAZAAR (roaming + shop) ===================== */
let catRAF = null;
let catSprites = [];

function stopCats(){
  if(catRAF) cancelAnimationFrame(catRAF);
  catRAF = null;
  catSprites = [];
  const yard=$('bazaarYard');
  if(yard){ yard.querySelectorAll('.cat').forEach(n=>n.remove()); }
}
function updateFishHUD(){ $('fishHUD').textContent = `ğŸŸ ${state.cats?.fish||0}`; }

function spawnCats(n){
  const yard = $('bazaarYard');
  const rect = yard.getBoundingClientRect();
  for(let i=0;i<n;i++){
    const el=document.createElement('div'); el.className='cat'; el.textContent = (i%3===0?'ğŸˆâ€â¬›':(i%3===1?'ğŸˆ':'ğŸ±'));
    const tag=document.createElement('div'); tag.className='cat-tag'; tag.textContent = state.cats.names?.[i] || '';
    el.appendChild(tag);

    // random start
    const x = Math.random()*(rect.width-40)+20;
    const y = Math.random()*(rect.height-50)+20;
    el.style.left = x+'px'; el.style.top = y+'px';

    const vel = {vx:(Math.random()<.5?-1:1)*(1+Math.random()*1.2), vy:(Math.random()<.5?-1:1)*(0.6+Math.random()*1.2)};
    const sprite = {el,tag,x,y,vx:vel.vx,vy:vel.vy,w:36,h:36,idx:i};

    el.addEventListener('click', ()=>{
      // Feed if fish available
      if((state.cats.fish||0)>0){
        state.cats.fish--; persist();
        const heart=document.createElement('div'); heart.className='heart'; heart.textContent='â¤ï¸';
        heart.style.left='50%'; heart.style.top='-6px'; heart.style.opacity='0';
        el.appendChild(heart);
        requestAnimationFrame(()=>{
          heart.style.transition='transform .8s ease, opacity .8s ease';
          heart.style.opacity='1';
          heart.style.transform='translate(-50%,-32px)';
          setTimeout(()=>heart.remove(),850);
        });
      }else{
        // pulse HUD to hint â€œRedeemâ€
        const hud=$('fishHUD'); hud.style.transform='scale(1.1)'; hud.style.transition='transform .15s';
        setTimeout(()=>hud.style.transform='scale(1)',160);
      }
    });

    yard.appendChild(el);
    catSprites.push(sprite);
  }
}

function animateCats(){
  const yard = $('bazaarYard');
  const rect = yard.getBoundingClientRect();
  catSprites.forEach(s=>{
    s.x += s.vx; s.y += s.vy;
    if(s.x<10 || s.x>rect.width-32){ s.vx*=-1; s.x = Math.max(10, Math.min(rect.width-32, s.x)); }
    if(s.y<20 || s.y>rect.height-42){ s.vy*=-1; s.y = Math.max(20, Math.min(rect.height-42, s.y)); }
    s.el.style.left = s.x+'px'; s.el.style.top = s.y+'px';
  });
  catRAF = requestAnimationFrame(animateCats);
}

function renderBazaar(){
  const n = state.mapUnlocked||0;
  const grid = $('bazaarGrid');
  const yard = $('bazaarYard');

  if(n<=0){
    stopCats();
    grid.style.display='grid';
    yard.style.display='none';
    grid.innerHTML='';
    for(let i=0;i<12;i++){
      const t=document.createElement('div'); t.className='tile'+(i<0?' unlocked':''); t.textContent='?';
      grid.appendChild(t);
    }
    return;
  }

  // show roaming cats only
  grid.style.display='none';
  yard.style.display='block';
  updateFishHUD();
  stopCats();
  spawnCats(n);
  animateCats();
}

/* ============== SHOP (redeem using Score) ================= */
function openShop(){
  // Fill balances
  $('scoreBalance').textContent = state.score;
  $('fishBalance').textContent = state.cats.fish||0;

  // Populate cat selector
  const sel=$('nameCatSelect'); sel.innerHTML='';
  if((state.mapUnlocked||0)===0){
    const o=document.createElement('option'); o.value='-1'; o.textContent='No cats yet'; sel.appendChild(o);
    sel.disabled=true;
  }else{
    sel.disabled=false;
    for(let i=0;i<state.mapUnlocked;i++){
      const o=document.createElement('option');
      const nm = state.cats.names?.[i] ? ` (${state.cats.names[i]})` : '';
      o.value=String(i); o.textContent=`Cat #${i+1}${nm}`;
      sel.appendChild(o);
    }
  }
  $('nameCatInput').value='';
  $('nameCatFeedback').textContent='';
  $('shopModal').style.display='grid';
}

function trySpend(cost){
  if((state.score||0) < cost){
    alert(`Not enough points. Need ${cost}, you have ${state.score}.`);
    return false;
  }
  state.score -= cost;
  persist();
  return true;
}

/* ===================== SENTENCE PRACTICE ===================== */
let sentenceIdx = 0;
function renderSentence(){
  if(!SENTENCES.length){
    $('sentFa').textContent = 'â€”';
    $('sentTrans').textContent = '';
    $('sentEn').textContent = 'No sentences available yet.';
    $('sentProgress').textContent = '';
    return;
  }
  if(sentenceIdx < 0) sentenceIdx = SENTENCES.length - 1;
  if(sentenceIdx >= SENTENCES.length) sentenceIdx = 0;

  const s = SENTENCES[sentenceIdx];
  $('sentFa').textContent = s.fa;
  $('sentTrans').textContent = s.translit;
  $('sentEn').textContent = s.en;
  $('sentProgress').textContent = `${sentenceIdx+1} / ${SENTENCES.length}`;
}
function openSentences(){
  sentenceIdx = 0;
  renderSentence();
  $('sentencesModal').style.display='grid';
}

/* ===================== MINI QUIZ (Modal) ===================== */
let miniQ={queue:[],current:null,correct:0,total:0}, MINI_ACTIVE=false;
function endMiniQuiz(){
  MINI_ACTIVE=false;
  $('miniQuizModal').style.display='none';
  $('mqInput').value='';
  $('mqFeedback').textContent='';
  $('mqBar').style.width='0%';
}
$('startMiniQuiz').addEventListener('click', ()=>{
  $('settingsModal').style.display='none';
  const pool=[...new Set([...quizPool(), ...masteredIndices(), ...unlockedIndices()])];
  shuffle(pool);
  miniQ={queue:pool.slice(0,MINI_QUIZ_SIZE),current:null,correct:0,total:0};
  MINI_ACTIVE=true;
  $('miniQuizModal').style.display='grid';
  nextMiniQuestion();
});
function nextMiniQuestion(){
  if(!MINI_ACTIVE) return;
  if(!miniQ.queue.length){
    $('mqFeedback').innerHTML=`Mini Quiz complete! Score: <b>${miniQ.correct}</b> / ${miniQ.total}`;
    $('mqBar').style.width='100%';
    setTimeout(()=>{ endMiniQuiz(); showItem(); }, 1200);
    return;
  }
  miniQ.current = miniQ.queue.shift();
  const item=words[miniQ.current];
  $('mqPic').style.display='block'; $('mqPic').src=item.image||''; $('mqPic').alt=item.en||'';
  $('mqInput').value=''; $('mqFeedback').textContent='';
  $('mqBar').style.width = `${(miniQ.total/MINI_QUIZ_SIZE)*100}%`;
  $('mqInput').focus();
}
$('mqCheck').addEventListener('click', ()=>{
  if(!MINI_ACTIVE) return;
  const item=words[miniQ.current]; miniQ.total++;
  const ok = normalizeTranslit($('mqInput').value)===normalizeTranslit(item.translit);
  if(ok){ miniQ.correct++; $('mqFeedback').textContent='Nice!'; $('mqFeedback').className='feedback ok'; celebrateSimple(); }
  else { $('mqFeedback').textContent=`Answer: ${item.translit}`; $('mqFeedback').className='feedback warn'; state.streak=0; persist(); }
  setTimeout(nextMiniQuestion, 350);
});
$('mqInput').addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); $('mqCheck').click(); } });
$('mqQuit').addEventListener('click', ()=> endMiniQuiz());

/* ===================== EVENTS ===================== */
$('listenBtn').addEventListener('click', playYourAudio);
$('typeInput').addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); $('checkBtn').click(); } });
$('checkBtn').addEventListener('click', ()=>{
  const gi=order[idx], item=words[gi];
  const guess=normalizeTranslit($('typeInput').value);
  if(!guess){ $('typeFeedback').textContent='Type your guess first!'; $('typeFeedback').className='feedback warn'; return; }
  $('typeFeedback').textContent=''; if(!isTouch()) $('typeInput').value=''; 
  handleAnswer(guess===normalizeTranslit(item.translit), gi, 'typing');
});
$('skipBtn').addEventListener('click', ()=>{ $('typeInput').value=''; state.streak=0; persist(); next(); });
$('nextBtn').addEventListener('click', ()=>{ $('typeInput').value=''; next(); });
$('learnBtn').addEventListener('click', ()=>{ endMiniQuiz(); mode='learn'; ensureOrder(); showItem(); });
$('quizBtn').addEventListener('click',  ()=>{ endMiniQuiz(); mode='quiz'; ensureOrder(); showItem(); });

$('hintBtn').addEventListener('click', ()=>{
  if(mode!=='learn') return;
  const gi=order[idx], item=words[gi];
  $('trans').textContent=item.translit; $('en').textContent=item.en;
});
$('revealBtn').addEventListener('click', ()=>{
  const gi=order[idx], item=words[gi];
  $('fa').textContent=item.fa; $('trans').textContent=item.translit;
  const s=$('sadFace'); s.style.display='block'; setTimeout(()=>s.classList.add('fade-out'),700); setTimeout(()=>{s.classList.remove('fade-out'); s.style.display='none';},1500);
});

$('openAchievements').addEventListener('click', ()=>{ reflectBadges(); $('achModal').style.display='grid'; });
$('closeAch').addEventListener('click', ()=> $('achModal').style.display='none');

$('openMap').addEventListener('click', ()=>{ renderBazaar(); $('mapModal').style.display='grid'; });
$('closeMap').addEventListener('click', ()=>{ $('mapModal').style.display='none'; stopCats(); });

$('openSettings').addEventListener('click', ()=>{ 
  $('settingsModal').style.display='grid'; 
  $('reviewToggle').textContent=`Review All Mastered: ${state.settings?.reviewAll?'ON':'OFF'}`;
  populateThemeDropdown();
});
$('closeSettings').addEventListener('click', ()=> $('settingsModal').style.display='none');
$('settingsModal').addEventListener('click', e=>{ if(e.target.id==='settingsModal') e.currentTarget.style.display='none'; });

$('reviewToggle').addEventListener('click', ()=>{
  state.settings.reviewAll = !state.settings.reviewAll; persist();
  $('reviewToggle').textContent=`Review All Mastered: ${state.settings.reviewAll?'ON':'OFF'}`;
});

/* Sentence Practice open/close + nav */
$('openSentences').addEventListener('click', ()=>{ $('settingsModal').style.display='none'; openSentences(); });
$('closeSentences').addEventListener('click', ()=> $('sentencesModal').style.display='none');
$('sentPrev').addEventListener('click', ()=>{ sentenceIdx--; renderSentence(); });
$('sentNext').addEventListener('click', ()=>{ sentenceIdx++; renderSentence(); });

/* Shop events */
$('openShop').addEventListener('click', openShop);
$('closeShop').addEventListener('click', ()=> $('shopModal').style.display='none');
$('buyFish1').addEventListener('click', ()=>{
  if(trySpend(20)){ state.cats.fish = (state.cats.fish||0)+1; persist(); $('fishBalance').textContent=state.cats.fish; $('scoreBalance').textContent=state.score; updateFishHUD(); }
});
$('buyFish5').addEventListener('click', ()=>{
  if(trySpend(80)){ state.cats.fish = (state.cats.fish||0)+5; persist(); $('fishBalance').textContent=state.cats.fish; $('scoreBalance').textContent=state.score; updateFishHUD(); }
});
$('nameCatBtn').addEventListener('click', ()=>{
  const idx = parseInt($('nameCatSelect').value,10);
  const nm = $('nameCatInput').value.trim();
  if(isNaN(idx) || idx<0){ $('nameCatFeedback').textContent='Pick a cat first.'; return; }
  if(!nm){ $('nameCatFeedback').textContent='Type a name.'; return; }
  if(!trySpend(50)) return;
  if(!state.cats.names) state.cats.names={};
  state.cats.names[idx] = nm;
  persist();
  $('nameCatFeedback').textContent = `Saved! Cat #${idx+1} is now â€œ${nm}â€.`;
  $('scoreBalance').textContent=state.score;
  // refresh tags in yard
  catSprites.forEach(s=>{ if(s.idx===idx) s.tag.textContent = nm; });
});

/* Midnight countdown */
function msUntilNextMidnight(){ const n=new Date(), t=new Date(n); t.setHours(24,0,0,0); return t-n; }
function fmt(ms){ const s=Math.floor(ms/1000); const h=Math.floor(s/3600), m=Math.floor((s%3600)/60), sec=s%60; return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}`; }
function showMidnight(){ alert(`New words unlock at local midnight.\nTime remaining: ${fmt(msUntilNextMidnight())}`); }
$('midnightBtn').addEventListener('click', showMidnight);
$('midnightBtn0').addEventListener('click', showMidnight);

/* ===================== PROFILE FLOW ===================== */
function useProfile(name){
  ACTIVE_PROFILE = String(name||'').trim() || 'Guest';
  loadState();
  $('profileBadge').textContent = `Profile: ${ACTIVE_PROFILE}`;
  $('profileOverlay').style.display='none';
  $('startOverlay').style.display='grid';
  if (ACTIVE_PROFILE === "Nicole") initSharedNicoleSync();
}
$('quickNicole').addEventListener('click', ()=> useProfile('Nicole'));
$('quickSia').addEventListener('click', ()=>{
  const pin = prompt('Enter developer PIN:');
  if(pin === '3232'){ useProfile('Sia'); }
  else{ alert('Incorrect PIN.'); }
});

/* Hidden dev reveal */
(function(){
  const overlay = $('profileOverlay');
  const devBtn = $('quickSia');
  let seq = '', timer = null, revealed = false;
  window.addEventListener('keydown', (e)=>{
    if(!overlay || overlay.style.display !== 'grid' || revealed) return;
    if(!/^[0-9]$/.test(e.key)) return;
    seq += e.key; clearTimeout(timer);
    timer = setTimeout(()=>{ seq = ''; }, 1500);
    if(seq.endsWith('3232')){
      revealed = true;
      devBtn.style.display = 'inline-block';
      const note = document.createElement('div');
      note.className = 'tiny';
      note.textContent = 'Developer button unlocked';
      note.style.marginTop = '10px';
      overlay.querySelector('.overlay-card').appendChild(note);
    }
  });
})();

/* Start overlay fallback */
function startAs(m){ mode=m; ensureOrder(); $('startOverlay').style.display='none'; showItem(); }
['startLearn','startQuiz'].forEach(id=>{ const el=$(id); if(el) el.setAttribute('type','button'); });
$('startOverlay').addEventListener('click',(e)=>{ if(e.target.id==='startLearn') startAs('learn'); if(e.target.id==='startQuiz') startAs('quiz'); });

/* Close modals on backdrop click */
document.addEventListener('click', (e)=>{
  if(e.target.id==='settingsModal') e.target.style.display='none';
  if(e.target.id==='sentencesModal') e.target.style.display='none';
  if(e.target.id==='achModal') e.target.style.display='none';
  if(e.target.id==='mapModal'){ e.target.style.display='none'; stopCats(); }
  if(e.target.id==='miniQuizModal'){ endMiniQuiz(); }
  if(e.target.id==='shopModal') e.target.style.display='none';
});

/* Init */
initSpeech();
</script>
</body>
</html>
